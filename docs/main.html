---

title: main


keywords: fastai
sidebar: home_sidebar

summary: "This is how it is originally done. Clean it up with future modules."
description: "This is how it is originally done. Clean it up with future modules."
nb_path: "nbs/00_main.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs/00_main.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># torch==1.4.0+cu100 torchvision==0.5.0+cu100 -f https://download.pytorch.org/whl/torch_stable.html</span>
<span class="c1"># opencv-python==4.2.0.32</span>
<span class="c1"># vispy==0.6.4</span>
<span class="c1"># moviepy==1.0.2</span>
<span class="c1"># transforms3d==0.3.1</span>
<span class="c1"># networkx==2.3</span>
<span class="c1"># sudo apt install sed</span>

<span class="c1"># pip install torch&gt;=1.4.0 torchvision&gt;=0.5.0 opencv-python==4.2.0.32 vispy==0.6.4 moviepy==1.0.2 transforms3d==0.3.1 networkx==2.3</span>
<span class="c1">## Others</span>
<span class="c1"># pip install scikit-image </span>


<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">yaml</span>

<span class="kn">import</span> <span class="nn">cv2</span>
<span class="kn">import</span> <span class="nn">imageio</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">scipy.misc</span> <span class="k">as</span> <span class="nn">misc</span>
<span class="kn">from</span> <span class="nn">skimage.transform</span> <span class="kn">import</span> <span class="n">resize</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">vispy</span>

<span class="kn">from</span> <span class="nn">boostmonodepth_utils</span> <span class="kn">import</span> <span class="n">run_boostmonodepth</span>
<span class="kn">from</span> <span class="nn">bilateral_filtering</span> <span class="kn">import</span> <span class="n">sparse_bilateral_filtering</span>
<span class="kn">from</span> <span class="nn">MiDaS.run</span> <span class="kn">import</span> <span class="n">run_depth</span>
<span class="kn">from</span> <span class="nn">MiDaS.monodepth_net</span> <span class="kn">import</span> <span class="n">MonoDepthNet</span>
<span class="kn">import</span> <span class="nn">MiDaS.MiDaS_utils</span> <span class="k">as</span> <span class="nn">MiDaS_utils</span>
<span class="kn">from</span> <span class="nn">mesh</span> <span class="kn">import</span> <span class="n">write_ply</span><span class="p">,</span> <span class="n">read_ply</span><span class="p">,</span> <span class="n">output_3d_photo</span>
<span class="kn">from</span> <span class="nn">networks</span> <span class="kn">import</span> <span class="n">Inpaint_Color_Net</span><span class="p">,</span> <span class="n">Inpaint_Depth_Net</span><span class="p">,</span> <span class="n">Inpaint_Edge_Net</span>
<span class="kn">from</span> <span class="nn">utils</span> <span class="kn">import</span> <span class="n">get_MiDaS_samples</span><span class="p">,</span> <span class="n">read_MiDaS_depth</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_text output_error">
<pre>
<span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">ModuleNotFoundError</span>                       Traceback (most recent call last)
<span class="ansi-green-fg">&lt;ipython-input-3-2c1cb45c6741&gt;</span> in <span class="ansi-cyan-fg">&lt;module&gt;</span>
<span class="ansi-green-intense-fg ansi-bold">     31</span> <span class="ansi-green-fg">import</span> vispy
<span class="ansi-green-intense-fg ansi-bold">     32</span> 
<span class="ansi-green-fg">---&gt; 33</span><span class="ansi-red-fg"> </span><span class="ansi-green-fg">from</span> boostmonodepth_utils <span class="ansi-green-fg">import</span> run_boostmonodepth
<span class="ansi-green-intense-fg ansi-bold">     34</span> <span class="ansi-green-fg">from</span> bilateral_filtering <span class="ansi-green-fg">import</span> sparse_bilateral_filtering
<span class="ansi-green-intense-fg ansi-bold">     35</span> <span class="ansi-green-fg">from</span> MiDaS<span class="ansi-blue-fg">.</span>run <span class="ansi-green-fg">import</span> run_depth

<span class="ansi-red-fg">ModuleNotFoundError</span>: No module named &#39;boostmonodepth_utils&#39;</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Original Huggingface Space Code from https://huggingface.co/spaces/Epoching/3D_Photo_Inpainting/tree/main</span>

<span class="c1"># main.py</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="kn">import</span> <span class="nn">vispy</span>
<span class="kn">import</span> <span class="nn">scipy.misc</span> <span class="k">as</span> <span class="nn">misc</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">import</span> <span class="nn">yaml</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">mesh</span> <span class="kn">import</span> <span class="n">write_ply</span><span class="p">,</span> <span class="n">read_ply</span><span class="p">,</span> <span class="n">output_3d_photo</span>
<span class="kn">from</span> <span class="nn">utils</span> <span class="kn">import</span> <span class="n">get_MiDaS_samples</span><span class="p">,</span> <span class="n">read_MiDaS_depth</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">cv2</span>
<span class="kn">from</span> <span class="nn">skimage.transform</span> <span class="kn">import</span> <span class="n">resize</span>
<span class="kn">import</span> <span class="nn">imageio</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">from</span> <span class="nn">networks</span> <span class="kn">import</span> <span class="n">Inpaint_Color_Net</span><span class="p">,</span> <span class="n">Inpaint_Depth_Net</span><span class="p">,</span> <span class="n">Inpaint_Edge_Net</span>
<span class="kn">from</span> <span class="nn">MiDaS.run</span> <span class="kn">import</span> <span class="n">run_depth</span>
<span class="kn">from</span> <span class="nn">boostmonodepth_utils</span> <span class="kn">import</span> <span class="n">run_boostmonodepth</span>
<span class="kn">from</span> <span class="nn">MiDaS.monodepth_net</span> <span class="kn">import</span> <span class="n">MonoDepthNet</span>
<span class="kn">import</span> <span class="nn">MiDaS.MiDaS_utils</span> <span class="k">as</span> <span class="nn">MiDaS_utils</span>
<span class="kn">from</span> <span class="nn">bilateral_filtering</span> <span class="kn">import</span> <span class="n">sparse_bilateral_filtering</span>

<span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">()</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--config&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;argument.yml&#39;</span><span class="p">,</span><span class="n">help</span><span class="o">=</span><span class="s1">&#39;Configure of post processing&#39;</span><span class="p">)</span>
<span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
<span class="n">config</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">))</span>
<span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;offscreen_rendering&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
    <span class="n">vispy</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="n">app</span><span class="o">=</span><span class="s1">&#39;egl&#39;</span><span class="p">)</span>
<span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;mesh_folder&#39;</span><span class="p">],</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;video_folder&#39;</span><span class="p">],</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;depth_folder&#39;</span><span class="p">],</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">sample_list</span> <span class="o">=</span> <span class="n">get_MiDaS_samples</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;src_folder&#39;</span><span class="p">],</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;depth_folder&#39;</span><span class="p">],</span> <span class="n">config</span><span class="p">,</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;specific&#39;</span><span class="p">])</span>
<span class="n">normal_canvas</span><span class="p">,</span> <span class="n">all_canvas</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;gpu_ids&quot;</span><span class="p">],</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;gpu_ids&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">):</span>
    <span class="n">device</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;gpu_ids&quot;</span><span class="p">]</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">device</span> <span class="o">=</span> <span class="s2">&quot;cpu&quot;</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;running on device </span><span class="si">{</span><span class="n">device</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sample_list</span><span class="p">))):</span>
    <span class="n">depth</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">sample</span> <span class="o">=</span> <span class="n">sample_list</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Current Source ==&gt; &quot;</span><span class="p">,</span> <span class="n">sample</span><span class="p">[</span><span class="s1">&#39;src_pair_name&#39;</span><span class="p">])</span>
    <span class="n">mesh_fi</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;mesh_folder&#39;</span><span class="p">],</span> <span class="n">sample</span><span class="p">[</span><span class="s1">&#39;src_pair_name&#39;</span><span class="p">]</span> <span class="o">+</span><span class="s1">&#39;.ply&#39;</span><span class="p">)</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">imageio</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">sample</span><span class="p">[</span><span class="s1">&#39;ref_img_fi&#39;</span><span class="p">])</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Running depth extraction at </span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;use_boostmonodepth&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">run_boostmonodepth</span><span class="p">(</span><span class="n">sample</span><span class="p">[</span><span class="s1">&#39;ref_img_fi&#39;</span><span class="p">],</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;src_folder&#39;</span><span class="p">],</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;depth_folder&#39;</span><span class="p">])</span>
    <span class="k">elif</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;require_midas&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">run_depth</span><span class="p">([</span><span class="n">sample</span><span class="p">[</span><span class="s1">&#39;ref_img_fi&#39;</span><span class="p">]],</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;src_folder&#39;</span><span class="p">],</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;depth_folder&#39;</span><span class="p">],</span>
                  <span class="n">config</span><span class="p">[</span><span class="s1">&#39;MiDaS_model_ckpt&#39;</span><span class="p">],</span> <span class="n">MonoDepthNet</span><span class="p">,</span> <span class="n">MiDaS_utils</span><span class="p">,</span> <span class="n">target_w</span><span class="o">=</span><span class="mi">640</span><span class="p">)</span>

    <span class="k">if</span> <span class="s1">&#39;npy&#39;</span> <span class="ow">in</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;depth_format&#39;</span><span class="p">]:</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;output_h&#39;</span><span class="p">],</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;output_w&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">sample</span><span class="p">[</span><span class="s1">&#39;depth_fi&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;output_h&#39;</span><span class="p">],</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;output_w&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">imageio</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">sample</span><span class="p">[</span><span class="s1">&#39;depth_fi&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">frac</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;longer_side_len&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;output_h&#39;</span><span class="p">],</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;output_w&#39;</span><span class="p">])</span>
    <span class="n">config</span><span class="p">[</span><span class="s1">&#39;output_h&#39;</span><span class="p">],</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;output_w&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;output_h&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">frac</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;output_w&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">frac</span><span class="p">)</span>
    <span class="n">config</span><span class="p">[</span><span class="s1">&#39;original_h&#39;</span><span class="p">],</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;original_w&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;output_h&#39;</span><span class="p">],</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;output_w&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">image</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">image</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">image</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">image</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">]))</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">image</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">image</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">2</span><span class="p">]))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;gray_image&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;gray_image&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;output_w&#39;</span><span class="p">],</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;output_h&#39;</span><span class="p">]),</span> <span class="n">interpolation</span><span class="o">=</span><span class="n">cv2</span><span class="o">.</span><span class="n">INTER_AREA</span><span class="p">)</span>
    <span class="n">depth</span> <span class="o">=</span> <span class="n">read_MiDaS_depth</span><span class="p">(</span><span class="n">sample</span><span class="p">[</span><span class="s1">&#39;depth_fi&#39;</span><span class="p">],</span> <span class="mf">3.0</span><span class="p">,</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;output_h&#39;</span><span class="p">],</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;output_w&#39;</span><span class="p">])</span>
    <span class="n">mean_loc_depth</span> <span class="o">=</span> <span class="n">depth</span><span class="p">[</span><span class="n">depth</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span> <span class="n">depth</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">//</span><span class="mi">2</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;load_ply&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">mesh_fi</span><span class="p">)):</span>
        <span class="n">vis_photos</span><span class="p">,</span> <span class="n">vis_depths</span> <span class="o">=</span> <span class="n">sparse_bilateral_filtering</span><span class="p">(</span><span class="n">depth</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">image</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">config</span><span class="p">,</span> <span class="n">num_iter</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;sparse_iter&#39;</span><span class="p">],</span> <span class="n">spdb</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">depth</span> <span class="o">=</span> <span class="n">vis_depths</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">model</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">empty_cache</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Start Running 3D_Photo ...&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loading edge model at </span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">depth_edge_model</span> <span class="o">=</span> <span class="n">Inpaint_Edge_Net</span><span class="p">(</span><span class="n">init_weights</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">depth_edge_weight</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;depth_edge_model_ckpt&#39;</span><span class="p">],</span>
                                       <span class="n">map_location</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="n">device</span><span class="p">))</span>
        <span class="n">depth_edge_model</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">depth_edge_weight</span><span class="p">)</span>
        <span class="n">depth_edge_model</span> <span class="o">=</span> <span class="n">depth_edge_model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
        <span class="n">depth_edge_model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loading depth model at </span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">depth_feat_model</span> <span class="o">=</span> <span class="n">Inpaint_Depth_Net</span><span class="p">()</span>
        <span class="n">depth_feat_weight</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;depth_feat_model_ckpt&#39;</span><span class="p">],</span>
                                       <span class="n">map_location</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="n">device</span><span class="p">))</span>
        <span class="n">depth_feat_model</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">depth_feat_weight</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">depth_feat_model</span> <span class="o">=</span> <span class="n">depth_feat_model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
        <span class="n">depth_feat_model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
        <span class="n">depth_feat_model</span> <span class="o">=</span> <span class="n">depth_feat_model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loading rgb model at </span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">rgb_model</span> <span class="o">=</span> <span class="n">Inpaint_Color_Net</span><span class="p">()</span>
        <span class="n">rgb_feat_weight</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;rgb_feat_model_ckpt&#39;</span><span class="p">],</span>
                                     <span class="n">map_location</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="n">device</span><span class="p">))</span>
        <span class="n">rgb_model</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">rgb_feat_weight</span><span class="p">)</span>
        <span class="n">rgb_model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
        <span class="n">rgb_model</span> <span class="o">=</span> <span class="n">rgb_model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
        <span class="n">graph</span> <span class="o">=</span> <span class="kc">None</span>


        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Writing depth ply (and basically doing everything) at </span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">rt_info</span> <span class="o">=</span> <span class="n">write_ply</span><span class="p">(</span><span class="n">image</span><span class="p">,</span>
                              <span class="n">depth</span><span class="p">,</span>
                              <span class="n">sample</span><span class="p">[</span><span class="s1">&#39;int_mtx&#39;</span><span class="p">],</span>
                              <span class="n">mesh_fi</span><span class="p">,</span>
                              <span class="n">config</span><span class="p">,</span>
                              <span class="n">rgb_model</span><span class="p">,</span>
                              <span class="n">depth_edge_model</span><span class="p">,</span>
                              <span class="n">depth_edge_model</span><span class="p">,</span>
                              <span class="n">depth_feat_model</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">rt_info</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">rgb_model</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">color_feat_model</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">depth_edge_model</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">depth_feat_model</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">empty_cache</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;save_ply&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">or</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;load_ply&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">verts</span><span class="p">,</span> <span class="n">colors</span><span class="p">,</span> <span class="n">faces</span><span class="p">,</span> <span class="n">Height</span><span class="p">,</span> <span class="n">Width</span><span class="p">,</span> <span class="n">hFov</span><span class="p">,</span> <span class="n">vFov</span> <span class="o">=</span> <span class="n">read_ply</span><span class="p">(</span><span class="n">mesh_fi</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">verts</span><span class="p">,</span> <span class="n">colors</span><span class="p">,</span> <span class="n">faces</span><span class="p">,</span> <span class="n">Height</span><span class="p">,</span> <span class="n">Width</span><span class="p">,</span> <span class="n">hFov</span><span class="p">,</span> <span class="n">vFov</span> <span class="o">=</span> <span class="n">rt_info</span>


    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Making video at </span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">videos_poses</span><span class="p">,</span> <span class="n">video_basename</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">sample</span><span class="p">[</span><span class="s1">&#39;tgts_poses&#39;</span><span class="p">]),</span> <span class="n">sample</span><span class="p">[</span><span class="s1">&#39;tgt_name&#39;</span><span class="p">]</span>
    <span class="n">top</span> <span class="o">=</span> <span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;original_h&#39;</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">sample</span><span class="p">[</span><span class="s1">&#39;int_mtx&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;output_h&#39;</span><span class="p">])</span>
    <span class="n">left</span> <span class="o">=</span> <span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;original_w&#39;</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">sample</span><span class="p">[</span><span class="s1">&#39;int_mtx&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;output_w&#39;</span><span class="p">])</span>
    <span class="n">down</span><span class="p">,</span> <span class="n">right</span> <span class="o">=</span> <span class="n">top</span> <span class="o">+</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;output_h&#39;</span><span class="p">],</span> <span class="n">left</span> <span class="o">+</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;output_w&#39;</span><span class="p">]</span>
    <span class="n">border</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">xx</span><span class="p">)</span> <span class="k">for</span> <span class="n">xx</span> <span class="ow">in</span> <span class="p">[</span><span class="n">top</span><span class="p">,</span> <span class="n">down</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">]]</span>
    <span class="n">normal_canvas</span><span class="p">,</span> <span class="n">all_canvas</span> <span class="o">=</span> <span class="n">output_3d_photo</span><span class="p">(</span><span class="n">verts</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">colors</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">faces</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">Height</span><span class="p">),</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">Width</span><span class="p">),</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">hFov</span><span class="p">),</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">vFov</span><span class="p">),</span>
                        <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">sample</span><span class="p">[</span><span class="s1">&#39;tgt_pose&#39;</span><span class="p">]),</span> <span class="n">sample</span><span class="p">[</span><span class="s1">&#39;video_postfix&#39;</span><span class="p">],</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">sample</span><span class="p">[</span><span class="s1">&#39;ref_pose&#39;</span><span class="p">]),</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;video_folder&#39;</span><span class="p">]),</span>
                        <span class="n">image</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">sample</span><span class="p">[</span><span class="s1">&#39;int_mtx&#39;</span><span class="p">]),</span> <span class="n">config</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span>
                        <span class="n">videos_poses</span><span class="p">,</span> <span class="n">video_basename</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;original_h&#39;</span><span class="p">),</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;original_w&#39;</span><span class="p">),</span> <span class="n">border</span><span class="o">=</span><span class="n">border</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="n">depth</span><span class="p">,</span> <span class="n">normal_canvas</span><span class="o">=</span><span class="n">normal_canvas</span><span class="p">,</span> <span class="n">all_canvas</span><span class="o">=</span><span class="n">all_canvas</span><span class="p">,</span>
                        <span class="n">mean_loc_depth</span><span class="o">=</span><span class="n">mean_loc_depth</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_text output_error">
<pre>
<span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">ModuleNotFoundError</span>                       Traceback (most recent call last)
<span class="ansi-green-fg">&lt;ipython-input-1-4bac69728758&gt;</span> in <span class="ansi-cyan-fg">&lt;module&gt;</span>
<span class="ansi-green-intense-fg ansi-bold">      5</span> <span class="ansi-green-fg">import</span> os
<span class="ansi-green-intense-fg ansi-bold">      6</span> <span class="ansi-green-fg">from</span> functools <span class="ansi-green-fg">import</span> partial
<span class="ansi-green-fg">----&gt; 7</span><span class="ansi-red-fg"> </span><span class="ansi-green-fg">import</span> vispy
<span class="ansi-green-intense-fg ansi-bold">      8</span> <span class="ansi-green-fg">import</span> scipy<span class="ansi-blue-fg">.</span>misc <span class="ansi-green-fg">as</span> misc
<span class="ansi-green-intense-fg ansi-bold">      9</span> <span class="ansi-green-fg">from</span> tqdm <span class="ansi-green-fg">import</span> tqdm

<span class="ansi-red-fg">ModuleNotFoundError</span>: No module named &#39;vispy&#39;</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="say_hello" class="doc_header"><code>say_hello</code><a href="https://github.com/bitcloud2/pomerantz/tree/main/pomerantz/main.py#L6" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>say_hello</code>(<strong><code>to</code></strong>)</p>
</blockquote>
<p>Say hello to somebody</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Documentation-Example">Documentation Example<a class="anchor-link" href="#Documentation-Example"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">say_hello</span><span class="p">(</span><span class="s2">&quot;Jeffrey&quot;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>&#39;Hello Jeffrey!&#39;</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Tests-Example">Tests Example<a class="anchor-link" href="#Tests-Example"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">assert</span> <span class="n">say_hello</span><span class="p">(</span><span class="s2">&quot;Jeffrey&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;Hello Jeffrey!&quot;</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Documenting-ec2/docker-startup">Documenting ec2/docker startup<a class="anchor-link" href="#Documenting-ec2/docker-startup"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>pip install nbdev</p>
<p>nbdev_install_git_hooks</p>
<p>cd pomerantz</p>
<p>nbdev_build_lib</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="HelloSayer" class="doc_header"><code>class</code> <code>HelloSayer</code><a href="https://github.com/bitcloud2/pomerantz/tree/main/pomerantz/main.py#L11" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>HelloSayer</code>(<strong><code>to</code></strong>)</p>
</blockquote>
<p>Say hello to <code>to</code> using <a href="/pomerantz/boostmonodepth_utils.html#say_hello"><code>say_hello</code></a></p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="HelloSayer.say" class="doc_header"><code>HelloSayer.say</code><a href="https://github.com/bitcloud2/pomerantz/tree/main/pomerantz/main.py#L15" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>HelloSayer.say</code>()</p>
</blockquote>
<p>Do the saying</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">o</span> <span class="o">=</span> <span class="n">HelloSayer</span><span class="p">(</span><span class="s2">&quot;Jeffrey&quot;</span><span class="p">)</span>
<span class="n">o</span><span class="o">.</span><span class="n">say</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>&#39;Hello Jeffrey!&#39;</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">assert</span> <span class="n">o</span><span class="o">.</span><span class="n">say</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;Hello Jeffrey!&quot;</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

</div>
 

