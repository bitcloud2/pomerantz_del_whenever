---

title: bilateral_filtering


keywords: fastai
sidebar: home_sidebar

summary: "This is how it is originally done. Clean it up with future modules."
description: "This is how it is originally done. Clean it up with future modules."
nb_path: "nbs/02_bilateral_filtering.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs/02_bilateral_filtering.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">reduce</span>

<span class="k">def</span> <span class="nf">sparse_bilateral_filtering</span><span class="p">(</span>
    <span class="n">depth</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">HR</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">gsHR</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">edge_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">num_iter</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">num_gs_iter</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">spdb</span><span class="o">=</span><span class="kc">False</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    config:</span>
<span class="sd">    - filter_size</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">time</span>

    <span class="n">save_images</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">save_depths</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">save_discontinuities</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">vis_depth</span> <span class="o">=</span> <span class="n">depth</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">backup_vis_depth</span> <span class="o">=</span> <span class="n">vis_depth</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="n">depth_max</span> <span class="o">=</span> <span class="n">vis_depth</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="n">depth_min</span> <span class="o">=</span> <span class="n">vis_depth</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
    <span class="n">vis_image</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_iter</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;filter_size&quot;</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">window_size</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;filter_size&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">window_size</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;filter_size&quot;</span><span class="p">]</span>
        <span class="n">vis_image</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">save_images</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vis_image</span><span class="p">)</span>
        <span class="n">save_depths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vis_depth</span><span class="p">)</span>
        <span class="n">u_over</span><span class="p">,</span> <span class="n">b_over</span><span class="p">,</span> <span class="n">l_over</span><span class="p">,</span> <span class="n">r_over</span> <span class="o">=</span> <span class="n">vis_depth_discontinuity</span><span class="p">(</span><span class="n">vis_depth</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">)</span>
        <span class="n">vis_image</span><span class="p">[</span><span class="n">u_over</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
        <span class="n">vis_image</span><span class="p">[</span><span class="n">b_over</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
        <span class="n">vis_image</span><span class="p">[</span><span class="n">l_over</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
        <span class="n">vis_image</span><span class="p">[</span><span class="n">r_over</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>

        <span class="n">discontinuity_map</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_over</span> <span class="o">+</span> <span class="n">b_over</span> <span class="o">+</span> <span class="n">l_over</span> <span class="o">+</span> <span class="n">r_over</span><span class="p">)</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
        <span class="n">discontinuity_map</span><span class="p">[</span><span class="n">depth</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">save_discontinuities</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">discontinuity_map</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">discontinuity_map</span><span class="p">[</span><span class="n">mask</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">vis_depth</span> <span class="o">=</span> <span class="n">bilateral_filter</span><span class="p">(</span>
            <span class="n">vis_depth</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">discontinuity_map</span><span class="o">=</span><span class="n">discontinuity_map</span><span class="p">,</span> <span class="n">HR</span><span class="o">=</span><span class="n">HR</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">,</span> <span class="n">window_size</span><span class="o">=</span><span class="n">window_size</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">save_images</span><span class="p">,</span> <span class="n">save_depths</span>


<span class="k">def</span> <span class="nf">vis_depth_discontinuity</span><span class="p">(</span><span class="n">depth</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">vis_diff</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    config:</span>
<span class="sd">    - </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">label</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
        <span class="n">disp</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="n">depth</span>
        <span class="n">u_diff</span> <span class="o">=</span> <span class="p">(</span><span class="n">disp</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">disp</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:])[:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">b_diff</span> <span class="o">=</span> <span class="p">(</span><span class="n">disp</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">disp</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span> <span class="p">:])[</span><span class="mi">1</span><span class="p">:,</span> <span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">l_diff</span> <span class="o">=</span> <span class="p">(</span><span class="n">disp</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="n">disp</span><span class="p">[:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">r_diff</span> <span class="o">=</span> <span class="p">(</span><span class="n">disp</span><span class="p">[:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">disp</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:])[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">:]</span>
        <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">u_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">mask</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span> <span class="p">:]</span> <span class="o">*</span> <span class="n">mask</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:])[:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">b_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">mask</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="n">mask</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span> <span class="p">:])[</span><span class="mi">1</span><span class="p">:,</span> <span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">l_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">mask</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]</span> <span class="o">*</span> <span class="n">mask</span><span class="p">[:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">r_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">mask</span><span class="p">[:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">mask</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:])[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">:]</span>
            <span class="n">u_diff</span> <span class="o">=</span> <span class="n">u_diff</span> <span class="o">*</span> <span class="n">u_mask</span>
            <span class="n">b_diff</span> <span class="o">=</span> <span class="n">b_diff</span> <span class="o">*</span> <span class="n">b_mask</span>
            <span class="n">l_diff</span> <span class="o">=</span> <span class="n">l_diff</span> <span class="o">*</span> <span class="n">l_mask</span>
            <span class="n">r_diff</span> <span class="o">=</span> <span class="n">r_diff</span> <span class="o">*</span> <span class="n">r_mask</span>
        <span class="n">u_over</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">u_diff</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;depth_threshold&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">b_over</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">b_diff</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;depth_threshold&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">l_over</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">l_diff</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;depth_threshold&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">r_over</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">r_diff</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;depth_threshold&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">disp</span> <span class="o">=</span> <span class="n">depth</span>
        <span class="n">u_diff</span> <span class="o">=</span> <span class="p">(</span><span class="n">disp</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span> <span class="p">:]</span> <span class="o">*</span> <span class="n">disp</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:])[:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">b_diff</span> <span class="o">=</span> <span class="p">(</span><span class="n">disp</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="n">disp</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span> <span class="p">:])[</span><span class="mi">1</span><span class="p">:,</span> <span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">l_diff</span> <span class="o">=</span> <span class="p">(</span><span class="n">disp</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]</span> <span class="o">*</span> <span class="n">disp</span><span class="p">[:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">r_diff</span> <span class="o">=</span> <span class="p">(</span><span class="n">disp</span><span class="p">[:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">disp</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:])[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">:]</span>
        <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">u_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">mask</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span> <span class="p">:]</span> <span class="o">*</span> <span class="n">mask</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:])[:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">b_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">mask</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="n">mask</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span> <span class="p">:])[</span><span class="mi">1</span><span class="p">:,</span> <span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">l_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">mask</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]</span> <span class="o">*</span> <span class="n">mask</span><span class="p">[:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">r_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">mask</span><span class="p">[:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">mask</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:])[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">:]</span>
            <span class="n">u_diff</span> <span class="o">=</span> <span class="n">u_diff</span> <span class="o">*</span> <span class="n">u_mask</span>
            <span class="n">b_diff</span> <span class="o">=</span> <span class="n">b_diff</span> <span class="o">*</span> <span class="n">b_mask</span>
            <span class="n">l_diff</span> <span class="o">=</span> <span class="n">l_diff</span> <span class="o">*</span> <span class="n">l_mask</span>
            <span class="n">r_diff</span> <span class="o">=</span> <span class="n">r_diff</span> <span class="o">*</span> <span class="n">r_mask</span>
        <span class="n">u_over</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">u_diff</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">b_over</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">b_diff</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">l_over</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">l_diff</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">r_over</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">r_diff</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">u_over</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">u_over</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;constant&#39;</span><span class="p">)</span>
    <span class="n">b_over</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">b_over</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;constant&#39;</span><span class="p">)</span>
    <span class="n">l_over</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">l_over</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;constant&#39;</span><span class="p">)</span>
    <span class="n">r_over</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">r_over</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;constant&#39;</span><span class="p">)</span>
    <span class="n">u_diff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">u_diff</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;constant&#39;</span><span class="p">)</span>
    <span class="n">b_diff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">b_diff</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;constant&#39;</span><span class="p">)</span>
    <span class="n">l_diff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">l_diff</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;constant&#39;</span><span class="p">)</span>
    <span class="n">r_diff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">r_diff</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;constant&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">vis_diff</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">u_over</span><span class="p">,</span> <span class="n">b_over</span><span class="p">,</span> <span class="n">l_over</span><span class="p">,</span> <span class="n">r_over</span><span class="p">],</span> <span class="p">[</span><span class="n">u_diff</span><span class="p">,</span> <span class="n">b_diff</span><span class="p">,</span> <span class="n">l_diff</span><span class="p">,</span> <span class="n">r_diff</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">u_over</span><span class="p">,</span> <span class="n">b_over</span><span class="p">,</span> <span class="n">l_over</span><span class="p">,</span> <span class="n">r_over</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">bilateral_filter</span><span class="p">(</span><span class="n">depth</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">discontinuity_map</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">HR</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">window_size</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">sort_time</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">replace_time</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">filter_time</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">init_time</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">filtering_time</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">sigma_s</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;sigma_s&#39;</span><span class="p">]</span>
    <span class="n">sigma_r</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;sigma_r&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">window_size</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
        <span class="n">window_size</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;filter_size&#39;</span><span class="p">]</span>
    <span class="n">midpt</span> <span class="o">=</span> <span class="n">window_size</span><span class="o">//</span><span class="mi">2</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="n">midpt</span><span class="p">,</span> <span class="n">midpt</span><span class="o">+</span><span class="mf">1.</span><span class="p">)</span>
    <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">ax</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">discontinuity_map</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">spatial_term</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">xx</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">yy</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">sigma_s</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>

    <span class="c1"># padding</span>
    <span class="n">depth</span> <span class="o">=</span> <span class="n">depth</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">depth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">depth</span><span class="p">,</span> <span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)),</span> <span class="s1">&#39;edge&#39;</span><span class="p">)</span>
    <span class="n">pad_depth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">depth</span><span class="p">,</span> <span class="p">(</span><span class="n">midpt</span><span class="p">,</span><span class="n">midpt</span><span class="p">),</span> <span class="s1">&#39;edge&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">discontinuity_map</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">discontinuity_map</span> <span class="o">=</span> <span class="n">discontinuity_map</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">discontinuity_map</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">discontinuity_map</span><span class="p">,</span> <span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)),</span> <span class="s1">&#39;edge&#39;</span><span class="p">)</span>
        <span class="n">pad_discontinuity_map</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">discontinuity_map</span><span class="p">,</span> <span class="p">(</span><span class="n">midpt</span><span class="p">,</span><span class="n">midpt</span><span class="p">),</span> <span class="s1">&#39;edge&#39;</span><span class="p">)</span>
        <span class="n">pad_discontinuity_hole</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">pad_discontinuity_map</span>
    <span class="c1"># filtering</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">depth</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">pad_depth_patches</span> <span class="o">=</span> <span class="n">rolling_window</span><span class="p">(</span><span class="n">pad_depth</span><span class="p">,</span> <span class="p">[</span><span class="n">window_size</span><span class="p">,</span> <span class="n">window_size</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">discontinuity_map</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">pad_discontinuity_patches</span> <span class="o">=</span> <span class="n">rolling_window</span><span class="p">(</span><span class="n">pad_discontinuity_map</span><span class="p">,</span> <span class="p">[</span><span class="n">window_size</span><span class="p">,</span> <span class="n">window_size</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">pad_discontinuity_hole_patches</span> <span class="o">=</span> <span class="n">rolling_window</span><span class="p">(</span><span class="n">pad_discontinuity_hole</span><span class="p">,</span> <span class="p">[</span><span class="n">window_size</span><span class="p">,</span> <span class="n">window_size</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">pad_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="p">(</span><span class="n">midpt</span><span class="p">,</span><span class="n">midpt</span><span class="p">),</span> <span class="s1">&#39;constant&#39;</span><span class="p">)</span>
        <span class="n">pad_mask_patches</span> <span class="o">=</span> <span class="n">rolling_window</span><span class="p">(</span><span class="n">pad_mask</span><span class="p">,</span> <span class="p">[</span><span class="n">window_size</span><span class="p">,</span> <span class="n">window_size</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
    <span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">product</span>
    <span class="k">if</span> <span class="n">discontinuity_map</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">pH</span><span class="p">,</span> <span class="n">pW</span> <span class="o">=</span> <span class="n">pad_depth_patches</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">pi</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">pH</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">pj</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">pW</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">mask</span><span class="p">[</span><span class="n">pi</span><span class="p">,</span> <span class="n">pj</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="n">discontinuity_map</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">bool</span><span class="p">(</span><span class="n">pad_discontinuity_patches</span><span class="p">[</span><span class="n">pi</span><span class="p">,</span> <span class="n">pj</span><span class="p">]</span><span class="o">.</span><span class="n">any</span><span class="p">())</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="n">discontinuity_patch</span> <span class="o">=</span> <span class="n">pad_discontinuity_patches</span><span class="p">[</span><span class="n">pi</span><span class="p">,</span> <span class="n">pj</span><span class="p">]</span>
                    <span class="n">discontinuity_holes</span> <span class="o">=</span> <span class="n">pad_discontinuity_hole_patches</span><span class="p">[</span><span class="n">pi</span><span class="p">,</span> <span class="n">pj</span><span class="p">]</span>
                <span class="n">depth_patch</span> <span class="o">=</span> <span class="n">pad_depth_patches</span><span class="p">[</span><span class="n">pi</span><span class="p">,</span> <span class="n">pj</span><span class="p">]</span>
                <span class="n">depth_order</span> <span class="o">=</span> <span class="n">depth_patch</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span><span class="o">.</span><span class="n">argsort</span><span class="p">()</span>
                <span class="n">patch_midpt</span> <span class="o">=</span> <span class="n">depth_patch</span><span class="p">[</span><span class="n">window_size</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span> <span class="n">window_size</span><span class="o">//</span><span class="mi">2</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">discontinuity_map</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">coef</span> <span class="o">=</span> <span class="n">discontinuity_holes</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">coef</span> <span class="o">=</span> <span class="n">coef</span> <span class="o">*</span> <span class="n">pad_mask_patches</span><span class="p">[</span><span class="n">pi</span><span class="p">,</span> <span class="n">pj</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">range_term</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">depth_patch</span><span class="o">-</span><span class="n">patch_midpt</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">sigma_r</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
                    <span class="n">coef</span> <span class="o">=</span> <span class="n">spatial_term</span> <span class="o">*</span> <span class="n">range_term</span>
                <span class="k">if</span> <span class="n">coef</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">output</span><span class="p">[</span><span class="n">pi</span><span class="p">,</span> <span class="n">pj</span><span class="p">]</span> <span class="o">=</span> <span class="n">patch_midpt</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="n">discontinuity_map</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">(</span><span class="n">coef</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                    <span class="n">output</span><span class="p">[</span><span class="n">pi</span><span class="p">,</span> <span class="n">pj</span><span class="p">]</span> <span class="o">=</span> <span class="n">patch_midpt</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">coef</span> <span class="o">=</span> <span class="n">coef</span><span class="o">/</span><span class="p">(</span><span class="n">coef</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
                    <span class="n">coef_order</span> <span class="o">=</span> <span class="n">coef</span><span class="o">.</span><span class="n">ravel</span><span class="p">()[</span><span class="n">depth_order</span><span class="p">]</span>
                    <span class="n">cum_coef</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">coef_order</span><span class="p">)</span>
                    <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">digitize</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">cum_coef</span><span class="p">)</span>
                    <span class="n">output</span><span class="p">[</span><span class="n">pi</span><span class="p">,</span> <span class="n">pj</span><span class="p">]</span> <span class="o">=</span> <span class="n">depth_patch</span><span class="o">.</span><span class="n">ravel</span><span class="p">()[</span><span class="n">depth_order</span><span class="p">][</span><span class="n">ind</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">pH</span><span class="p">,</span> <span class="n">pW</span> <span class="o">=</span> <span class="n">pad_depth_patches</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">pi</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">pH</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">pj</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">pW</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">discontinuity_map</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">pad_discontinuity_patches</span><span class="p">[</span><span class="n">pi</span><span class="p">,</span> <span class="n">pj</span><span class="p">][</span><span class="n">window_size</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span> <span class="n">window_size</span><span class="o">//</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="n">discontinuity_patch</span> <span class="o">=</span> <span class="n">pad_discontinuity_patches</span><span class="p">[</span><span class="n">pi</span><span class="p">,</span> <span class="n">pj</span><span class="p">]</span>
                    <span class="n">discontinuity_holes</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">discontinuity_patch</span><span class="p">)</span>
                <span class="n">depth_patch</span> <span class="o">=</span> <span class="n">pad_depth_patches</span><span class="p">[</span><span class="n">pi</span><span class="p">,</span> <span class="n">pj</span><span class="p">]</span>
                <span class="n">depth_order</span> <span class="o">=</span> <span class="n">depth_patch</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span><span class="o">.</span><span class="n">argsort</span><span class="p">()</span>
                <span class="n">patch_midpt</span> <span class="o">=</span> <span class="n">depth_patch</span><span class="p">[</span><span class="n">window_size</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span> <span class="n">window_size</span><span class="o">//</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">range_term</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">depth_patch</span><span class="o">-</span><span class="n">patch_midpt</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">sigma_r</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">discontinuity_map</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">coef</span> <span class="o">=</span> <span class="n">spatial_term</span> <span class="o">*</span> <span class="n">range_term</span> <span class="o">*</span> <span class="n">discontinuity_holes</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">coef</span> <span class="o">=</span> <span class="n">spatial_term</span> <span class="o">*</span> <span class="n">range_term</span>
                <span class="k">if</span> <span class="n">coef</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">output</span><span class="p">[</span><span class="n">pi</span><span class="p">,</span> <span class="n">pj</span><span class="p">]</span> <span class="o">=</span> <span class="n">patch_midpt</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="n">discontinuity_map</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">(</span><span class="n">coef</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                    <span class="n">output</span><span class="p">[</span><span class="n">pi</span><span class="p">,</span> <span class="n">pj</span><span class="p">]</span> <span class="o">=</span> <span class="n">patch_midpt</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">coef</span> <span class="o">=</span> <span class="n">coef</span><span class="o">/</span><span class="p">(</span><span class="n">coef</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
                    <span class="n">coef_order</span> <span class="o">=</span> <span class="n">coef</span><span class="o">.</span><span class="n">ravel</span><span class="p">()[</span><span class="n">depth_order</span><span class="p">]</span>
                    <span class="n">cum_coef</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">coef_order</span><span class="p">)</span>
                    <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">digitize</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">cum_coef</span><span class="p">)</span>
                    <span class="n">output</span><span class="p">[</span><span class="n">pi</span><span class="p">,</span> <span class="n">pj</span><span class="p">]</span> <span class="o">=</span> <span class="n">depth_patch</span><span class="o">.</span><span class="n">ravel</span><span class="p">()[</span><span class="n">depth_order</span><span class="p">][</span><span class="n">ind</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">output</span>

<span class="k">def</span> <span class="nf">rolling_window</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">window</span><span class="p">,</span> <span class="n">strides</span><span class="p">):</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">==</span><span class="nb">len</span><span class="p">(</span><span class="n">window</span><span class="p">)</span><span class="o">==</span><span class="nb">len</span><span class="p">(</span><span class="n">strides</span><span class="p">),</span> <span class="s2">&quot;</span><span class="se">\&#39;</span><span class="s2">a</span><span class="se">\&#39;</span><span class="s2">, </span><span class="se">\&#39;</span><span class="s2">window</span><span class="se">\&#39;</span><span class="s2">, </span><span class="se">\&#39;</span><span class="s2">strides</span><span class="se">\&#39;</span><span class="s2"> dimension mismatch&quot;</span>
    <span class="n">shape_fn</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">i</span><span class="p">,</span><span class="n">w</span><span class="p">,</span><span class="n">s</span><span class="p">:</span> <span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">w</span><span class="p">)</span><span class="o">//</span><span class="n">s</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">shape</span> <span class="o">=</span> <span class="p">[</span><span class="n">shape_fn</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">w</span><span class="p">,</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,(</span><span class="n">w</span><span class="p">,</span><span class="n">s</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">window</span><span class="p">,</span> <span class="n">strides</span><span class="p">))]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">window</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">acc_shape</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="o">&gt;=</span><span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">):</span>
            <span class="k">return</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">reduce</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">:</span><span class="n">x</span><span class="o">*</span><span class="n">y</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">:])</span>
    <span class="n">_strides</span> <span class="o">=</span> <span class="p">[</span><span class="n">acc_shape</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">*</span><span class="n">s</span><span class="o">*</span><span class="n">a</span><span class="o">.</span><span class="n">itemsize</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">strides</span><span class="p">)]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">strides</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">stride_tricks</span><span class="o">.</span><span class="n">as_strided</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="n">shape</span><span class="p">,</span> <span class="n">strides</span><span class="o">=</span><span class="n">_strides</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

</div>
 

