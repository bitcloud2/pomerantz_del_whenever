---

title: mesh


keywords: fastai
sidebar: home_sidebar

summary: "This is how it is originally done. Clean it up with future modules."
description: "This is how it is originally done. Clean it up with future modules."
nb_path: "nbs/03_mesh.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs/03_mesh.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">cynetworkx</span> <span class="k">as</span> <span class="nn">netx</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">networkx</span> <span class="k">as</span> <span class="nn">netx</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="kn">from</span> <span class="nn">vispy</span> <span class="kn">import</span> <span class="n">scene</span><span class="p">,</span> <span class="n">io</span>
<span class="kn">from</span> <span class="nn">vispy.scene</span> <span class="kn">import</span> <span class="n">visuals</span>
<span class="kn">from</span> <span class="nn">vispy.visuals.filters</span> <span class="kn">import</span> <span class="n">Alpha</span>
<span class="kn">import</span> <span class="nn">cv2</span>
<span class="kn">from</span> <span class="nn">moviepy.editor</span> <span class="kn">import</span> <span class="n">ImageSequenceClip</span>
<span class="kn">from</span> <span class="nn">skimage.transform</span> <span class="kn">import</span> <span class="n">resize</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">utils</span> <span class="kn">import</span> <span class="n">path_planning</span><span class="p">,</span> <span class="n">open_small_mask</span><span class="p">,</span> <span class="n">clean_far_edge</span><span class="p">,</span> <span class="n">refine_depth_around_edge</span>
<span class="kn">from</span> <span class="nn">utils</span> <span class="kn">import</span> <span class="n">refine_color_around_edge</span><span class="p">,</span> <span class="n">filter_irrelevant_edge_new</span><span class="p">,</span> <span class="n">require_depth_edge</span><span class="p">,</span> <span class="n">clean_far_edge_new</span>
<span class="kn">from</span> <span class="nn">utils</span> <span class="kn">import</span> <span class="n">create_placeholder</span><span class="p">,</span> <span class="n">refresh_node</span><span class="p">,</span> <span class="n">find_largest_rect</span>
<span class="kn">from</span> <span class="nn">mesh_tools</span> <span class="kn">import</span> <span class="n">get_depth_from_maps</span><span class="p">,</span> <span class="n">get_map_from_ccs</span><span class="p">,</span> <span class="n">get_edge_from_nodes</span><span class="p">,</span> <span class="n">get_depth_from_nodes</span><span class="p">,</span> <span class="n">get_rgb_from_nodes</span><span class="p">,</span> <span class="n">crop_maps_by_size</span><span class="p">,</span> <span class="n">convert2tensor</span><span class="p">,</span> <span class="n">recursive_add_edge</span><span class="p">,</span> <span class="n">update_info</span><span class="p">,</span> <span class="n">filter_edge</span><span class="p">,</span> <span class="n">relabel_node</span><span class="p">,</span> <span class="n">depth_inpainting</span>
<span class="kn">from</span> <span class="nn">mesh_tools</span> <span class="kn">import</span> <span class="n">refresh_bord_depth</span><span class="p">,</span> <span class="n">enlarge_border</span><span class="p">,</span> <span class="n">fill_dummy_bord</span><span class="p">,</span> <span class="n">extrapolate</span><span class="p">,</span> <span class="n">fill_missing_node</span><span class="p">,</span> <span class="n">incomplete_node</span><span class="p">,</span> <span class="n">get_valid_size</span><span class="p">,</span> <span class="n">dilate_valid_size</span><span class="p">,</span> <span class="n">size_operation</span>
<span class="kn">import</span> <span class="nn">transforms3d</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">reduce</span>

<span class="k">def</span> <span class="nf">create_mesh</span><span class="p">(</span><span class="n">depth</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">int_mtx</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
    <span class="n">H</span><span class="p">,</span> <span class="n">W</span><span class="p">,</span> <span class="n">C</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">ext_H</span><span class="p">,</span> <span class="n">ext_W</span> <span class="o">=</span> <span class="n">H</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;extrapolation_thickness&#39;</span><span class="p">],</span> <span class="n">W</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;extrapolation_thickness&#39;</span><span class="p">]</span>
    <span class="n">LDI</span> <span class="o">=</span> <span class="n">netx</span><span class="o">.</span><span class="n">Graph</span><span class="p">(</span><span class="n">H</span><span class="o">=</span><span class="n">ext_H</span><span class="p">,</span> <span class="n">W</span><span class="o">=</span><span class="n">ext_W</span><span class="p">,</span> <span class="n">noext_H</span><span class="o">=</span><span class="n">H</span><span class="p">,</span> <span class="n">noext_W</span><span class="o">=</span><span class="n">W</span><span class="p">,</span> <span class="n">cam_param</span><span class="o">=</span><span class="n">int_mtx</span><span class="p">)</span>
    <span class="n">xy2depth</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">int_mtx_pix</span> <span class="o">=</span> <span class="n">int_mtx</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">W</span><span class="p">],</span> <span class="p">[</span><span class="n">H</span><span class="p">],</span> <span class="p">[</span><span class="mf">1.</span><span class="p">]])</span>
    <span class="n">LDI</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;cam_param_pix&#39;</span><span class="p">],</span> <span class="n">LDI</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;cam_param_pix_inv&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">int_mtx_pix</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">int_mtx_pix</span><span class="p">)</span>
    <span class="n">disp</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">/</span> <span class="p">(</span><span class="o">-</span><span class="n">depth</span><span class="p">)</span>
    <span class="n">LDI</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;hoffset&#39;</span><span class="p">],</span> <span class="n">LDI</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;woffset&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;extrapolation_thickness&#39;</span><span class="p">],</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;extrapolation_thickness&#39;</span><span class="p">]</span>
    <span class="n">LDI</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;bord_up&#39;</span><span class="p">],</span> <span class="n">LDI</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;bord_down&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">LDI</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;hoffset&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">0</span><span class="p">,</span> <span class="n">LDI</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;hoffset&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">H</span>
    <span class="n">LDI</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;bord_left&#39;</span><span class="p">],</span> <span class="n">LDI</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;bord_right&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">LDI</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;woffset&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">0</span><span class="p">,</span> <span class="n">LDI</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;woffset&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">W</span>
    <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">H</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">idy</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">W</span><span class="p">):</span>
            <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">idx</span> <span class="o">+</span> <span class="n">LDI</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;hoffset&#39;</span><span class="p">],</span> <span class="n">idy</span> <span class="o">+</span> <span class="n">LDI</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;woffset&#39;</span><span class="p">]</span>
            <span class="n">LDI</span><span class="o">.</span><span class="n">add_node</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="o">-</span><span class="n">depth</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="n">idy</span><span class="p">]),</span>
                         <span class="n">color</span><span class="o">=</span><span class="n">image</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="n">idy</span><span class="p">],</span>
                         <span class="n">disp</span><span class="o">=</span><span class="n">disp</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="n">idy</span><span class="p">],</span>
                         <span class="n">synthesis</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                         <span class="n">cc_id</span><span class="o">=</span><span class="nb">set</span><span class="p">())</span>
            <span class="n">xy2depth</span><span class="p">[(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)]</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="n">depth</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="n">idy</span><span class="p">]]</span>
    <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">LDI</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span>
        <span class="n">two_nes</span> <span class="o">=</span> <span class="p">[</span><span class="n">ne</span> <span class="k">for</span> <span class="n">ne</span> <span class="ow">in</span> <span class="p">[(</span><span class="n">x</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span> <span class="k">if</span> <span class="n">ne</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">LDI</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;bord_down&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">ne</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">LDI</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;bord_right&#39;</span><span class="p">]]</span>
        <span class="p">[</span><span class="n">LDI</span><span class="o">.</span><span class="n">add_edge</span><span class="p">((</span><span class="n">ne</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ne</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">xy2depth</span><span class="p">[</span><span class="n">ne</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">d</span><span class="p">))</span> <span class="k">for</span> <span class="n">ne</span> <span class="ow">in</span> <span class="n">two_nes</span><span class="p">]</span>
    <span class="n">LDI</span> <span class="o">=</span> <span class="n">calculate_fov</span><span class="p">(</span><span class="n">LDI</span><span class="p">)</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">image</span><span class="p">,</span>
                    <span class="n">pad_width</span><span class="o">=</span><span class="p">((</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;extrapolation_thickness&#39;</span><span class="p">],</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;extrapolation_thickness&#39;</span><span class="p">]),</span>
                               <span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;extrapolation_thickness&#39;</span><span class="p">],</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;extrapolation_thickness&#39;</span><span class="p">]),</span>
                               <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)),</span>
                    <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;constant&#39;</span><span class="p">)</span>
    <span class="n">depth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">depth</span><span class="p">,</span>
                    <span class="n">pad_width</span><span class="o">=</span><span class="p">((</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;extrapolation_thickness&#39;</span><span class="p">],</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;extrapolation_thickness&#39;</span><span class="p">]),</span>
                               <span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;extrapolation_thickness&#39;</span><span class="p">],</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;extrapolation_thickness&#39;</span><span class="p">])),</span>
                    <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;constant&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">LDI</span><span class="p">,</span> <span class="n">xy2depth</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">depth</span>


<span class="k">def</span> <span class="nf">tear_edges</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">threshold</span> <span class="o">=</span> <span class="mf">0.00025</span><span class="p">,</span> <span class="n">xy2depth</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">remove_edge_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">remove_horizon</span><span class="p">,</span> <span class="n">remove_vertical</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="n">mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;H&#39;</span><span class="p">],</span> <span class="n">mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]))</span>
    <span class="n">mesh_nodes</span> <span class="o">=</span> <span class="n">mesh</span><span class="o">.</span><span class="n">nodes</span>
    <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="n">mesh</span><span class="o">.</span><span class="n">edges</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">mesh_nodes</span><span class="p">[</span><span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="s1">&#39;disp&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">mesh_nodes</span><span class="p">[</span><span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="s1">&#39;disp&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">threshold</span><span class="p">:</span>
            <span class="n">remove_edge_list</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

            <span class="n">near</span><span class="p">,</span> <span class="n">far</span> <span class="o">=</span> <span class="n">edge</span> <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">])</span> <span class="o">&lt;</span> <span class="nb">abs</span><span class="p">(</span><span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">])</span> <span class="k">else</span> <span class="n">edge</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

            <span class="n">mesh_nodes</span><span class="p">[</span><span class="n">far</span><span class="p">][</span><span class="s1">&#39;near&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span> <span class="k">if</span> <span class="n">mesh_nodes</span><span class="p">[</span><span class="n">far</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;near&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">mesh_nodes</span><span class="p">[</span><span class="n">far</span><span class="p">][</span><span class="s1">&#39;near&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">near</span><span class="p">)</span>
            <span class="n">mesh_nodes</span><span class="p">[</span><span class="n">near</span><span class="p">][</span><span class="s1">&#39;far&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span> <span class="k">if</span> <span class="n">mesh_nodes</span><span class="p">[</span><span class="n">near</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;far&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">mesh_nodes</span><span class="p">[</span><span class="n">near</span><span class="p">][</span><span class="s1">&#39;far&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">far</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">near</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">far</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">remove_horizon</span><span class="p">[</span><span class="n">near</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">near</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">far</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="n">near</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">far</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">remove_vertical</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">near</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">far</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">near</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">mesh</span><span class="o">.</span><span class="n">remove_edges_from</span><span class="p">(</span><span class="n">remove_edge_list</span><span class="p">)</span>

    <span class="n">remove_edge_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">dang_horizon</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">remove_horizon</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">remove_horizon</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">remove_horizon</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">dang_vertical</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">remove_vertical</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">remove_vertical</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">remove_vertical</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>

    <span class="n">horizon_condition</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;bord_up&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&lt;=</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;bord_down&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">vertical_condition</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;bord_left&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&lt;=</span> <span class="n">y</span> <span class="o">&lt;</span> <span class="n">mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;bord_right&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>

    <span class="n">prjto3d</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">xy2depth</span><span class="p">[(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)][</span><span class="mi">0</span><span class="p">])</span>

    <span class="n">node_existence</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">mesh</span><span class="o">.</span><span class="n">has_node</span><span class="p">(</span><span class="n">prjto3d</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">dang_horizon</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dang_horizon</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
        <span class="k">if</span> <span class="n">horizon_condition</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="ow">and</span> <span class="n">node_existence</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="ow">and</span> <span class="n">node_existence</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">remove_edge_list</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">prjto3d</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="n">prjto3d</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">+</span><span class="mi">1</span><span class="p">)))</span>
    <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">dang_vertical</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dang_vertical</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
        <span class="k">if</span> <span class="n">vertical_condition</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="ow">and</span> <span class="n">node_existence</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="ow">and</span> <span class="n">node_existence</span><span class="p">(</span><span class="n">x</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
            <span class="n">remove_edge_list</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">prjto3d</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="n">prjto3d</span><span class="p">(</span><span class="n">x</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">y</span><span class="p">)))</span>
    <span class="n">mesh</span><span class="o">.</span><span class="n">remove_edges_from</span><span class="p">(</span><span class="n">remove_edge_list</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">mesh</span>

<span class="k">def</span> <span class="nf">calculate_fov</span><span class="p">(</span><span class="n">mesh</span><span class="p">):</span>
    <span class="n">k</span> <span class="o">=</span> <span class="n">mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;cam_param&#39;</span><span class="p">]</span>
    <span class="n">mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;hFov&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan</span><span class="p">(</span><span class="mf">1.</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">k</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]))</span>
    <span class="n">mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;vFov&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan</span><span class="p">(</span><span class="mf">1.</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">k</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]))</span>
    <span class="n">mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;aspect&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;noext_H&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;noext_W&#39;</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">mesh</span>

<span class="k">def</span> <span class="nf">calculate_fov_FB</span><span class="p">(</span><span class="n">mesh</span><span class="p">):</span>
    <span class="n">mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;aspect&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;H&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;H&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]:</span>
        <span class="n">mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;hFov&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.508015513</span>
        <span class="n">half_short</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tan</span><span class="p">(</span><span class="n">mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;hFov&#39;</span><span class="p">]</span><span class="o">/</span><span class="mf">2.0</span><span class="p">)</span>
        <span class="n">half_long</span> <span class="o">=</span> <span class="n">half_short</span> <span class="o">*</span> <span class="n">mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;aspect&#39;</span><span class="p">]</span>
        <span class="n">mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;vFov&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan</span><span class="p">(</span><span class="n">half_long</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;vFov&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.508015513</span>
        <span class="n">half_short</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tan</span><span class="p">(</span><span class="n">mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;vFov&#39;</span><span class="p">]</span><span class="o">/</span><span class="mf">2.0</span><span class="p">)</span>
        <span class="n">half_long</span> <span class="o">=</span> <span class="n">half_short</span> <span class="o">/</span> <span class="n">mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;aspect&#39;</span><span class="p">]</span>
        <span class="n">mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;hFov&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan</span><span class="p">(</span><span class="n">half_long</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">mesh</span>

<span class="k">def</span> <span class="nf">reproject_3d_int_detail</span><span class="p">(</span><span class="n">sx</span><span class="p">,</span> <span class="n">sy</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">k_00</span><span class="p">,</span> <span class="n">k_02</span><span class="p">,</span> <span class="n">k_11</span><span class="p">,</span> <span class="n">k_12</span><span class="p">,</span> <span class="n">w_offset</span><span class="p">,</span> <span class="n">h_offset</span><span class="p">):</span>
    <span class="n">abs_z</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">abs_z</span> <span class="o">*</span> <span class="p">((</span><span class="n">sy</span><span class="o">+</span><span class="mf">0.5</span><span class="o">-</span><span class="n">w_offset</span><span class="p">)</span> <span class="o">*</span> <span class="n">k_00</span> <span class="o">+</span> <span class="n">k_02</span><span class="p">),</span> <span class="n">abs_z</span> <span class="o">*</span> <span class="p">((</span><span class="n">sx</span><span class="o">+</span><span class="mf">0.5</span><span class="o">-</span><span class="n">h_offset</span><span class="p">)</span> <span class="o">*</span> <span class="n">k_11</span> <span class="o">+</span> <span class="n">k_12</span><span class="p">),</span> <span class="n">abs_z</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">reproject_3d_int_detail_FB</span><span class="p">(</span><span class="n">sx</span><span class="p">,</span> <span class="n">sy</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">w_offset</span><span class="p">,</span> <span class="n">h_offset</span><span class="p">,</span> <span class="n">mesh</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">mesh</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tan_hFov&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;tan_hFov&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tan</span><span class="p">(</span><span class="n">mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;hFov&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">mesh</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tan_vFov&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;tan_vFov&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tan</span><span class="p">(</span><span class="n">mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;vFov&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">)</span>

    <span class="n">ray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([(</span><span class="o">-</span><span class="mf">1.</span> <span class="o">+</span> <span class="mf">2.</span> <span class="o">*</span> <span class="p">((</span><span class="n">sy</span><span class="o">+</span><span class="mf">0.5</span><span class="o">-</span><span class="n">w_offset</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)))</span> <span class="o">*</span> <span class="n">mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;tan_hFov&#39;</span><span class="p">],</span>
                    <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="mf">2.</span> <span class="o">*</span> <span class="p">(</span><span class="n">sx</span><span class="o">+</span><span class="mf">0.5</span><span class="o">-</span><span class="n">h_offset</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;H&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">*</span> <span class="n">mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;tan_vFov&#39;</span><span class="p">],</span>
                    <span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">point_3d</span> <span class="o">=</span> <span class="n">ray</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">point_3d</span>


<span class="k">def</span> <span class="nf">reproject_3d_int</span><span class="p">(</span><span class="n">sx</span><span class="p">,</span> <span class="n">sy</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">mesh</span><span class="p">):</span>
    <span class="n">k</span> <span class="o">=</span> <span class="n">mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;cam_param_pix_inv&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">k</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">k</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
    <span class="n">ray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">sy</span><span class="o">-</span><span class="n">mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;woffset&#39;</span><span class="p">],</span> <span class="n">sx</span><span class="o">-</span><span class="n">mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;hoffset&#39;</span><span class="p">],</span> <span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

    <span class="n">point_3d</span> <span class="o">=</span> <span class="n">ray</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
    <span class="n">point_3d</span> <span class="o">=</span> <span class="n">point_3d</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">point_3d</span>

<span class="k">def</span> <span class="nf">generate_init_node</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">min_node_in_cc</span><span class="p">):</span>
    <span class="n">mesh_nodes</span> <span class="o">=</span> <span class="n">mesh</span><span class="o">.</span><span class="n">nodes</span>

    <span class="n">info_on_pix</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">ccs</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">netx</span><span class="o">.</span><span class="n">connected_components</span><span class="p">(</span><span class="n">mesh</span><span class="p">),</span> <span class="n">key</span> <span class="o">=</span> <span class="nb">len</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">remove_nodes</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">cc</span> <span class="ow">in</span> <span class="n">ccs</span><span class="p">:</span>

        <span class="n">remove_flag</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cc</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">min_node_in_cc</span> <span class="k">else</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">remove_flag</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">nd</span><span class="p">)</span> <span class="ow">in</span> <span class="n">cc</span><span class="p">:</span>
                <span class="n">info_on_pix</span><span class="p">[(</span><span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">)]</span> <span class="o">=</span> <span class="p">[{</span><span class="s1">&#39;depth&#39;</span><span class="p">:</span><span class="n">nd</span><span class="p">,</span>
                                          <span class="s1">&#39;color&#39;</span><span class="p">:</span><span class="n">mesh_nodes</span><span class="p">[(</span><span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">nd</span><span class="p">)][</span><span class="s1">&#39;color&#39;</span><span class="p">],</span>
                                          <span class="s1">&#39;synthesis&#39;</span><span class="p">:</span><span class="kc">False</span><span class="p">,</span>
                                          <span class="s1">&#39;disp&#39;</span><span class="p">:</span><span class="n">mesh_nodes</span><span class="p">[(</span><span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">nd</span><span class="p">)][</span><span class="s1">&#39;disp&#39;</span><span class="p">]}]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="p">[</span><span class="n">remove_nodes</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">nd</span><span class="p">))</span> <span class="k">for</span> <span class="p">(</span><span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">nd</span><span class="p">)</span> <span class="ow">in</span> <span class="n">cc</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">remove_nodes</span><span class="p">:</span>
        <span class="n">far_nodes</span> <span class="o">=</span> <span class="p">[]</span> <span class="k">if</span> <span class="n">mesh_nodes</span><span class="p">[</span><span class="n">node</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;far&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">mesh_nodes</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="s1">&#39;far&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">far_node</span> <span class="ow">in</span> <span class="n">far_nodes</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">mesh</span><span class="o">.</span><span class="n">has_node</span><span class="p">(</span><span class="n">far_node</span><span class="p">)</span> <span class="ow">and</span> <span class="n">mesh_nodes</span><span class="p">[</span><span class="n">far_node</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;near&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">mesh_nodes</span><span class="p">[</span><span class="n">far_node</span><span class="p">][</span><span class="s1">&#39;near&#39;</span><span class="p">]:</span>
                <span class="n">mesh_nodes</span><span class="p">[</span><span class="n">far_node</span><span class="p">][</span><span class="s1">&#39;near&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="n">near_nodes</span> <span class="o">=</span> <span class="p">[]</span> <span class="k">if</span> <span class="n">mesh_nodes</span><span class="p">[</span><span class="n">node</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;near&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">mesh_nodes</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="s1">&#39;near&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">near_node</span> <span class="ow">in</span> <span class="n">near_nodes</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">mesh</span><span class="o">.</span><span class="n">has_node</span><span class="p">(</span><span class="n">near_node</span><span class="p">)</span> <span class="ow">and</span> <span class="n">mesh_nodes</span><span class="p">[</span><span class="n">near_node</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;far&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">mesh_nodes</span><span class="p">[</span><span class="n">near_node</span><span class="p">][</span><span class="s1">&#39;far&#39;</span><span class="p">]:</span>
                <span class="n">mesh_nodes</span><span class="p">[</span><span class="n">near_node</span><span class="p">][</span><span class="s1">&#39;far&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

    <span class="p">[</span><span class="n">mesh</span><span class="o">.</span><span class="n">remove_node</span><span class="p">(</span><span class="n">node</span><span class="p">)</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">remove_nodes</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">mesh</span><span class="p">,</span> <span class="n">info_on_pix</span>

<span class="k">def</span> <span class="nf">get_neighbors</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">[</span><span class="o">*</span><span class="n">mesh</span><span class="o">.</span><span class="n">neighbors</span><span class="p">(</span><span class="n">node</span><span class="p">)]</span>

<span class="k">def</span> <span class="nf">generate_face</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">info_on_pix</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
    <span class="n">H</span><span class="p">,</span> <span class="n">W</span> <span class="o">=</span> <span class="n">mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;H&#39;</span><span class="p">],</span> <span class="n">mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span>
    <span class="n">str_faces</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">num_node</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mesh</span><span class="o">.</span><span class="n">nodes</span><span class="p">)</span>
    <span class="n">ply_flag</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;save_ply&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">out_fmt</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="n">cur_id_b</span><span class="p">,</span> <span class="n">cur_id_self</span><span class="p">,</span> <span class="n">cur_id_a</span><span class="p">,</span> <span class="n">ply_flag</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">ply_flag</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="nb">input</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;3&#39;</span><span class="p">,</span> <span class="n">cur_id_b</span><span class="p">,</span> <span class="n">cur_id_self</span><span class="p">,</span> <span class="n">cur_id_a</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">input</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">cur_id_b</span><span class="p">,</span> <span class="n">cur_id_self</span><span class="p">,</span> <span class="n">cur_id_a</span><span class="p">])</span>
    <span class="n">mesh_nodes</span> <span class="o">=</span> <span class="n">mesh</span><span class="o">.</span><span class="n">nodes</span>
    <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">mesh_nodes</span><span class="p">:</span>
        <span class="n">cur_id_self</span> <span class="o">=</span> <span class="n">mesh_nodes</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="s1">&#39;cur_id&#39;</span><span class="p">]</span>
        <span class="n">ne_nodes</span> <span class="o">=</span> <span class="n">get_neighbors</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
        <span class="n">four_dir_nes</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;up&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;left&#39;</span><span class="p">:</span> <span class="p">[],</span>
                        <span class="s1">&#39;down&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;right&#39;</span><span class="p">:</span> <span class="p">[]}</span>
        <span class="k">for</span> <span class="n">ne_node</span> <span class="ow">in</span> <span class="n">ne_nodes</span><span class="p">:</span>
            <span class="n">store_tuple</span> <span class="o">=</span> <span class="p">[</span><span class="n">ne_node</span><span class="p">,</span> <span class="n">mesh_nodes</span><span class="p">[</span><span class="n">ne_node</span><span class="p">][</span><span class="s1">&#39;cur_id&#39;</span><span class="p">]]</span>
            <span class="k">if</span> <span class="n">ne_node</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">node</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">ne_node</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">ne_node</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">four_dir_nes</span><span class="p">[</span><span class="s1">&#39;left&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">store_tuple</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">four_dir_nes</span><span class="p">[</span><span class="s1">&#39;right&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">store_tuple</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">ne_node</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">ne_node</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">four_dir_nes</span><span class="p">[</span><span class="s1">&#39;up&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">store_tuple</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">four_dir_nes</span><span class="p">[</span><span class="s1">&#39;down&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">store_tuple</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">node_a</span><span class="p">,</span> <span class="n">cur_id_a</span> <span class="ow">in</span> <span class="n">four_dir_nes</span><span class="p">[</span><span class="s1">&#39;up&#39;</span><span class="p">]:</span>
            <span class="k">for</span> <span class="n">node_b</span><span class="p">,</span> <span class="n">cur_id_b</span> <span class="ow">in</span> <span class="n">four_dir_nes</span><span class="p">[</span><span class="s1">&#39;right&#39;</span><span class="p">]:</span>
                <span class="n">out_fmt</span><span class="p">(</span><span class="n">str_faces</span><span class="p">,</span> <span class="n">cur_id_b</span><span class="p">,</span> <span class="n">cur_id_self</span><span class="p">,</span> <span class="n">cur_id_a</span><span class="p">,</span> <span class="n">ply_flag</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">node_a</span><span class="p">,</span> <span class="n">cur_id_a</span> <span class="ow">in</span> <span class="n">four_dir_nes</span><span class="p">[</span><span class="s1">&#39;right&#39;</span><span class="p">]:</span>
            <span class="k">for</span> <span class="n">node_b</span><span class="p">,</span> <span class="n">cur_id_b</span> <span class="ow">in</span> <span class="n">four_dir_nes</span><span class="p">[</span><span class="s1">&#39;down&#39;</span><span class="p">]:</span>
                <span class="n">out_fmt</span><span class="p">(</span><span class="n">str_faces</span><span class="p">,</span> <span class="n">cur_id_b</span><span class="p">,</span> <span class="n">cur_id_self</span><span class="p">,</span> <span class="n">cur_id_a</span><span class="p">,</span> <span class="n">ply_flag</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">node_a</span><span class="p">,</span> <span class="n">cur_id_a</span> <span class="ow">in</span> <span class="n">four_dir_nes</span><span class="p">[</span><span class="s1">&#39;down&#39;</span><span class="p">]:</span>
            <span class="k">for</span> <span class="n">node_b</span><span class="p">,</span> <span class="n">cur_id_b</span> <span class="ow">in</span> <span class="n">four_dir_nes</span><span class="p">[</span><span class="s1">&#39;left&#39;</span><span class="p">]:</span>
                <span class="n">out_fmt</span><span class="p">(</span><span class="n">str_faces</span><span class="p">,</span> <span class="n">cur_id_b</span><span class="p">,</span> <span class="n">cur_id_self</span><span class="p">,</span> <span class="n">cur_id_a</span><span class="p">,</span> <span class="n">ply_flag</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">node_a</span><span class="p">,</span> <span class="n">cur_id_a</span> <span class="ow">in</span> <span class="n">four_dir_nes</span><span class="p">[</span><span class="s1">&#39;left&#39;</span><span class="p">]:</span>
            <span class="k">for</span> <span class="n">node_b</span><span class="p">,</span> <span class="n">cur_id_b</span> <span class="ow">in</span> <span class="n">four_dir_nes</span><span class="p">[</span><span class="s1">&#39;up&#39;</span><span class="p">]:</span>
                <span class="n">out_fmt</span><span class="p">(</span><span class="n">str_faces</span><span class="p">,</span> <span class="n">cur_id_b</span><span class="p">,</span> <span class="n">cur_id_self</span><span class="p">,</span> <span class="n">cur_id_a</span><span class="p">,</span> <span class="n">ply_flag</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">str_faces</span>

<span class="k">def</span> <span class="nf">reassign_floating_island</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">info_on_pix</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">depth</span><span class="p">):</span>
    <span class="n">H</span><span class="p">,</span> <span class="n">W</span> <span class="o">=</span> <span class="n">mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;H&#39;</span><span class="p">],</span> <span class="n">mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">],</span>
    <span class="n">mesh_nodes</span> <span class="o">=</span> <span class="n">mesh</span><span class="o">.</span><span class="n">nodes</span>
    <span class="n">bord_up</span><span class="p">,</span> <span class="n">bord_down</span> <span class="o">=</span> <span class="n">mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;bord_up&#39;</span><span class="p">],</span> <span class="n">mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;bord_down&#39;</span><span class="p">]</span>
    <span class="n">bord_left</span><span class="p">,</span> <span class="n">bord_right</span> <span class="o">=</span> <span class="n">mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;bord_left&#39;</span><span class="p">],</span> <span class="n">mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;bord_right&#39;</span><span class="p">]</span>
    <span class="n">W</span> <span class="o">=</span> <span class="n">mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span>
    <span class="n">lost_map</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">H</span><span class="p">,</span> <span class="n">W</span><span class="p">))</span>

    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    (5) is_inside(x, y, xmin, xmax, ymin, ymax) : Check if a pixel(x, y) is inside the border.</span>
<span class="sd">    (6) get_cross_nes(x, y) : Get the four cross neighbors of pixel(x, y).</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">key_exist</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">d</span><span class="p">,</span> <span class="n">k</span><span class="p">:</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">d</span>
    <span class="n">is_inside</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span><span class="p">:</span> <span class="n">xmin</span> <span class="o">&lt;=</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">xmax</span> <span class="ow">and</span> <span class="n">ymin</span> <span class="o">&lt;=</span> <span class="n">y</span> <span class="o">&lt;</span> <span class="n">ymax</span>
    <span class="n">get_cross_nes</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="p">[(</span><span class="n">x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    (A) Highlight the pixels on isolated floating island.</span>
<span class="sd">    (B) Number those isolated floating islands with connected component analysis.</span>
<span class="sd">    (C) For each isolated island:</span>
<span class="sd">        (1) Find its longest surrounded depth edge.</span>
<span class="sd">        (2) Propogate depth from that depth edge to the pixels on the isolated island.</span>
<span class="sd">        (3) Build the connection between the depth edge and that isolated island.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">H</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">W</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">is_inside</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">bord_up</span><span class="p">,</span> <span class="n">bord_down</span><span class="p">,</span> <span class="n">bord_left</span><span class="p">,</span> <span class="n">bord_right</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span><span class="p">(</span><span class="n">key_exist</span><span class="p">(</span><span class="n">info_on_pix</span><span class="p">,</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))):</span>
                <span class="n">lost_map</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">label_lost_map</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">connectedComponents</span><span class="p">(</span><span class="n">lost_map</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">),</span> <span class="n">connectivity</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">H</span><span class="p">,</span> <span class="n">W</span><span class="p">))</span>
    <span class="n">mask</span><span class="p">[</span><span class="n">bord_up</span><span class="p">:</span><span class="n">bord_down</span><span class="p">,</span> <span class="n">bord_left</span><span class="p">:</span><span class="n">bord_right</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">label_lost_map</span> <span class="o">=</span> <span class="p">(</span><span class="n">label_lost_map</span> <span class="o">*</span> <span class="n">mask</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">label_lost_map</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">lost_xs</span><span class="p">,</span> <span class="n">lost_ys</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">label_lost_map</span> <span class="o">==</span> <span class="n">i</span><span class="p">)</span>
        <span class="n">surr_edge_ids</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">lost_x</span><span class="p">,</span> <span class="n">lost_y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">lost_xs</span><span class="p">,</span> <span class="n">lost_ys</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">lost_x</span><span class="p">,</span> <span class="n">lost_y</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="mi">295</span><span class="p">,</span> <span class="mi">389</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">lost_x</span><span class="p">,</span> <span class="n">lost_y</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="mi">296</span><span class="p">,</span> <span class="mi">389</span><span class="p">):</span>
                <span class="kn">import</span> <span class="nn">pdb</span><span class="p">;</span> <span class="n">pdb</span><span class="o">.</span><span class="n">set_trace</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">ne</span> <span class="ow">in</span> <span class="n">get_cross_nes</span><span class="p">(</span><span class="n">lost_x</span><span class="p">,</span> <span class="n">lost_y</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">key_exist</span><span class="p">(</span><span class="n">info_on_pix</span><span class="p">,</span> <span class="n">ne</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">info</span> <span class="ow">in</span> <span class="n">info_on_pix</span><span class="p">[</span><span class="n">ne</span><span class="p">]:</span>
                        <span class="n">ne_node</span> <span class="o">=</span> <span class="p">(</span><span class="n">ne</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ne</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;depth&#39;</span><span class="p">])</span>
                        <span class="k">if</span> <span class="n">key_exist</span><span class="p">(</span><span class="n">mesh_nodes</span><span class="p">[</span><span class="n">ne_node</span><span class="p">],</span> <span class="s1">&#39;edge_id&#39;</span><span class="p">):</span>
                            <span class="n">edge_id</span> <span class="o">=</span> <span class="n">mesh_nodes</span><span class="p">[</span><span class="n">ne_node</span><span class="p">][</span><span class="s1">&#39;edge_id&#39;</span><span class="p">]</span>
                            <span class="n">surr_edge_ids</span><span class="p">[</span><span class="n">edge_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">surr_edge_ids</span><span class="p">[</span><span class="n">edge_id</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">ne_node</span><span class="p">]</span> <span class="k">if</span> \
                                                <span class="n">key_exist</span><span class="p">(</span><span class="n">surr_edge_ids</span><span class="p">,</span> <span class="n">edge_id</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="n">ne_node</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">surr_edge_ids</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">edge_id</span><span class="p">,</span> <span class="n">edge_nodes</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="o">*</span><span class="n">surr_edge_ids</span><span class="o">.</span><span class="n">items</span><span class="p">()],</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">edge_depth_map</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">H</span><span class="p">,</span> <span class="n">W</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">edge_nodes</span><span class="p">:</span>
            <span class="n">edge_depth_map</span><span class="p">[</span><span class="n">node</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">node</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">node</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">lost_xs</span><span class="p">,</span> <span class="n">lost_ys</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">label_lost_map</span> <span class="o">==</span> <span class="n">i</span><span class="p">)</span>
        <span class="k">while</span> <span class="n">lost_xs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">lost_xs</span><span class="p">,</span> <span class="n">lost_ys</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">label_lost_map</span> <span class="o">==</span> <span class="n">i</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">lost_x</span><span class="p">,</span> <span class="n">lost_y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">lost_xs</span><span class="p">,</span> <span class="n">lost_ys</span><span class="p">):</span>
                <span class="n">propagated_depth</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">real_nes</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">ne</span> <span class="ow">in</span> <span class="n">get_cross_nes</span><span class="p">(</span><span class="n">lost_x</span><span class="p">,</span> <span class="n">lost_y</span><span class="p">):</span>
                    <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">is_inside</span><span class="p">(</span><span class="n">ne</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ne</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">bord_up</span><span class="p">,</span> <span class="n">bord_down</span><span class="p">,</span> <span class="n">bord_left</span><span class="p">,</span> <span class="n">bord_right</span><span class="p">))</span> <span class="ow">or</span> \
                       <span class="n">edge_depth_map</span><span class="p">[</span><span class="n">ne</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ne</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="n">propagated_depth</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">edge_depth_map</span><span class="p">[</span><span class="n">ne</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ne</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
                    <span class="n">real_nes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ne</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">real_nes</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">reassign_depth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">propagated_depth</span><span class="p">)</span>
                <span class="n">label_lost_map</span><span class="p">[</span><span class="n">lost_x</span><span class="p">,</span> <span class="n">lost_y</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">edge_depth_map</span><span class="p">[</span><span class="n">lost_x</span><span class="p">,</span> <span class="n">lost_y</span><span class="p">]</span> <span class="o">=</span> <span class="n">reassign_depth</span>
                <span class="n">depth</span><span class="p">[</span><span class="n">lost_x</span><span class="p">,</span> <span class="n">lost_y</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">reassign_depth</span>
                <span class="n">mesh</span><span class="o">.</span><span class="n">add_node</span><span class="p">((</span><span class="n">lost_x</span><span class="p">,</span> <span class="n">lost_y</span><span class="p">,</span> <span class="n">reassign_depth</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="n">image</span><span class="p">[</span><span class="n">lost_x</span><span class="p">,</span> <span class="n">lost_y</span><span class="p">],</span>
                                                            <span class="n">synthesis</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                                            <span class="n">disp</span><span class="o">=</span><span class="mf">1.</span><span class="o">/</span><span class="n">reassign_depth</span><span class="p">,</span>
                                                            <span class="n">cc_id</span><span class="o">=</span><span class="nb">set</span><span class="p">())</span>
                <span class="n">info_on_pix</span><span class="p">[(</span><span class="n">lost_x</span><span class="p">,</span> <span class="n">lost_y</span><span class="p">)]</span> <span class="o">=</span> <span class="p">[{</span><span class="s1">&#39;depth&#39;</span><span class="p">:</span><span class="n">reassign_depth</span><span class="p">,</span>
                                                  <span class="s1">&#39;color&#39;</span><span class="p">:</span><span class="n">image</span><span class="p">[</span><span class="n">lost_x</span><span class="p">,</span> <span class="n">lost_y</span><span class="p">],</span>
                                                  <span class="s1">&#39;synthesis&#39;</span><span class="p">:</span><span class="kc">False</span><span class="p">,</span>
                                                  <span class="s1">&#39;disp&#39;</span><span class="p">:</span><span class="mf">1.</span><span class="o">/</span><span class="n">reassign_depth</span><span class="p">}]</span>
                <span class="n">new_connections</span> <span class="o">=</span> <span class="p">[((</span><span class="n">lost_x</span><span class="p">,</span> <span class="n">lost_y</span><span class="p">,</span> <span class="n">reassign_depth</span><span class="p">),</span>
                                    <span class="p">(</span><span class="n">ne</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ne</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">edge_depth_map</span><span class="p">[</span><span class="n">ne</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ne</span><span class="p">[</span><span class="mi">1</span><span class="p">]]))</span> <span class="k">for</span> <span class="n">ne</span> <span class="ow">in</span> <span class="n">real_nes</span><span class="p">]</span>
                <span class="n">mesh</span><span class="o">.</span><span class="n">add_edges_from</span><span class="p">(</span><span class="n">new_connections</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">mesh</span><span class="p">,</span> <span class="n">info_on_pix</span><span class="p">,</span> <span class="n">depth</span>

<span class="k">def</span> <span class="nf">remove_node_feat</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="o">*</span><span class="n">feats</span><span class="p">):</span>
    <span class="n">mesh_nodes</span> <span class="o">=</span> <span class="n">mesh</span><span class="o">.</span><span class="n">nodes</span>
    <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">mesh_nodes</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">feat</span> <span class="ow">in</span> <span class="n">feats</span><span class="p">:</span>
            <span class="n">mesh_nodes</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="n">feat</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">return</span> <span class="n">mesh</span>

<span class="k">def</span> <span class="nf">update_status</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">info_on_pix</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    (2) clear_node_feat(G, *fts) : Clear all the node feature on graph G.</span>
<span class="sd">    (6) get_cross_nes(x, y) : Get the four cross neighbors of pixel(x, y).</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">key_exist</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">d</span><span class="p">,</span> <span class="n">k</span><span class="p">:</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
    <span class="n">is_inside</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span><span class="p">:</span> <span class="n">xmin</span> <span class="o">&lt;=</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">xmax</span> <span class="ow">and</span> <span class="n">ymin</span> <span class="o">&lt;=</span> <span class="n">y</span> <span class="o">&lt;</span> <span class="n">ymax</span>
    <span class="n">get_cross_nes</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="p">[(</span><span class="n">x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span>
    <span class="n">append_element</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">d</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">d</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="k">if</span> <span class="n">key_exist</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">clear_node_feat</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">fts</span><span class="p">):</span>
        <span class="n">le_nodes</span> <span class="o">=</span> <span class="n">G</span><span class="o">.</span><span class="n">nodes</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">le_nodes</span><span class="p">:</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">le_nodes</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">ft</span> <span class="ow">in</span> <span class="n">fts</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">ft</span> <span class="ow">in</span> <span class="n">v</span><span class="p">:</span>
                    <span class="n">v</span><span class="p">[</span><span class="n">ft</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">clear_node_feat</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;edge_id&#39;</span><span class="p">,</span> <span class="s1">&#39;far&#39;</span><span class="p">,</span> <span class="s1">&#39;near&#39;</span><span class="p">])</span>
    <span class="n">bord_up</span><span class="p">,</span> <span class="n">bord_down</span> <span class="o">=</span> <span class="n">mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;bord_up&#39;</span><span class="p">],</span> <span class="n">mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;bord_down&#39;</span><span class="p">]</span>
    <span class="n">bord_left</span><span class="p">,</span> <span class="n">bord_right</span> <span class="o">=</span> <span class="n">mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;bord_left&#39;</span><span class="p">],</span> <span class="n">mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;bord_right&#39;</span><span class="p">]</span>

    <span class="n">le_nodes</span> <span class="o">=</span> <span class="n">mesh</span><span class="o">.</span><span class="n">nodes</span>

    <span class="k">for</span> <span class="n">node_key</span> <span class="ow">in</span> <span class="n">le_nodes</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">mesh</span><span class="o">.</span><span class="n">neighbors</span><span class="p">(</span><span class="n">node_key</span><span class="p">)</span><span class="o">.</span><span class="fm">__length_hint__</span><span class="p">()</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">four_nes</span> <span class="o">=</span> <span class="p">[</span><span class="n">xx</span> <span class="k">for</span> <span class="n">xx</span> <span class="ow">in</span> <span class="n">get_cross_nes</span><span class="p">(</span><span class="n">node_key</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">node_key</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">if</span>
                    <span class="n">is_inside</span><span class="p">(</span><span class="n">xx</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">xx</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">bord_up</span><span class="p">,</span> <span class="n">bord_down</span><span class="p">,</span> <span class="n">bord_left</span><span class="p">,</span> <span class="n">bord_right</span><span class="p">)</span> <span class="ow">and</span>
                    <span class="n">xx</span> <span class="ow">in</span> <span class="n">info_on_pix</span><span class="p">]</span>
        <span class="p">[</span><span class="n">four_nes</span><span class="o">.</span><span class="n">remove</span><span class="p">((</span><span class="n">ne_node</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ne_node</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="k">for</span> <span class="n">ne_node</span> <span class="ow">in</span> <span class="n">mesh</span><span class="o">.</span><span class="n">neighbors</span><span class="p">(</span><span class="n">node_key</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">ne</span> <span class="ow">in</span> <span class="n">four_nes</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">info</span> <span class="ow">in</span> <span class="n">info_on_pix</span><span class="p">[</span><span class="n">ne</span><span class="p">]:</span>
                <span class="k">assert</span> <span class="n">mesh</span><span class="o">.</span><span class="n">has_node</span><span class="p">((</span><span class="n">ne</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ne</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;depth&#39;</span><span class="p">])),</span> <span class="s2">&quot;No node_key&quot;</span>
                <span class="n">ind_node</span> <span class="o">=</span> <span class="n">le_nodes</span><span class="p">[</span><span class="n">node_key</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">node_key</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">&gt;</span> <span class="nb">abs</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;depth&#39;</span><span class="p">]):</span>
                    <span class="n">ind_node</span><span class="p">[</span><span class="s1">&#39;near&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">append_element</span><span class="p">(</span><span class="n">ind_node</span><span class="p">,</span> <span class="s1">&#39;near&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">ne</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ne</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;depth&#39;</span><span class="p">]))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ind_node</span><span class="p">[</span><span class="s1">&#39;far&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">append_element</span><span class="p">(</span><span class="n">ind_node</span><span class="p">,</span> <span class="s1">&#39;far&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">ne</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ne</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;depth&#39;</span><span class="p">]))</span>
    <span class="k">if</span> <span class="n">depth</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">info_on_pix</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">depth</span><span class="p">[</span><span class="n">key</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">key</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">!=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;depth&#39;</span><span class="p">]):</span>
                <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;disp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">/</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;depth&#39;</span><span class="p">]</span>
                <span class="n">depth</span><span class="p">[</span><span class="n">key</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">key</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;depth&#39;</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">mesh</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">info_on_pix</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">mesh</span>

<span class="k">def</span> <span class="nf">group_edges</span><span class="p">(</span><span class="n">LDI</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">remove_conflict_ordinal</span><span class="p">,</span> <span class="n">spdb</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    (1) add_new_node(G, node) : add &quot;node&quot; to graph &quot;G&quot;</span>
<span class="sd">    (2) add_new_edge(G, node_a, node_b) : add edge &quot;node_a--node_b&quot; to graph &quot;G&quot;</span>
<span class="sd">    (3) exceed_thre(x, y, thre) : Check if difference between &quot;x&quot; and &quot;y&quot; exceed threshold &quot;thre&quot;</span>
<span class="sd">    (4) key_exist(d, k) : Check if key &quot;k&#39; exists in dictionary &quot;d&quot;</span>
<span class="sd">    (5) comm_opp_bg(G, x, y) : Check if node &quot;x&quot; and &quot;y&quot; in graph &quot;G&quot; treat the same opposite node as background</span>
<span class="sd">    (6) comm_opp_fg(G, x, y) : Check if node &quot;x&quot; and &quot;y&quot; in graph &quot;G&quot; treat the same opposite node as foreground</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">add_new_node</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">G</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">G</span><span class="o">.</span><span class="n">has_node</span><span class="p">(</span><span class="n">node</span><span class="p">)</span> <span class="k">else</span> <span class="n">G</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
    <span class="n">add_new_edge</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">G</span><span class="p">,</span> <span class="n">node_a</span><span class="p">,</span> <span class="n">node_b</span><span class="p">:</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">G</span><span class="o">.</span><span class="n">has_edge</span><span class="p">(</span><span class="n">node_a</span><span class="p">,</span> <span class="n">node_b</span><span class="p">)</span> <span class="k">else</span> <span class="n">G</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">node_a</span><span class="p">,</span> <span class="n">node_b</span><span class="p">)</span>
    <span class="n">exceed_thre</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">thre</span><span class="p">:</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="nb">abs</span><span class="p">(</span><span class="n">y</span><span class="p">))</span> <span class="o">&gt;</span> <span class="n">thre</span>
    <span class="n">key_exist</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">d</span><span class="p">,</span> <span class="n">k</span><span class="p">:</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
    <span class="n">comm_opp_bg</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">G</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">key_exist</span><span class="p">(</span><span class="n">G</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">x</span><span class="p">],</span> <span class="s1">&#39;far&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">key_exist</span><span class="p">(</span><span class="n">G</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">y</span><span class="p">],</span> <span class="s1">&#39;far&#39;</span><span class="p">)</span> <span class="ow">and</span> \
                                    <span class="ow">not</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">G</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="s1">&#39;far&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">isdisjoint</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">G</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="s1">&#39;far&#39;</span><span class="p">])))</span>
    <span class="n">comm_opp_fg</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">G</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">key_exist</span><span class="p">(</span><span class="n">G</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">x</span><span class="p">],</span> <span class="s1">&#39;near&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">key_exist</span><span class="p">(</span><span class="n">G</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">y</span><span class="p">],</span> <span class="s1">&#39;near&#39;</span><span class="p">)</span> <span class="ow">and</span> \
                                    <span class="ow">not</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">G</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="s1">&#39;near&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">isdisjoint</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">G</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="s1">&#39;near&#39;</span><span class="p">])))</span>
    <span class="n">discont_graph</span> <span class="o">=</span> <span class="n">netx</span><span class="o">.</span><span class="n">Graph</span><span class="p">()</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    (A) Skip the pixel at image boundary, we don&#39;t want to deal with them.</span>
<span class="sd">    (B) Identify discontinuity by the number of its neighbor(degree).</span>
<span class="sd">        If the degree &lt; 4(up/right/buttom/left). We will go through following steps:</span>
<span class="sd">        (1) Add the discontinuity pixel &quot;node&quot; to graph &quot;discont_graph&quot;.</span>
<span class="sd">        (2) Find &quot;node&quot;&#39;s cross neighbor(up/right/buttom/left) &quot;ne_node&quot;.</span>
<span class="sd">            - If the cross neighbor &quot;ne_node&quot; is a discontinuity pixel(degree(&quot;ne_node&quot;) &lt; 4),</span>
<span class="sd">                (a) add it to graph &quot;discont_graph&quot; and build the connection between &quot;ne_node&quot; and &quot;node&quot;.</span>
<span class="sd">                (b) label its cross neighbor as invalid pixels &quot;inval_diag_candi&quot; to avoid building</span>
<span class="sd">                    connection between original discontinuity pixel &quot;node&quot; and &quot;inval_diag_candi&quot;.</span>
<span class="sd">            - Otherwise, find &quot;ne_node&quot;&#39;s cross neighbors, called diagonal candidate &quot;diag_candi&quot;.</span>
<span class="sd">                - The &quot;diag_candi&quot; is diagonal to the original discontinuity pixel &quot;node&quot;.</span>
<span class="sd">                - If &quot;diag_candi&quot; exists, go to step(3).</span>
<span class="sd">        (3) A diagonal candidate &quot;diag_candi&quot; will be :</span>
<span class="sd">            - added to the &quot;discont_graph&quot; if its degree &lt; 4.</span>
<span class="sd">            - connected to the original discontinuity pixel &quot;node&quot; if it satisfied either</span>
<span class="sd">                one of following criterion:</span>
<span class="sd">                (a) the difference of disparity between &quot;diag_candi&quot; and &quot;node&quot; is smaller than default threshold.</span>
<span class="sd">                (b) the &quot;diag_candi&quot; and &quot;node&quot; face the same opposite pixel. (See. function &quot;tear_edges&quot;)</span>
<span class="sd">                (c) Both of &quot;diag_candi&quot; and &quot;node&quot; must_connect to each other. (See. function &quot;combine_end_node&quot;)</span>
<span class="sd">    (C) Aggregate each connected part in &quot;discont_graph&quot; into &quot;discont_ccs&quot; (A.K.A. depth edge).</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">LDI</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">LDI</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;bord_up&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&lt;=</span> <span class="n">node</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">LDI</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;bord_down&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span> <span class="ow">and</span> \
               <span class="n">LDI</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;bord_left&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&lt;=</span> <span class="n">node</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">LDI</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;bord_right&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="n">neighbors</span> <span class="o">=</span> <span class="p">[</span><span class="o">*</span><span class="n">LDI</span><span class="o">.</span><span class="n">neighbors</span><span class="p">(</span><span class="n">node</span><span class="p">)]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">neighbors</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">:</span>
            <span class="n">add_new_node</span><span class="p">(</span><span class="n">discont_graph</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
            <span class="n">diag_candi_anc</span><span class="p">,</span> <span class="n">inval_diag_candi</span><span class="p">,</span> <span class="n">discont_nes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(),</span> <span class="nb">set</span><span class="p">(),</span> <span class="nb">set</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">ne_node</span> <span class="ow">in</span> <span class="n">neighbors</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">([</span><span class="o">*</span><span class="n">LDI</span><span class="o">.</span><span class="n">neighbors</span><span class="p">(</span><span class="n">ne_node</span><span class="p">)])</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">:</span>
                    <span class="n">add_new_node</span><span class="p">(</span><span class="n">discont_graph</span><span class="p">,</span> <span class="n">ne_node</span><span class="p">)</span>
                    <span class="n">add_new_edge</span><span class="p">(</span><span class="n">discont_graph</span><span class="p">,</span> <span class="n">ne_node</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
                    <span class="n">discont_nes</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">ne_node</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">diag_candi_anc</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">ne_node</span><span class="p">)</span>
            <span class="n">inval_diag_candi</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">inval_diagonal</span> <span class="k">for</span> <span class="n">ne_node</span> <span class="ow">in</span> <span class="n">discont_nes</span> <span class="k">for</span> <span class="n">inval_diagonal</span> <span class="ow">in</span> <span class="n">LDI</span><span class="o">.</span><span class="n">neighbors</span><span class="p">(</span><span class="n">ne_node</span><span class="p">)</span> <span class="k">if</span> \
                                     <span class="nb">abs</span><span class="p">(</span><span class="n">inval_diagonal</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">node</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="ow">and</span> <span class="nb">abs</span><span class="p">(</span><span class="n">inval_diagonal</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">node</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">ne_node</span> <span class="ow">in</span> <span class="n">diag_candi_anc</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">ne_node</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">node</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="n">diagonal_xys</span> <span class="o">=</span> <span class="p">[[</span><span class="n">ne_node</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ne_node</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="p">[</span><span class="n">ne_node</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ne_node</span><span class="p">[</span><span class="mi">1</span><span class="p">]]]</span>
                <span class="k">elif</span> <span class="n">ne_node</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">node</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="n">diagonal_xys</span> <span class="o">=</span> <span class="p">[[</span><span class="n">ne_node</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ne_node</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="n">ne_node</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ne_node</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]]</span>
                <span class="k">for</span> <span class="n">diag_candi</span> <span class="ow">in</span> <span class="n">LDI</span><span class="o">.</span><span class="n">neighbors</span><span class="p">(</span><span class="n">ne_node</span><span class="p">):</span>
                    <span class="k">if</span> <span class="p">[</span><span class="n">diag_candi</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">diag_candi</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="ow">in</span> <span class="n">diagonal_xys</span> <span class="ow">and</span> <span class="n">LDI</span><span class="o">.</span><span class="n">degree</span><span class="p">(</span><span class="n">diag_candi</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">diag_candi</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">inval_diag_candi</span><span class="p">:</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">exceed_thre</span><span class="p">(</span><span class="mf">1.</span><span class="o">/</span><span class="n">node</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mf">1.</span><span class="o">/</span><span class="n">diag_candi</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;depth_threshold&#39;</span><span class="p">])</span> <span class="ow">or</span> \
                               <span class="p">(</span><span class="n">comm_opp_bg</span><span class="p">(</span><span class="n">LDI</span><span class="p">,</span> <span class="n">diag_candi</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span> <span class="ow">and</span> <span class="n">comm_opp_fg</span><span class="p">(</span><span class="n">LDI</span><span class="p">,</span> <span class="n">diag_candi</span><span class="p">,</span> <span class="n">node</span><span class="p">)):</span>
                                <span class="n">add_new_node</span><span class="p">(</span><span class="n">discont_graph</span><span class="p">,</span> <span class="n">diag_candi</span><span class="p">)</span>
                                <span class="n">add_new_edge</span><span class="p">(</span><span class="n">discont_graph</span><span class="p">,</span> <span class="n">diag_candi</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">key_exist</span><span class="p">(</span><span class="n">LDI</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">diag_candi</span><span class="p">],</span> <span class="s1">&#39;must_connect&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">LDI</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">diag_candi</span><span class="p">][</span><span class="s1">&#39;must_connect&#39;</span><span class="p">]</span> <span class="ow">and</span> \
                            <span class="n">key_exist</span><span class="p">(</span><span class="n">LDI</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node</span><span class="p">],</span> <span class="s1">&#39;must_connect&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">diag_candi</span> <span class="ow">in</span> <span class="n">LDI</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="s1">&#39;must_connect&#39;</span><span class="p">]:</span>
                            <span class="n">add_new_node</span><span class="p">(</span><span class="n">discont_graph</span><span class="p">,</span> <span class="n">diag_candi</span><span class="p">)</span>
                            <span class="n">add_new_edge</span><span class="p">(</span><span class="n">discont_graph</span><span class="p">,</span> <span class="n">diag_candi</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">spdb</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">pdb</span><span class="p">;</span> <span class="n">pdb</span><span class="o">.</span><span class="n">set_trace</span><span class="p">()</span>
    <span class="n">discont_ccs</span> <span class="o">=</span> <span class="p">[</span><span class="o">*</span><span class="n">netx</span><span class="o">.</span><span class="n">connected_components</span><span class="p">(</span><span class="n">discont_graph</span><span class="p">)]</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    In some corner case, a depth edge &quot;discont_cc&quot; will contain both</span>
<span class="sd">    foreground(FG) and background(BG) pixels. This violate the assumption that</span>
<span class="sd">    a depth edge can only composite by one type of pixel(FG or BG).</span>
<span class="sd">    We need to further divide this depth edge into several sub-part so that the</span>
<span class="sd">    assumption is satisfied.</span>
<span class="sd">    (A) A depth edge is invalid if both of its &quot;far_flag&quot;(BG) and</span>
<span class="sd">        &quot;near_flag&quot;(FG) are True.</span>
<span class="sd">    (B) If the depth edge is invalid, we need to do:</span>
<span class="sd">        (1) Find the role(&quot;oridinal&quot;) of each pixel on the depth edge.</span>
<span class="sd">            &quot;-1&quot; --&gt; Its opposite pixels has smaller depth(near) than it.</span>
<span class="sd">                     It is a backgorund pixel.</span>
<span class="sd">            &quot;+1&quot; --&gt; Its opposite pixels has larger depth(far) than it.</span>
<span class="sd">                     It is a foregorund pixel.</span>
<span class="sd">            &quot;0&quot;  --&gt; Some of opposite pixels has larger depth(far) than it,</span>
<span class="sd">                     and some has smaller pixel than it.</span>
<span class="sd">                     It is an ambiguous pixel.</span>
<span class="sd">        (2) For each pixel &quot;discont_node&quot;, check if its neigbhors&#39; roles are consistent.</span>
<span class="sd">            - If not, break the connection between the neighbor &quot;ne_node&quot; that has a role</span>
<span class="sd">              different from &quot;discont_node&quot;.</span>
<span class="sd">            - If yes, remove all the role that are inconsistent to its neighbors &quot;ne_node&quot;.</span>
<span class="sd">        (3) Connected component analysis to re-identified those divided depth edge.</span>
<span class="sd">    (C) Aggregate each connected part in &quot;discont_graph&quot; into &quot;discont_ccs&quot; (A.K.A. depth edge).</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">remove_conflict_ordinal</span><span class="p">:</span>
        <span class="n">new_discont_ccs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">num_new_cc</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">edge_id</span><span class="p">,</span> <span class="n">discont_cc</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">discont_ccs</span><span class="p">):</span>
            <span class="n">near_flag</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">far_flag</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">for</span> <span class="n">discont_node</span> <span class="ow">in</span> <span class="n">discont_cc</span><span class="p">:</span>
                <span class="n">near_flag</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="n">key_exist</span><span class="p">(</span><span class="n">LDI</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">discont_node</span><span class="p">],</span> <span class="s1">&#39;far&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="n">near_flag</span>
                <span class="n">far_flag</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="n">key_exist</span><span class="p">(</span><span class="n">LDI</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">discont_node</span><span class="p">],</span> <span class="s1">&#39;near&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="n">far_flag</span>
                <span class="k">if</span> <span class="n">far_flag</span> <span class="ow">and</span> <span class="n">near_flag</span><span class="p">:</span>
                    <span class="k">break</span>
            <span class="k">if</span> <span class="n">far_flag</span> <span class="ow">and</span> <span class="n">near_flag</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">discont_node</span> <span class="ow">in</span> <span class="n">discont_cc</span><span class="p">:</span>
                    <span class="n">discont_graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">discont_node</span><span class="p">][</span><span class="s1">&#39;ordinal&#39;</span><span class="p">]</span> <span class="o">=</span> \
                        <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">key_exist</span><span class="p">(</span><span class="n">LDI</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">discont_node</span><span class="p">],</span> <span class="s1">&#39;far&#39;</span><span class="p">),</span>
                                  <span class="n">key_exist</span><span class="p">(</span><span class="n">LDI</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">discont_node</span><span class="p">],</span> <span class="s1">&#39;near&#39;</span><span class="p">)])</span> <span class="o">*</span> \
                        <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
                    <span class="n">discont_graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">discont_node</span><span class="p">][</span><span class="s1">&#39;ordinal&#39;</span><span class="p">]</span> <span class="o">=</span> \
                        <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">discont_graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">discont_node</span><span class="p">][</span><span class="s1">&#39;ordinal&#39;</span><span class="p">])</span>
                <span class="n">remove_nodes</span><span class="p">,</span> <span class="n">remove_edges</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">discont_node</span> <span class="ow">in</span> <span class="n">discont_cc</span><span class="p">:</span>
                    <span class="n">ordinal_relation</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">discont_graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">xx</span><span class="p">][</span><span class="s1">&#39;ordinal&#39;</span><span class="p">]</span> \
                                               <span class="k">for</span> <span class="n">xx</span> <span class="ow">in</span> <span class="n">discont_graph</span><span class="o">.</span><span class="n">neighbors</span><span class="p">(</span><span class="n">discont_node</span><span class="p">)])</span>
                    <span class="n">near_side</span> <span class="o">=</span> <span class="n">discont_graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">discont_node</span><span class="p">][</span><span class="s1">&#39;ordinal&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">0</span>
                    <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">ordinal_relation</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">([</span><span class="o">*</span><span class="n">discont_graph</span><span class="o">.</span><span class="n">neighbors</span><span class="p">(</span><span class="n">discont_node</span><span class="p">)]):</span>
                        <span class="n">remove_nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">discont_node</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">ne_node</span> <span class="ow">in</span> <span class="n">discont_graph</span><span class="o">.</span><span class="n">neighbors</span><span class="p">(</span><span class="n">discont_node</span><span class="p">):</span>
                            <span class="n">remove_flag</span> <span class="o">=</span> <span class="p">(</span><span class="n">near_side</span> <span class="ow">and</span> <span class="ow">not</span><span class="p">(</span><span class="n">key_exist</span><span class="p">(</span><span class="n">LDI</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">ne_node</span><span class="p">],</span> <span class="s1">&#39;far&#39;</span><span class="p">)))</span> <span class="ow">or</span> \
                                          <span class="p">(</span><span class="ow">not</span> <span class="n">near_side</span> <span class="ow">and</span> <span class="ow">not</span><span class="p">(</span><span class="n">key_exist</span><span class="p">(</span><span class="n">LDI</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">ne_node</span><span class="p">],</span> <span class="s1">&#39;near&#39;</span><span class="p">)))</span>
                            <span class="n">remove_edges</span> <span class="o">+=</span> <span class="p">[(</span><span class="n">discont_node</span><span class="p">,</span> <span class="n">ne_node</span><span class="p">)]</span> <span class="k">if</span> <span class="n">remove_flag</span> <span class="k">else</span> <span class="p">[]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">near_side</span> <span class="ow">and</span> <span class="n">key_exist</span><span class="p">(</span><span class="n">LDI</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">discont_node</span><span class="p">],</span> <span class="s1">&#39;near&#39;</span><span class="p">):</span>
                            <span class="n">LDI</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">discont_node</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;near&#39;</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="ow">not</span><span class="p">(</span><span class="n">near_side</span><span class="p">)</span> <span class="ow">and</span> <span class="n">key_exist</span><span class="p">(</span><span class="n">LDI</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">discont_node</span><span class="p">],</span> <span class="s1">&#39;far&#39;</span><span class="p">):</span>
                            <span class="n">LDI</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">discont_node</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;far&#39;</span><span class="p">)</span>
                <span class="n">discont_graph</span><span class="o">.</span><span class="n">remove_edges_from</span><span class="p">(</span><span class="n">remove_edges</span><span class="p">)</span>
                <span class="n">sub_mesh</span> <span class="o">=</span> <span class="n">discont_graph</span><span class="o">.</span><span class="n">subgraph</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">discont_cc</span><span class="p">))</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">sub_discont_ccs</span> <span class="o">=</span> <span class="p">[</span><span class="o">*</span><span class="n">netx</span><span class="o">.</span><span class="n">connected_components</span><span class="p">(</span><span class="n">sub_mesh</span><span class="p">)]</span>
                <span class="n">is_redun_near</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">xx</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">xx</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">xx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">remove_nodes</span> <span class="ow">and</span> <span class="n">key_exist</span><span class="p">(</span><span class="n">LDI</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">xx</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="s1">&#39;far&#39;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">sub_discont_cc</span> <span class="ow">in</span> <span class="n">sub_discont_ccs</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">is_redun_near</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">sub_discont_cc</span><span class="p">)):</span>
                        <span class="n">LDI</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">sub_discont_cc</span><span class="p">)[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;far&#39;</span><span class="p">)</span>
                    <span class="n">new_discont_ccs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sub_discont_cc</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">new_discont_ccs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">discont_cc</span><span class="p">)</span>
        <span class="n">discont_ccs</span> <span class="o">=</span> <span class="n">new_discont_ccs</span>
        <span class="n">new_discont_ccs</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">spdb</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">pdb</span><span class="p">;</span> <span class="n">pdb</span><span class="o">.</span><span class="n">set_trace</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">edge_id</span><span class="p">,</span> <span class="n">edge_cc</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">discont_ccs</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">edge_cc</span><span class="p">:</span>
            <span class="n">LDI</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="s1">&#39;edge_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">edge_id</span>

    <span class="k">return</span> <span class="n">discont_ccs</span><span class="p">,</span> <span class="n">LDI</span><span class="p">,</span> <span class="n">discont_graph</span>

<span class="k">def</span> <span class="nf">combine_end_node</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">edge_mesh</span><span class="p">,</span> <span class="n">edge_ccs</span><span class="p">,</span> <span class="n">depth</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">collections</span>
    <span class="n">mesh_nodes</span> <span class="o">=</span> <span class="n">mesh</span><span class="o">.</span><span class="n">nodes</span>
    <span class="n">connect_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">valid_edge_id</span><span class="p">,</span> <span class="n">valid_edge_cc</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">edge_ccs</span><span class="p">):</span>
        <span class="n">connect_info</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">valid_edge_node</span> <span class="ow">in</span> <span class="n">valid_edge_cc</span><span class="p">:</span>
            <span class="n">single_connect</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">ne_node</span> <span class="ow">in</span> <span class="n">mesh</span><span class="o">.</span><span class="n">neighbors</span><span class="p">(</span><span class="n">valid_edge_node</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">mesh_nodes</span><span class="p">[</span><span class="n">ne_node</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;far&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="n">mesh_nodes</span><span class="p">[</span><span class="n">ne_node</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;far&#39;</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">mesh</span><span class="o">.</span><span class="n">has_node</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span> <span class="ow">and</span> <span class="n">mesh_nodes</span><span class="p">[</span><span class="n">fn</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;edge_id&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">single_connect</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">mesh_nodes</span><span class="p">[</span><span class="n">fn</span><span class="p">][</span><span class="s1">&#39;edge_id&#39;</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">mesh_nodes</span><span class="p">[</span><span class="n">ne_node</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;near&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="n">mesh_nodes</span><span class="p">[</span><span class="n">ne_node</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;near&#39;</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">mesh</span><span class="o">.</span><span class="n">has_node</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span> <span class="ow">and</span> <span class="n">mesh_nodes</span><span class="p">[</span><span class="n">fn</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;edge_id&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">single_connect</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">mesh_nodes</span><span class="p">[</span><span class="n">fn</span><span class="p">][</span><span class="s1">&#39;edge_id&#39;</span><span class="p">])</span>
            <span class="n">connect_info</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="o">*</span><span class="n">single_connect</span><span class="p">])</span>
        <span class="n">connect_dict</span><span class="p">[</span><span class="n">valid_edge_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">Counter</span><span class="p">(</span><span class="n">connect_info</span><span class="p">)</span>

    <span class="n">end_maps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;H&#39;</span><span class="p">],</span> <span class="n">mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]))</span>
    <span class="n">edge_maps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;H&#39;</span><span class="p">],</span> <span class="n">mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]))</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="k">for</span> <span class="n">valid_edge_id</span><span class="p">,</span> <span class="n">valid_edge_cc</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">edge_ccs</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">valid_edge_node</span> <span class="ow">in</span> <span class="n">valid_edge_cc</span><span class="p">:</span>
            <span class="n">edge_maps</span><span class="p">[</span><span class="n">valid_edge_node</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">valid_edge_node</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">valid_edge_id</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">([</span><span class="o">*</span><span class="n">edge_mesh</span><span class="o">.</span><span class="n">neighbors</span><span class="p">(</span><span class="n">valid_edge_node</span><span class="p">)])</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">num_ne</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">num_ne</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">end_maps</span><span class="p">[</span><span class="n">valid_edge_node</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">valid_edge_node</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">valid_edge_node</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">nxs</span><span class="p">,</span> <span class="n">nys</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">end_maps</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">invalid_nodes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">nx</span><span class="p">,</span> <span class="n">ny</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">nxs</span><span class="p">,</span> <span class="n">nys</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">mesh</span><span class="o">.</span><span class="n">has_node</span><span class="p">((</span><span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">end_maps</span><span class="p">[</span><span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">]))</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">invalid_nodes</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">))</span>
            <span class="k">continue</span>
        <span class="n">four_nes</span> <span class="o">=</span> <span class="p">[</span><span class="n">xx</span> <span class="k">for</span> <span class="n">xx</span> <span class="ow">in</span> <span class="p">[(</span><span class="n">nx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ny</span><span class="p">),</span> <span class="p">(</span><span class="n">nx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ny</span><span class="p">),</span> <span class="p">(</span><span class="n">nx</span><span class="p">,</span> <span class="n">ny</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="n">nx</span><span class="p">,</span> <span class="n">ny</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span> \
                        <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">xx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;H&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">xx</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span> <span class="ow">and</span> \
                        <span class="n">end_maps</span><span class="p">[</span><span class="n">xx</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">xx</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">mesh_nes</span> <span class="o">=</span> <span class="p">[</span><span class="o">*</span><span class="n">mesh</span><span class="o">.</span><span class="n">neighbors</span><span class="p">((</span><span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">end_maps</span><span class="p">[</span><span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">]))]</span>
        <span class="n">remove_num</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">fne</span> <span class="ow">in</span> <span class="n">four_nes</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">fne</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">fne</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">end_maps</span><span class="p">[</span><span class="n">fne</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">fne</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span> <span class="ow">in</span> <span class="n">mesh_nes</span><span class="p">:</span>
                <span class="n">remove_num</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">remove_num</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">four_nes</span><span class="p">):</span>
            <span class="n">invalid_nodes</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">invalid_node</span> <span class="ow">in</span> <span class="n">invalid_nodes</span><span class="p">:</span>
        <span class="n">end_maps</span><span class="p">[</span><span class="n">invalid_node</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">invalid_node</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">nxs</span><span class="p">,</span> <span class="n">nys</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">end_maps</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">invalid_nodes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">nx</span><span class="p">,</span> <span class="n">ny</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">nxs</span><span class="p">,</span> <span class="n">nys</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">mesh_nodes</span><span class="p">[(</span><span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">end_maps</span><span class="p">[</span><span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">])]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;edge_id&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">self_id</span> <span class="o">=</span> <span class="n">mesh_nodes</span><span class="p">[(</span><span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">end_maps</span><span class="p">[</span><span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">])]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;edge_id&#39;</span><span class="p">)</span>
            <span class="n">self_connect</span> <span class="o">=</span> <span class="n">connect_dict</span><span class="p">[</span><span class="n">self_id</span><span class="p">]</span> <span class="k">if</span> <span class="n">connect_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">self_id</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">four_nes</span> <span class="o">=</span> <span class="p">[</span><span class="n">xx</span> <span class="k">for</span> <span class="n">xx</span> <span class="ow">in</span> <span class="p">[(</span><span class="n">nx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ny</span><span class="p">),</span> <span class="p">(</span><span class="n">nx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ny</span><span class="p">),</span> <span class="p">(</span><span class="n">nx</span><span class="p">,</span> <span class="n">ny</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="n">nx</span><span class="p">,</span> <span class="n">ny</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span> \
                        <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">xx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;H&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">xx</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span> <span class="ow">and</span> \
                        <span class="n">end_maps</span><span class="p">[</span><span class="n">xx</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">xx</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">fne</span> <span class="ow">in</span> <span class="n">four_nes</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">mesh_nodes</span><span class="p">[(</span><span class="n">fne</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">fne</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">end_maps</span><span class="p">[</span><span class="n">fne</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">fne</span><span class="p">[</span><span class="mi">1</span><span class="p">]])]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;edge_id&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ne_id</span> <span class="o">=</span> <span class="n">mesh_nodes</span><span class="p">[(</span><span class="n">fne</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">fne</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">end_maps</span><span class="p">[</span><span class="n">fne</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">fne</span><span class="p">[</span><span class="mi">1</span><span class="p">]])][</span><span class="s1">&#39;edge_id&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">self_connect</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ne_id</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">self_connect</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ne_id</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">invalid_nodes</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">invalid_node</span> <span class="ow">in</span> <span class="n">invalid_nodes</span><span class="p">:</span>
        <span class="n">end_maps</span><span class="p">[</span><span class="n">invalid_node</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">invalid_node</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">nxs</span><span class="p">,</span> <span class="n">nys</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">end_maps</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">invalid_nodes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">nx</span><span class="p">,</span> <span class="n">ny</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">nxs</span><span class="p">,</span> <span class="n">nys</span><span class="p">):</span>
        <span class="n">four_nes</span> <span class="o">=</span> <span class="p">[</span><span class="n">xx</span> <span class="k">for</span> <span class="n">xx</span> <span class="ow">in</span> <span class="p">[(</span><span class="n">nx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ny</span><span class="p">),</span> <span class="p">(</span><span class="n">nx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ny</span><span class="p">),</span> <span class="p">(</span><span class="n">nx</span><span class="p">,</span> <span class="n">ny</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="n">nx</span><span class="p">,</span> <span class="n">ny</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span> \
                        <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">xx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;H&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">xx</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span> <span class="ow">and</span> \
                        <span class="n">end_maps</span><span class="p">[</span><span class="n">xx</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">xx</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">fne</span> <span class="ow">in</span> <span class="n">four_nes</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">mesh</span><span class="o">.</span><span class="n">has_node</span><span class="p">((</span><span class="n">fne</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">fne</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">end_maps</span><span class="p">[</span><span class="n">fne</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">fne</span><span class="p">[</span><span class="mi">1</span><span class="p">]])):</span>
                <span class="n">node_a</span><span class="p">,</span> <span class="n">node_b</span> <span class="o">=</span> <span class="p">(</span><span class="n">fne</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">fne</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">end_maps</span><span class="p">[</span><span class="n">fne</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">fne</span><span class="p">[</span><span class="mi">1</span><span class="p">]]),</span> <span class="p">(</span><span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">end_maps</span><span class="p">[</span><span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">])</span>
                <span class="n">mesh</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">node_a</span><span class="p">,</span> <span class="n">node_b</span><span class="p">)</span>
                <span class="n">mesh_nodes</span><span class="p">[</span><span class="n">node_b</span><span class="p">][</span><span class="s1">&#39;must_connect&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span> <span class="k">if</span> <span class="n">mesh_nodes</span><span class="p">[</span><span class="n">node_b</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;must_connect&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">mesh_nodes</span><span class="p">[</span><span class="n">node_b</span><span class="p">][</span><span class="s1">&#39;must_connect&#39;</span><span class="p">]</span>
                <span class="n">mesh_nodes</span><span class="p">[</span><span class="n">node_b</span><span class="p">][</span><span class="s1">&#39;must_connect&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">node_a</span><span class="p">)</span>
                <span class="n">mesh_nodes</span><span class="p">[</span><span class="n">node_b</span><span class="p">][</span><span class="s1">&#39;must_connect&#39;</span><span class="p">]</span> <span class="o">|=</span> <span class="nb">set</span><span class="p">([</span><span class="n">xx</span> <span class="k">for</span> <span class="n">xx</span> <span class="ow">in</span> <span class="p">[</span><span class="o">*</span><span class="n">edge_mesh</span><span class="o">.</span><span class="n">neighbors</span><span class="p">(</span><span class="n">node_a</span><span class="p">)]</span> <span class="k">if</span> \
                                                            <span class="p">(</span><span class="n">xx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">node_b</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="ow">and</span> <span class="p">(</span><span class="n">xx</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">node_b</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">])</span>
                <span class="n">mesh_nodes</span><span class="p">[</span><span class="n">node_a</span><span class="p">][</span><span class="s1">&#39;must_connect&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span> <span class="k">if</span> <span class="n">mesh_nodes</span><span class="p">[</span><span class="n">node_a</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;must_connect&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">mesh_nodes</span><span class="p">[</span><span class="n">node_a</span><span class="p">][</span><span class="s1">&#39;must_connect&#39;</span><span class="p">]</span>
                <span class="n">mesh_nodes</span><span class="p">[</span><span class="n">node_a</span><span class="p">][</span><span class="s1">&#39;must_connect&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">node_b</span><span class="p">)</span>
                <span class="n">mesh_nodes</span><span class="p">[</span><span class="n">node_a</span><span class="p">][</span><span class="s1">&#39;must_connect&#39;</span><span class="p">]</span> <span class="o">|=</span> <span class="nb">set</span><span class="p">([</span><span class="n">xx</span> <span class="k">for</span> <span class="n">xx</span> <span class="ow">in</span> <span class="p">[</span><span class="o">*</span><span class="n">edge_mesh</span><span class="o">.</span><span class="n">neighbors</span><span class="p">(</span><span class="n">node_b</span><span class="p">)]</span> <span class="k">if</span> \
                                                            <span class="p">(</span><span class="n">xx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">node_a</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="ow">and</span> <span class="p">(</span><span class="n">xx</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">node_a</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">])</span>
                <span class="n">invalid_nodes</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">invalid_node</span> <span class="ow">in</span> <span class="n">invalid_nodes</span><span class="p">:</span>
        <span class="n">end_maps</span><span class="p">[</span><span class="n">invalid_node</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">invalid_node</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">return</span> <span class="n">mesh</span>

<span class="k">def</span> <span class="nf">remove_redundant_edge</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">edge_mesh</span><span class="p">,</span> <span class="n">edge_ccs</span><span class="p">,</span> <span class="n">info_on_pix</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">redundant_number</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">invalid</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">spdb</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">point_to_amount</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">point_to_id</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">end_maps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;H&#39;</span><span class="p">],</span> <span class="n">mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]))</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="k">for</span> <span class="n">valid_edge_id</span><span class="p">,</span> <span class="n">valid_edge_cc</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">edge_ccs</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">valid_edge_node</span> <span class="ow">in</span> <span class="n">valid_edge_cc</span><span class="p">:</span>
            <span class="n">point_to_amount</span><span class="p">[</span><span class="n">valid_edge_node</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">valid_edge_cc</span><span class="p">)</span>
            <span class="n">point_to_id</span><span class="p">[</span><span class="n">valid_edge_node</span><span class="p">]</span> <span class="o">=</span> <span class="n">valid_edge_id</span>
            <span class="k">if</span> <span class="n">edge_mesh</span><span class="o">.</span><span class="n">has_node</span><span class="p">(</span><span class="n">valid_edge_node</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">([</span><span class="o">*</span><span class="n">edge_mesh</span><span class="o">.</span><span class="n">neighbors</span><span class="p">(</span><span class="n">valid_edge_node</span><span class="p">)])</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">end_maps</span><span class="p">[</span><span class="n">valid_edge_node</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">valid_edge_node</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">valid_edge_id</span>
    <span class="n">nxs</span><span class="p">,</span> <span class="n">nys</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">end_maps</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">point_to_adjoint</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">nx</span><span class="p">,</span> <span class="n">ny</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">nxs</span><span class="p">,</span> <span class="n">nys</span><span class="p">):</span>
        <span class="n">adjoint_edges</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">end_maps</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="p">[(</span><span class="n">nx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ny</span><span class="p">),</span> <span class="p">(</span><span class="n">nx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ny</span><span class="p">),</span> <span class="p">(</span><span class="n">nx</span><span class="p">,</span> <span class="n">ny</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="n">nx</span><span class="p">,</span> <span class="n">ny</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)]</span> <span class="k">if</span> <span class="n">end_maps</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">]</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">point_to_adjoint</span><span class="p">[</span><span class="n">end_maps</span><span class="p">[</span><span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">]]</span> <span class="o">=</span> <span class="p">(</span><span class="n">point_to_adjoint</span><span class="p">[</span><span class="n">end_maps</span><span class="p">[</span><span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">]]</span> <span class="o">|</span> <span class="n">adjoint_edges</span><span class="p">)</span> <span class="k">if</span> <span class="n">point_to_adjoint</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">end_maps</span><span class="p">[</span><span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">])</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">adjoint_edges</span>
    <span class="n">valid_edge_ccs</span> <span class="o">=</span> <span class="n">filter_edge</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">edge_ccs</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">invalid</span><span class="o">=</span><span class="n">invalid</span><span class="p">)</span>
    <span class="n">edge_canvas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;H&#39;</span><span class="p">],</span> <span class="n">mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]))</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="k">for</span> <span class="n">valid_edge_id</span><span class="p">,</span> <span class="n">valid_edge_cc</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">valid_edge_ccs</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">valid_edge_node</span> <span class="ow">in</span> <span class="n">valid_edge_cc</span><span class="p">:</span>
            <span class="n">edge_canvas</span><span class="p">[</span><span class="n">valid_edge_node</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">valid_edge_node</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">valid_edge_id</span>
    <span class="k">if</span> <span class="n">spdb</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">edge_canvas</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="kn">import</span> <span class="nn">pdb</span><span class="p">;</span> <span class="n">pdb</span><span class="o">.</span><span class="n">set_trace</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">valid_edge_id</span><span class="p">,</span> <span class="n">valid_edge_cc</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">valid_edge_ccs</span><span class="p">):</span>
        <span class="n">end_number</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">four_end_number</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">eight_end_number</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">db_eight_end_number</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">valid_edge_cc</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">redundant_number</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">for</span> <span class="n">valid_edge_node</span> <span class="ow">in</span> <span class="n">valid_edge_cc</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">([</span><span class="o">*</span><span class="n">edge_mesh</span><span class="o">.</span><span class="n">neighbors</span><span class="p">(</span><span class="n">valid_edge_node</span><span class="p">)])</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">([</span><span class="o">*</span><span class="n">edge_mesh</span><span class="o">.</span><span class="n">neighbors</span><span class="p">(</span><span class="n">valid_edge_node</span><span class="p">)])</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">hx</span><span class="p">,</span> <span class="n">hy</span><span class="p">,</span> <span class="n">hz</span> <span class="o">=</span> <span class="n">valid_edge_node</span>
                <span class="k">if</span> <span class="n">invalid</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                    <span class="n">eight_nes</span> <span class="o">=</span> <span class="p">[(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="p">[(</span><span class="n">hx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">hy</span><span class="p">),</span> <span class="p">(</span><span class="n">hx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">hy</span><span class="p">),</span> <span class="p">(</span><span class="n">hx</span><span class="p">,</span> <span class="n">hy</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="n">hx</span><span class="p">,</span> <span class="n">hy</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span>
                                                     <span class="p">(</span><span class="n">hx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">hy</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="n">hx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">hy</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="n">hx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">hy</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="n">hx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">hy</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)]</span> \
                                            <span class="k">if</span> <span class="n">info_on_pix</span><span class="o">.</span><span class="n">get</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">edge_canvas</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">]</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">edge_canvas</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">]</span> <span class="o">!=</span> <span class="n">valid_edge_id</span><span class="p">]</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">eight_nes</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">end_number</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">invalid</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">four_nes</span> <span class="o">=</span> <span class="p">[];</span> <span class="n">eight_nes</span> <span class="o">=</span> <span class="p">[];</span> <span class="n">db_eight_nes</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">four_nes</span> <span class="o">=</span> <span class="p">[(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="p">[(</span><span class="n">hx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">hy</span><span class="p">),</span> <span class="p">(</span><span class="n">hx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">hy</span><span class="p">),</span> <span class="p">(</span><span class="n">hx</span><span class="p">,</span> <span class="n">hy</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="n">hx</span><span class="p">,</span> <span class="n">hy</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)]</span> \
                                            <span class="k">if</span> <span class="n">info_on_pix</span><span class="o">.</span><span class="n">get</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">edge_canvas</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">]</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">edge_canvas</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">]</span> <span class="o">!=</span> <span class="n">valid_edge_id</span><span class="p">]</span>
                    <span class="n">eight_nes</span> <span class="o">=</span> <span class="p">[(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="p">[(</span><span class="n">hx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">hy</span><span class="p">),</span> <span class="p">(</span><span class="n">hx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">hy</span><span class="p">),</span> <span class="p">(</span><span class="n">hx</span><span class="p">,</span> <span class="n">hy</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="n">hx</span><span class="p">,</span> <span class="n">hy</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> \
                                                    <span class="p">(</span><span class="n">hx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">hy</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="n">hx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">hy</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="n">hx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">hy</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="n">hx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">hy</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)]</span> \
                                            <span class="k">if</span> <span class="n">info_on_pix</span><span class="o">.</span><span class="n">get</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">edge_canvas</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">]</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">edge_canvas</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">]</span> <span class="o">!=</span> <span class="n">valid_edge_id</span><span class="p">]</span>
                    <span class="n">db_eight_nes</span> <span class="o">=</span> <span class="p">[(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">hx</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="n">hx</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">hy</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="n">hy</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> \
                                    <span class="k">if</span> <span class="n">info_on_pix</span><span class="o">.</span><span class="n">get</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">edge_canvas</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">]</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">edge_canvas</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">]</span> <span class="o">!=</span> <span class="n">valid_edge_id</span> <span class="ow">and</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="o">!=</span> <span class="p">(</span><span class="n">hx</span><span class="p">,</span> <span class="n">hy</span><span class="p">)]</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">four_nes</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">eight_nes</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">end_number</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">four_nes</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">four_end_number</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">eight_nes</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">eight_end_number</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">db_eight_nes</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">db_eight_end_number</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">([</span><span class="o">*</span><span class="n">edge_mesh</span><span class="o">.</span><span class="n">neighbors</span><span class="p">(</span><span class="n">valid_edge_node</span><span class="p">)])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">hx</span><span class="p">,</span> <span class="n">hy</span><span class="p">,</span> <span class="n">hz</span> <span class="o">=</span> <span class="n">valid_edge_node</span>
                <span class="n">four_nes</span> <span class="o">=</span> <span class="p">[(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">info_on_pix</span><span class="p">[(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;depth&#39;</span><span class="p">])</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="p">[(</span><span class="n">hx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">hy</span><span class="p">),</span> <span class="p">(</span><span class="n">hx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">hy</span><span class="p">),</span> <span class="p">(</span><span class="n">hx</span><span class="p">,</span> <span class="n">hy</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="n">hx</span><span class="p">,</span> <span class="n">hy</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)]</span> \
                                <span class="k">if</span> <span class="n">info_on_pix</span><span class="o">.</span><span class="n">get</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> \
                                    <span class="n">mesh</span><span class="o">.</span><span class="n">has_edge</span><span class="p">(</span><span class="n">valid_edge_node</span><span class="p">,</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">info_on_pix</span><span class="p">[(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;depth&#39;</span><span class="p">]))</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">ne</span> <span class="ow">in</span> <span class="n">four_nes</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">invalid</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">or</span> <span class="p">(</span><span class="n">point_to_amount</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ne</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">point_to_amount</span><span class="p">[</span><span class="n">ne</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">redundant_number</span><span class="p">)</span> <span class="ow">or</span> \
                            <span class="n">point_to_id</span><span class="p">[</span><span class="n">ne</span><span class="p">]</span> <span class="ow">in</span> <span class="n">point_to_adjoint</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">point_to_id</span><span class="p">[</span><span class="n">valid_edge_node</span><span class="p">],</span> <span class="nb">set</span><span class="p">()):</span>
                            <span class="n">mesh</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">valid_edge_node</span><span class="p">,</span> <span class="n">ne</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="kn">import</span> <span class="nn">pdb</span><span class="p">;</span> <span class="n">pdb</span><span class="o">.</span><span class="n">set_trace</span><span class="p">()</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">invalid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">True</span> <span class="ow">and</span> <span class="n">end_number</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">invalid</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">and</span> <span class="n">end_number</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">eight_end_number</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">db_eight_end_number</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">valid_edge_node</span> <span class="ow">in</span> <span class="n">valid_edge_cc</span><span class="p">:</span>
                <span class="n">hx</span><span class="p">,</span> <span class="n">hy</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">valid_edge_node</span>
                <span class="n">four_nes</span> <span class="o">=</span> <span class="p">[(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">info_on_pix</span><span class="p">[(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;depth&#39;</span><span class="p">])</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="p">[(</span><span class="n">hx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">hy</span><span class="p">),</span> <span class="p">(</span><span class="n">hx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">hy</span><span class="p">),</span> <span class="p">(</span><span class="n">hx</span><span class="p">,</span> <span class="n">hy</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="n">hx</span><span class="p">,</span> <span class="n">hy</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)]</span> \
                                <span class="k">if</span> <span class="n">info_on_pix</span><span class="o">.</span><span class="n">get</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> \
                                    <span class="n">mesh</span><span class="o">.</span><span class="n">has_edge</span><span class="p">(</span><span class="n">valid_edge_node</span><span class="p">,</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">info_on_pix</span><span class="p">[(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;depth&#39;</span><span class="p">]))</span> <span class="ow">is</span> <span class="kc">False</span> <span class="ow">and</span> \
                                    <span class="p">(</span><span class="n">edge_canvas</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">or</span> <span class="n">edge_canvas</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">]</span> <span class="o">==</span> <span class="n">valid_edge_id</span><span class="p">)]</span>
                <span class="k">for</span> <span class="n">ne</span> <span class="ow">in</span> <span class="n">four_nes</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">invalid</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">or</span> <span class="p">(</span><span class="n">point_to_amount</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ne</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">point_to_amount</span><span class="p">[</span><span class="n">ne</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">redundant_number</span><span class="p">)</span> <span class="ow">or</span> \
                        <span class="n">point_to_id</span><span class="p">[</span><span class="n">ne</span><span class="p">]</span> <span class="ow">in</span> <span class="n">point_to_adjoint</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">point_to_id</span><span class="p">[</span><span class="n">valid_edge_node</span><span class="p">],</span> <span class="nb">set</span><span class="p">()):</span>
                        <span class="n">mesh</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">valid_edge_node</span><span class="p">,</span> <span class="n">ne</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">mesh</span>

<span class="k">def</span> <span class="nf">judge_dangle</span><span class="p">(</span><span class="n">mark</span><span class="p">,</span> <span class="n">mesh</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;=</span> <span class="n">node</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;H&#39;</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;=</span> <span class="n">node</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">mark</span>
    <span class="n">mesh_neighbors</span> <span class="o">=</span> <span class="p">[</span><span class="o">*</span><span class="n">mesh</span><span class="o">.</span><span class="n">neighbors</span><span class="p">(</span><span class="n">node</span><span class="p">)]</span>
    <span class="n">mesh_neighbors</span> <span class="o">=</span> <span class="p">[</span><span class="n">xx</span> <span class="k">for</span> <span class="n">xx</span> <span class="ow">in</span> <span class="n">mesh_neighbors</span> <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">xx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;H&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span> <span class="ow">and</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">xx</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mesh_neighbors</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">mark</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">mesh_neighbors</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">mark</span><span class="p">[</span><span class="n">node</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">node</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mesh_neighbors</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">dan_ne_node_a</span> <span class="o">=</span> <span class="n">mesh_neighbors</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">dan_ne_node_b</span> <span class="o">=</span> <span class="n">mesh_neighbors</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">dan_ne_node_a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">dan_ne_node_b</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">or</span> \
            <span class="nb">abs</span><span class="p">(</span><span class="n">dan_ne_node_a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">dan_ne_node_b</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">mark</span><span class="p">[</span><span class="n">node</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">node</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">3</span>

    <span class="k">return</span> <span class="n">mark</span>

<span class="k">def</span> <span class="nf">remove_dangling</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">edge_ccs</span><span class="p">,</span> <span class="n">edge_mesh</span><span class="p">,</span> <span class="n">info_on_pix</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>

    <span class="n">tmp_edge_ccs</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">edge_ccs</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">edge_cc_id</span><span class="p">,</span> <span class="n">valid_edge_cc</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tmp_edge_ccs</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">valid_edge_cc</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">valid_edge_cc</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">single_edge_node</span> <span class="o">=</span> <span class="p">[</span><span class="o">*</span><span class="n">valid_edge_cc</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">hx</span><span class="p">,</span> <span class="n">hy</span><span class="p">,</span> <span class="n">hz</span> <span class="o">=</span> <span class="n">single_edge_node</span>
        <span class="n">eight_nes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">info_on_pix</span><span class="p">[(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;depth&#39;</span><span class="p">])</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="p">[(</span><span class="n">hx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">hy</span><span class="p">),</span> <span class="p">(</span><span class="n">hx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">hy</span><span class="p">),</span> <span class="p">(</span><span class="n">hx</span><span class="p">,</span> <span class="n">hy</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="n">hx</span><span class="p">,</span> <span class="n">hy</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span>
                         <span class="p">(</span><span class="n">hx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">hy</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="n">hx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">hy</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="n">hx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">hy</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="n">hx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">hy</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)]</span> \
                         <span class="k">if</span> <span class="n">info_on_pix</span><span class="o">.</span><span class="n">get</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">])</span>
        <span class="n">four_nes</span> <span class="o">=</span> <span class="p">[(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">info_on_pix</span><span class="p">[(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;depth&#39;</span><span class="p">])</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="p">[(</span><span class="n">hx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">hy</span><span class="p">),</span> <span class="p">(</span><span class="n">hx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">hy</span><span class="p">),</span> <span class="p">(</span><span class="n">hx</span><span class="p">,</span> <span class="n">hy</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="n">hx</span><span class="p">,</span> <span class="n">hy</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)]</span> \
                    <span class="k">if</span> <span class="n">info_on_pix</span><span class="o">.</span><span class="n">get</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>
        <span class="n">sub_mesh</span> <span class="o">=</span> <span class="n">mesh</span><span class="o">.</span><span class="n">subgraph</span><span class="p">(</span><span class="n">eight_nes</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">ccs</span> <span class="o">=</span> <span class="n">netx</span><span class="o">.</span><span class="n">connected_components</span><span class="p">(</span><span class="n">sub_mesh</span><span class="p">)</span>
        <span class="n">four_ccs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">cc_id</span><span class="p">,</span> <span class="n">_cc</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ccs</span><span class="p">):</span>
            <span class="n">four_ccs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">set</span><span class="p">())</span>
            <span class="k">for</span> <span class="n">cc_node</span> <span class="ow">in</span> <span class="n">_cc</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">cc_node</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">hx</span><span class="p">)</span> <span class="o">+</span> <span class="nb">abs</span><span class="p">(</span><span class="n">cc_node</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">hy</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">four_ccs</span><span class="p">[</span><span class="n">cc_id</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">cc_node</span><span class="p">)</span>
        <span class="n">largest_cc</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">four_ccs</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="nb">abs</span><span class="p">(</span><span class="n">xx</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">hz</span><span class="p">)</span> <span class="k">for</span> <span class="n">xx</span> <span class="ow">in</span> <span class="n">x</span><span class="p">])))[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">largest_cc</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">ne</span> <span class="ow">in</span> <span class="n">four_nes</span><span class="p">:</span>
                <span class="n">mesh</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">single_edge_node</span><span class="p">,</span> <span class="n">ne</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mesh</span><span class="o">.</span><span class="n">remove_edges_from</span><span class="p">([(</span><span class="n">single_edge_node</span><span class="p">,</span> <span class="n">ne</span><span class="p">)</span> <span class="k">for</span> <span class="n">ne</span> <span class="ow">in</span> <span class="n">mesh</span><span class="o">.</span><span class="n">neighbors</span><span class="p">(</span><span class="n">single_edge_node</span><span class="p">)])</span>
            <span class="n">new_depth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">xx</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">xx</span> <span class="ow">in</span> <span class="n">largest_cc</span><span class="p">])</span>
            <span class="n">info_on_pix</span><span class="p">[(</span><span class="n">hx</span><span class="p">,</span> <span class="n">hy</span><span class="p">)][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;depth&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_depth</span>
            <span class="n">info_on_pix</span><span class="p">[(</span><span class="n">hx</span><span class="p">,</span> <span class="n">hy</span><span class="p">)][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;disp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="n">new_depth</span>
            <span class="n">new_node</span> <span class="o">=</span> <span class="p">(</span><span class="n">hx</span><span class="p">,</span> <span class="n">hy</span><span class="p">,</span> <span class="n">new_depth</span><span class="p">)</span>
            <span class="n">mesh</span> <span class="o">=</span> <span class="n">refresh_node</span><span class="p">(</span><span class="n">single_edge_node</span><span class="p">,</span> <span class="n">mesh</span><span class="o">.</span><span class="n">node</span><span class="p">[</span><span class="n">single_edge_node</span><span class="p">],</span> <span class="n">new_node</span><span class="p">,</span> <span class="nb">dict</span><span class="p">(),</span> <span class="n">mesh</span><span class="p">)</span>
            <span class="n">edge_ccs</span><span class="p">[</span><span class="n">edge_cc_id</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">new_node</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">ne</span> <span class="ow">in</span> <span class="n">largest_cc</span><span class="p">:</span>
                <span class="n">mesh</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">new_node</span><span class="p">,</span> <span class="n">ne</span><span class="p">)</span>

    <span class="n">mark</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;H&#39;</span><span class="p">],</span> <span class="n">mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]))</span>
    <span class="k">for</span> <span class="n">edge_idx</span><span class="p">,</span> <span class="n">edge_cc</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">edge_ccs</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">edge_node</span> <span class="ow">in</span> <span class="n">edge_cc</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;bord_up&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">edge_node</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;bord_down&#39;</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="ow">or</span> \
               <span class="ow">not</span> <span class="p">(</span><span class="n">mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;bord_left&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">edge_node</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;bord_right&#39;</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="n">mesh_neighbors</span> <span class="o">=</span> <span class="p">[</span><span class="o">*</span><span class="n">mesh</span><span class="o">.</span><span class="n">neighbors</span><span class="p">(</span><span class="n">edge_node</span><span class="p">)]</span>
            <span class="n">mesh_neighbors</span> <span class="o">=</span> <span class="p">[</span><span class="n">xx</span> <span class="k">for</span> <span class="n">xx</span> <span class="ow">in</span> <span class="n">mesh_neighbors</span> \
                                <span class="k">if</span> <span class="n">mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;bord_up&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">xx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;bord_down&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span> <span class="ow">and</span> \
                                   <span class="n">mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;bord_left&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">xx</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;bord_right&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">([</span><span class="o">*</span><span class="n">mesh</span><span class="o">.</span><span class="n">neighbors</span><span class="p">(</span><span class="n">edge_node</span><span class="p">)])</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">([</span><span class="o">*</span><span class="n">mesh</span><span class="o">.</span><span class="n">neighbors</span><span class="p">(</span><span class="n">edge_node</span><span class="p">)])</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">mark</span><span class="p">[</span><span class="n">edge_node</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">edge_node</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">+=</span> <span class="p">(</span><span class="nb">len</span><span class="p">([</span><span class="o">*</span><span class="n">mesh</span><span class="o">.</span><span class="n">neighbors</span><span class="p">(</span><span class="n">edge_node</span><span class="p">)])</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dan_ne_node_a</span> <span class="o">=</span> <span class="p">[</span><span class="o">*</span><span class="n">mesh</span><span class="o">.</span><span class="n">neighbors</span><span class="p">(</span><span class="n">edge_node</span><span class="p">)][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">dan_ne_node_b</span> <span class="o">=</span> <span class="p">[</span><span class="o">*</span><span class="n">mesh</span><span class="o">.</span><span class="n">neighbors</span><span class="p">(</span><span class="n">edge_node</span><span class="p">)][</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">dan_ne_node_a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">dan_ne_node_b</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">or</span> \
                    <span class="nb">abs</span><span class="p">(</span><span class="n">dan_ne_node_a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">dan_ne_node_b</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">mark</span><span class="p">[</span><span class="n">edge_node</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">edge_node</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">+=</span> <span class="mi">3</span>
    <span class="n">mxs</span><span class="p">,</span> <span class="n">mys</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mark</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">conn_0_nodes</span> <span class="o">=</span> <span class="p">[(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">info_on_pix</span><span class="p">[(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;depth&#39;</span><span class="p">])</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">mxs</span><span class="p">,</span> <span class="n">mys</span><span class="p">)</span> \
                        <span class="k">if</span> <span class="n">mesh</span><span class="o">.</span><span class="n">has_node</span><span class="p">((</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">info_on_pix</span><span class="p">[(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;depth&#39;</span><span class="p">]))]</span>
    <span class="n">mxs</span><span class="p">,</span> <span class="n">mys</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mark</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">conn_1_nodes</span> <span class="o">=</span> <span class="p">[(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">info_on_pix</span><span class="p">[(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;depth&#39;</span><span class="p">])</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">mxs</span><span class="p">,</span> <span class="n">mys</span><span class="p">)</span> \
                        <span class="k">if</span> <span class="n">mesh</span><span class="o">.</span><span class="n">has_node</span><span class="p">((</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">info_on_pix</span><span class="p">[(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;depth&#39;</span><span class="p">]))]</span>
    <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">conn_0_nodes</span><span class="p">:</span>
        <span class="n">hx</span><span class="p">,</span> <span class="n">hy</span> <span class="o">=</span> <span class="n">node</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">node</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">four_nes</span> <span class="o">=</span> <span class="p">[(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">info_on_pix</span><span class="p">[(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;depth&#39;</span><span class="p">])</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="p">[(</span><span class="n">hx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">hy</span><span class="p">),</span> <span class="p">(</span><span class="n">hx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">hy</span><span class="p">),</span> <span class="p">(</span><span class="n">hx</span><span class="p">,</span> <span class="n">hy</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="n">hx</span><span class="p">,</span> <span class="n">hy</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)]</span> \
                     <span class="k">if</span> <span class="n">info_on_pix</span><span class="o">.</span><span class="n">get</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>
        <span class="n">re_depth</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;value&#39;</span> <span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;count&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
        <span class="k">for</span> <span class="n">ne</span> <span class="ow">in</span> <span class="n">four_nes</span><span class="p">:</span>
            <span class="n">mesh</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">ne</span><span class="p">)</span>
            <span class="n">re_depth</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">cc_node</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">re_depth</span><span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">1.</span>
        <span class="n">re_depth</span> <span class="o">=</span> <span class="n">re_depth</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">re_depth</span><span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">]</span>
        <span class="n">mapping_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">node</span><span class="p">:</span> <span class="p">(</span><span class="n">node</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">node</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">re_depth</span><span class="p">)}</span>
        <span class="n">info_on_pix</span><span class="p">,</span> <span class="n">mesh</span><span class="p">,</span> <span class="n">edge_mesh</span> <span class="o">=</span> <span class="n">update_info</span><span class="p">(</span><span class="n">mapping_dict</span><span class="p">,</span> <span class="n">info_on_pix</span><span class="p">,</span> <span class="n">mesh</span><span class="p">,</span> <span class="n">edge_mesh</span><span class="p">)</span>
        <span class="n">depth</span><span class="p">[</span><span class="n">node</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">node</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">re_depth</span><span class="p">)</span>
        <span class="n">mark</span><span class="p">[</span><span class="n">node</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">node</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">conn_1_nodes</span><span class="p">:</span>
        <span class="n">hx</span><span class="p">,</span> <span class="n">hy</span> <span class="o">=</span> <span class="n">node</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">node</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">eight_nes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">info_on_pix</span><span class="p">[(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;depth&#39;</span><span class="p">])</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="p">[(</span><span class="n">hx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">hy</span><span class="p">),</span> <span class="p">(</span><span class="n">hx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">hy</span><span class="p">),</span> <span class="p">(</span><span class="n">hx</span><span class="p">,</span> <span class="n">hy</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="n">hx</span><span class="p">,</span> <span class="n">hy</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span>
                                                                           <span class="p">(</span><span class="n">hx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">hy</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="n">hx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">hy</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="n">hx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">hy</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="n">hx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">hy</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)]</span> \
                        <span class="k">if</span> <span class="n">info_on_pix</span><span class="o">.</span><span class="n">get</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">])</span>
        <span class="n">self_nes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">ne2</span> <span class="k">for</span> <span class="n">ne1</span> <span class="ow">in</span> <span class="n">mesh</span><span class="o">.</span><span class="n">neighbors</span><span class="p">(</span><span class="n">node</span><span class="p">)</span> <span class="k">for</span> <span class="n">ne2</span> <span class="ow">in</span> <span class="n">mesh</span><span class="o">.</span><span class="n">neighbors</span><span class="p">(</span><span class="n">ne1</span><span class="p">)</span> <span class="k">if</span> <span class="n">ne2</span> <span class="ow">in</span> <span class="n">eight_nes</span><span class="p">])</span>
        <span class="n">eight_nes</span> <span class="o">=</span> <span class="p">[</span><span class="o">*</span><span class="p">(</span><span class="n">eight_nes</span> <span class="o">-</span> <span class="n">self_nes</span><span class="p">)]</span>
        <span class="n">sub_mesh</span> <span class="o">=</span> <span class="n">mesh</span><span class="o">.</span><span class="n">subgraph</span><span class="p">(</span><span class="n">eight_nes</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">ccs</span> <span class="o">=</span> <span class="n">netx</span><span class="o">.</span><span class="n">connected_components</span><span class="p">(</span><span class="n">sub_mesh</span><span class="p">)</span>
        <span class="n">largest_cc</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">ccs</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="nb">abs</span><span class="p">(</span><span class="n">xx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">node</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="nb">abs</span><span class="p">(</span><span class="n">xx</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">node</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">xx</span> <span class="ow">in</span> <span class="n">x</span><span class="p">])))[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">mesh</span><span class="o">.</span><span class="n">remove_edges_from</span><span class="p">([(</span><span class="n">xx</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span> <span class="k">for</span> <span class="n">xx</span> <span class="ow">in</span> <span class="n">mesh</span><span class="o">.</span><span class="n">neighbors</span><span class="p">(</span><span class="n">node</span><span class="p">)])</span>
        <span class="n">re_depth</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;value&#39;</span> <span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;count&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
        <span class="k">for</span> <span class="n">cc_node</span> <span class="ow">in</span> <span class="n">largest_cc</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">cc_node</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">node</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="n">cc_node</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">node</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="k">continue</span>
            <span class="n">re_depth</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">cc_node</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">re_depth</span><span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">1.</span>
            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">cc_node</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">node</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="nb">abs</span><span class="p">(</span><span class="n">cc_node</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">node</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">mesh</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">cc_node</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">re_depth</span> <span class="o">=</span> <span class="n">re_depth</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">re_depth</span><span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">re_depth</span> <span class="o">=</span> <span class="n">node</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">renode</span> <span class="o">=</span> <span class="p">(</span><span class="n">node</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">node</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">re_depth</span><span class="p">)</span>
        <span class="n">mapping_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">node</span><span class="p">:</span> <span class="n">renode</span><span class="p">}</span>
        <span class="n">info_on_pix</span><span class="p">,</span> <span class="n">mesh</span><span class="p">,</span> <span class="n">edge_mesh</span> <span class="o">=</span> <span class="n">update_info</span><span class="p">(</span><span class="n">mapping_dict</span><span class="p">,</span> <span class="n">info_on_pix</span><span class="p">,</span> <span class="n">mesh</span><span class="p">,</span> <span class="n">edge_mesh</span><span class="p">)</span>
        <span class="n">depth</span><span class="p">[</span><span class="n">node</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">node</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">re_depth</span><span class="p">)</span>
        <span class="n">mark</span><span class="p">[</span><span class="n">node</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">node</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">edge_mesh</span><span class="p">,</span> <span class="n">mesh</span><span class="p">,</span> <span class="n">mark</span><span class="p">,</span> <span class="n">info_on_pix</span> <span class="o">=</span> <span class="n">recursive_add_edge</span><span class="p">(</span><span class="n">edge_mesh</span><span class="p">,</span> <span class="n">mesh</span><span class="p">,</span> <span class="n">info_on_pix</span><span class="p">,</span> <span class="n">renode</span><span class="p">,</span> <span class="n">mark</span><span class="p">)</span>
    <span class="n">mxs</span><span class="p">,</span> <span class="n">mys</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mark</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span>
    <span class="n">conn_2_nodes</span> <span class="o">=</span> <span class="p">[(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">info_on_pix</span><span class="p">[(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;depth&#39;</span><span class="p">])</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">mxs</span><span class="p">,</span> <span class="n">mys</span><span class="p">)</span> \
                        <span class="k">if</span> <span class="n">mesh</span><span class="o">.</span><span class="n">has_node</span><span class="p">((</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">info_on_pix</span><span class="p">[(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;depth&#39;</span><span class="p">]))</span> <span class="ow">and</span> \
                            <span class="n">mesh</span><span class="o">.</span><span class="n">degree</span><span class="p">((</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">info_on_pix</span><span class="p">[(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;depth&#39;</span><span class="p">]))</span> <span class="o">==</span> <span class="mi">2</span><span class="p">]</span>
    <span class="n">sub_mesh</span> <span class="o">=</span> <span class="n">mesh</span><span class="o">.</span><span class="n">subgraph</span><span class="p">(</span><span class="n">conn_2_nodes</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">ccs</span> <span class="o">=</span> <span class="n">netx</span><span class="o">.</span><span class="n">connected_components</span><span class="p">(</span><span class="n">sub_mesh</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">cc</span> <span class="ow">in</span> <span class="n">ccs</span><span class="p">:</span>
        <span class="n">candidate_nodes</span> <span class="o">=</span> <span class="p">[</span><span class="n">xx</span> <span class="k">for</span> <span class="n">xx</span> <span class="ow">in</span> <span class="n">cc</span> <span class="k">if</span> <span class="n">sub_mesh</span><span class="o">.</span><span class="n">degree</span><span class="p">(</span><span class="n">xx</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">candidate_nodes</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">mesh</span><span class="o">.</span><span class="n">has_node</span><span class="p">(</span><span class="n">node</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">ne_node</span> <span class="o">=</span> <span class="p">[</span><span class="n">xx</span> <span class="k">for</span> <span class="n">xx</span> <span class="ow">in</span> <span class="n">mesh</span><span class="o">.</span><span class="n">neighbors</span><span class="p">(</span><span class="n">node</span><span class="p">)</span> <span class="k">if</span> <span class="n">xx</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cc</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">hx</span><span class="p">,</span> <span class="n">hy</span> <span class="o">=</span> <span class="n">node</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">node</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">eight_nes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">info_on_pix</span><span class="p">[(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;depth&#39;</span><span class="p">])</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="p">[(</span><span class="n">hx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">hy</span><span class="p">),</span> <span class="p">(</span><span class="n">hx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">hy</span><span class="p">),</span> <span class="p">(</span><span class="n">hx</span><span class="p">,</span> <span class="n">hy</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="n">hx</span><span class="p">,</span> <span class="n">hy</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span>
                                                                            <span class="p">(</span><span class="n">hx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">hy</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="n">hx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">hy</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="n">hx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">hy</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="n">hx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">hy</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)]</span> \
                              <span class="k">if</span> <span class="n">info_on_pix</span><span class="o">.</span><span class="n">get</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">info_on_pix</span><span class="p">[(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;depth&#39;</span><span class="p">])</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cc</span><span class="p">])</span>
            <span class="n">ne_sub_mesh</span> <span class="o">=</span> <span class="n">mesh</span><span class="o">.</span><span class="n">subgraph</span><span class="p">(</span><span class="n">eight_nes</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">ne_ccs</span> <span class="o">=</span> <span class="n">netx</span><span class="o">.</span><span class="n">connected_components</span><span class="p">(</span><span class="n">ne_sub_mesh</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ne_cc</span> <span class="o">=</span> <span class="p">[</span><span class="n">ne_cc</span> <span class="k">for</span> <span class="n">ne_cc</span> <span class="ow">in</span> <span class="n">ne_ccs</span> <span class="k">if</span> <span class="n">ne_node</span> <span class="ow">in</span> <span class="n">ne_cc</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="kn">import</span> <span class="nn">pdb</span><span class="p">;</span> <span class="n">pdb</span><span class="o">.</span><span class="n">set_trace</span><span class="p">()</span>
            <span class="n">largest_cc</span> <span class="o">=</span> <span class="p">[</span><span class="n">xx</span> <span class="k">for</span> <span class="n">xx</span> <span class="ow">in</span> <span class="n">ne_cc</span> <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">xx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">node</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="nb">abs</span><span class="p">(</span><span class="n">xx</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">node</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">mesh</span><span class="o">.</span><span class="n">remove_edges_from</span><span class="p">([(</span><span class="n">xx</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span> <span class="k">for</span> <span class="n">xx</span> <span class="ow">in</span> <span class="n">mesh</span><span class="o">.</span><span class="n">neighbors</span><span class="p">(</span><span class="n">node</span><span class="p">)])</span>
            <span class="n">re_depth</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;value&#39;</span> <span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;count&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
            <span class="k">for</span> <span class="n">cc_node</span> <span class="ow">in</span> <span class="n">largest_cc</span><span class="p">:</span>
                <span class="n">re_depth</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">cc_node</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">re_depth</span><span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">1.</span>
                <span class="n">mesh</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">cc_node</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">re_depth</span> <span class="o">=</span> <span class="n">re_depth</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">re_depth</span><span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">]</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">re_depth</span> <span class="o">=</span> <span class="n">node</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">renode</span> <span class="o">=</span> <span class="p">(</span><span class="n">node</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">node</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">re_depth</span><span class="p">)</span>
            <span class="n">mapping_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">node</span><span class="p">:</span> <span class="n">renode</span><span class="p">}</span>
            <span class="n">info_on_pix</span><span class="p">,</span> <span class="n">mesh</span><span class="p">,</span> <span class="n">edge_mesh</span> <span class="o">=</span> <span class="n">update_info</span><span class="p">(</span><span class="n">mapping_dict</span><span class="p">,</span> <span class="n">info_on_pix</span><span class="p">,</span> <span class="n">mesh</span><span class="p">,</span> <span class="n">edge_mesh</span><span class="p">)</span>
            <span class="n">depth</span><span class="p">[</span><span class="n">node</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">node</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">re_depth</span><span class="p">)</span>
            <span class="n">mark</span><span class="p">[</span><span class="n">node</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">node</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">edge_mesh</span><span class="p">,</span> <span class="n">mesh</span><span class="p">,</span> <span class="n">mark</span><span class="p">,</span> <span class="n">info_on_pix</span> <span class="o">=</span> <span class="n">recursive_add_edge</span><span class="p">(</span><span class="n">edge_mesh</span><span class="p">,</span> <span class="n">mesh</span><span class="p">,</span> <span class="n">info_on_pix</span><span class="p">,</span> <span class="n">renode</span><span class="p">,</span> <span class="n">mark</span><span class="p">)</span>
            <span class="k">break</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cc</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">node</span> <span class="o">=</span> <span class="p">[</span><span class="n">node</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">cc</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">hx</span><span class="p">,</span> <span class="n">hy</span> <span class="o">=</span> <span class="n">node</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">node</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">nine_nes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">info_on_pix</span><span class="p">[(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;depth&#39;</span><span class="p">])</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="p">[(</span><span class="n">hx</span><span class="p">,</span> <span class="n">hy</span><span class="p">),</span> <span class="p">(</span><span class="n">hx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">hy</span><span class="p">),</span> <span class="p">(</span><span class="n">hx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">hy</span><span class="p">),</span> <span class="p">(</span><span class="n">hx</span><span class="p">,</span> <span class="n">hy</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="n">hx</span><span class="p">,</span> <span class="n">hy</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span>
                                                                                  <span class="p">(</span><span class="n">hx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">hy</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="n">hx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">hy</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="n">hx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">hy</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="n">hx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">hy</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)]</span> \
                                <span class="k">if</span> <span class="n">info_on_pix</span><span class="o">.</span><span class="n">get</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">mesh</span><span class="o">.</span><span class="n">has_node</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">info_on_pix</span><span class="p">[(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;depth&#39;</span><span class="p">]))])</span>
            <span class="n">ne_sub_mesh</span> <span class="o">=</span> <span class="n">mesh</span><span class="o">.</span><span class="n">subgraph</span><span class="p">(</span><span class="n">nine_nes</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">ne_ccs</span> <span class="o">=</span> <span class="n">netx</span><span class="o">.</span><span class="n">connected_components</span><span class="p">(</span><span class="n">ne_sub_mesh</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">ne_cc</span> <span class="ow">in</span> <span class="n">ne_ccs</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">ne_cc</span><span class="p">:</span>
                    <span class="n">re_depth</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;value&#39;</span> <span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;count&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
                    <span class="k">for</span> <span class="n">ne</span> <span class="ow">in</span> <span class="n">ne_cc</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">ne</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">node</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="nb">abs</span><span class="p">(</span><span class="n">ne</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">node</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="n">mesh</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">ne</span><span class="p">)</span>
                            <span class="n">re_depth</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">ne</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                            <span class="n">re_depth</span><span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">1.</span>
                    <span class="n">re_depth</span> <span class="o">=</span> <span class="n">re_depth</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">re_depth</span><span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">]</span>
                    <span class="n">mapping_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">node</span><span class="p">:</span> <span class="p">(</span><span class="n">node</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">node</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">re_depth</span><span class="p">)}</span>
                    <span class="n">info_on_pix</span><span class="p">,</span> <span class="n">mesh</span><span class="p">,</span> <span class="n">edge_mesh</span> <span class="o">=</span> <span class="n">update_info</span><span class="p">(</span><span class="n">mapping_dict</span><span class="p">,</span> <span class="n">info_on_pix</span><span class="p">,</span> <span class="n">mesh</span><span class="p">,</span> <span class="n">edge_mesh</span><span class="p">)</span>
                    <span class="n">depth</span><span class="p">[</span><span class="n">node</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">node</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">re_depth</span><span class="p">)</span>
                    <span class="n">mark</span><span class="p">[</span><span class="n">node</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">node</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">0</span>


    <span class="k">return</span> <span class="n">mesh</span><span class="p">,</span> <span class="n">info_on_pix</span><span class="p">,</span> <span class="n">edge_mesh</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">mark</span>

<span class="k">def</span> <span class="nf">context_and_holes</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">edge_ccs</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">specific_edge_id</span><span class="p">,</span> <span class="n">specific_edge_loc</span><span class="p">,</span> <span class="n">depth_feat_model</span><span class="p">,</span>
                      <span class="n">connect_points_ccs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">inpaint_iter</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">filter_edge</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">vis_edge_id</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">edge_maps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;H&#39;</span><span class="p">],</span> <span class="n">mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]))</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">mask_info</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">edge_id</span><span class="p">,</span> <span class="n">edge_cc</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">edge_ccs</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">edge_node</span> <span class="ow">in</span> <span class="n">edge_cc</span><span class="p">:</span>
            <span class="n">edge_maps</span><span class="p">[</span><span class="n">edge_node</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">edge_node</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">edge_id</span>

    <span class="n">context_ccs</span> <span class="o">=</span> <span class="p">[</span><span class="nb">set</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">edge_ccs</span><span class="p">))]</span>
    <span class="n">extend_context_ccs</span> <span class="o">=</span> <span class="p">[</span><span class="nb">set</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">edge_ccs</span><span class="p">))]</span>
    <span class="n">extend_erode_context_ccs</span> <span class="o">=</span> <span class="p">[</span><span class="nb">set</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">edge_ccs</span><span class="p">))]</span>
    <span class="n">extend_edge_ccs</span> <span class="o">=</span> <span class="p">[</span><span class="nb">set</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">edge_ccs</span><span class="p">))]</span>
    <span class="n">accomp_extend_context_ccs</span> <span class="o">=</span> <span class="p">[</span><span class="nb">set</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">edge_ccs</span><span class="p">))]</span>
    <span class="n">erode_context_ccs</span> <span class="o">=</span> <span class="p">[</span><span class="nb">set</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">edge_ccs</span><span class="p">))]</span>
    <span class="n">broken_mask_ccs</span> <span class="o">=</span> <span class="p">[</span><span class="nb">set</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">edge_ccs</span><span class="p">))]</span>
    <span class="n">invalid_extend_edge_ccs</span> <span class="o">=</span> <span class="p">[</span><span class="nb">set</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">edge_ccs</span><span class="p">))]</span>
    <span class="n">intouched_ccs</span> <span class="o">=</span> <span class="p">[</span><span class="nb">set</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">edge_ccs</span><span class="p">))]</span>
    <span class="n">redundant_ccs</span> <span class="o">=</span> <span class="p">[</span><span class="nb">set</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">edge_ccs</span><span class="p">))]</span>
    <span class="k">if</span> <span class="n">inpaint_iter</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">background_thickness</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;background_thickness&#39;</span><span class="p">]</span>
        <span class="n">context_thickness</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;context_thickness&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">background_thickness</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;background_thickness_2&#39;</span><span class="p">]</span>
        <span class="n">context_thickness</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;context_thickness_2&#39;</span><span class="p">]</span>

    <span class="n">mesh_nodes</span> <span class="o">=</span> <span class="n">mesh</span><span class="o">.</span><span class="n">nodes</span>
    <span class="k">for</span> <span class="n">edge_id</span><span class="p">,</span> <span class="n">edge_cc</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">edge_ccs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">context_thickness</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">specific_edge_id</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">edge_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">specific_edge_id</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="n">edge_group</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">edge_node</span> <span class="ow">in</span> <span class="n">edge_cc</span><span class="p">:</span>
            <span class="n">far_nodes</span> <span class="o">=</span> <span class="n">mesh_nodes</span><span class="p">[</span><span class="n">edge_node</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;far&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">far_nodes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">for</span> <span class="n">far_node</span> <span class="ow">in</span> <span class="n">far_nodes</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">far_node</span> <span class="ow">in</span> <span class="n">edge_cc</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">context_ccs</span><span class="p">[</span><span class="n">edge_id</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">far_node</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">mesh_nodes</span><span class="p">[</span><span class="n">far_node</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;edge_id&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">edge_group</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">mesh_nodes</span><span class="p">[</span><span class="n">far_node</span><span class="p">][</span><span class="s1">&#39;edge_id&#39;</span><span class="p">])</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">edge_group</span><span class="p">[</span><span class="n">mesh_nodes</span><span class="p">[</span><span class="n">far_node</span><span class="p">][</span><span class="s1">&#39;edge_id&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
                    <span class="n">edge_group</span><span class="p">[</span><span class="n">mesh_nodes</span><span class="p">[</span><span class="n">far_node</span><span class="p">][</span><span class="s1">&#39;edge_id&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">far_node</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">edge_cc</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">edge_key</span> <span class="ow">in</span> <span class="p">[</span><span class="o">*</span><span class="n">edge_group</span><span class="o">.</span><span class="n">keys</span><span class="p">()]:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">edge_group</span><span class="p">[</span><span class="n">edge_key</span><span class="p">])</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">context_ccs</span><span class="p">[</span><span class="n">edge_id</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">([</span><span class="o">*</span><span class="n">edge_group</span><span class="p">[</span><span class="n">edge_key</span><span class="p">]][</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">edge_id</span><span class="p">,</span> <span class="n">edge_cc</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">edge_ccs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">inpaint_iter</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">tmp_intouched_nodes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">edge_node</span> <span class="ow">in</span> <span class="n">edge_cc</span><span class="p">:</span>
            <span class="n">raw_intouched_nodes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">mesh_nodes</span><span class="p">[</span><span class="n">edge_node</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;near&#39;</span><span class="p">))</span> <span class="k">if</span> <span class="n">mesh_nodes</span><span class="p">[</span><span class="n">edge_node</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;near&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">set</span><span class="p">()</span>
            <span class="n">tmp_intouched_nodes</span> <span class="o">|=</span> <span class="nb">set</span><span class="p">([</span><span class="n">xx</span> <span class="k">for</span> <span class="n">xx</span> <span class="ow">in</span> <span class="n">raw_intouched_nodes</span> <span class="k">if</span> <span class="n">mesh_nodes</span><span class="p">[</span><span class="n">xx</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;edge_id&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> \
                                                                         <span class="nb">len</span><span class="p">(</span><span class="n">context_ccs</span><span class="p">[</span><span class="n">mesh_nodes</span><span class="p">[</span><span class="n">xx</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;edge_id&#39;</span><span class="p">)])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">])</span>
        <span class="n">intouched_ccs</span><span class="p">[</span><span class="n">edge_id</span><span class="p">]</span> <span class="o">|=</span> <span class="n">tmp_intouched_nodes</span>
        <span class="n">tmp_intouched_nodes</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">mask_ccs</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">edge_ccs</span><span class="p">)</span>
    <span class="n">forbidden_len</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="n">forbidden_map</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;H&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">forbidden_len</span><span class="p">,</span> <span class="n">mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">forbidden_len</span><span class="p">))</span>
    <span class="n">forbidden_map</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">forbidden_map</span><span class="p">,</span> <span class="p">((</span><span class="n">forbidden_len</span><span class="p">,</span> <span class="n">forbidden_len</span><span class="p">),</span> <span class="p">(</span><span class="n">forbidden_len</span><span class="p">,</span> <span class="n">forbidden_len</span><span class="p">)),</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;constant&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">bool</span><span class="p">)</span>
    <span class="n">cur_tmp_mask_map</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">forbidden_map</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">bool</span><span class="p">)</span>
    <span class="n">passive_background</span> <span class="o">=</span> <span class="mi">10</span> <span class="k">if</span> <span class="mi">10</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">background_thickness</span>
    <span class="n">passive_context</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="mi">1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">context_thickness</span>

    <span class="k">for</span> <span class="n">edge_id</span><span class="p">,</span> <span class="n">edge_cc</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">edge_ccs</span><span class="p">):</span>
        <span class="n">cur_mask_cc</span> <span class="o">=</span> <span class="kc">None</span><span class="p">;</span> <span class="n">cur_mask_cc</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">cur_context_cc</span> <span class="o">=</span> <span class="kc">None</span><span class="p">;</span> <span class="n">cur_context_cc</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">cur_accomp_near_cc</span> <span class="o">=</span> <span class="kc">None</span><span class="p">;</span> <span class="n">cur_accomp_near_cc</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">cur_invalid_extend_edge_cc</span> <span class="o">=</span> <span class="kc">None</span><span class="p">;</span> <span class="n">cur_invalid_extend_edge_cc</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">cur_comp_far_cc</span> <span class="o">=</span> <span class="kc">None</span><span class="p">;</span> <span class="n">cur_comp_far_cc</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">tmp_erode</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">context_ccs</span><span class="p">[</span><span class="n">edge_id</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">specific_edge_id</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">edge_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">specific_edge_id</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">background_thickness</span><span class="p">,</span> <span class="n">context_thickness</span><span class="p">)):</span>
            <span class="n">cur_tmp_mask_map</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">tmp_mask_nodes</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">mask_ccs</span><span class="p">[</span><span class="n">edge_id</span><span class="p">])</span>
                <span class="n">tmp_intersect_nodes</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">tmp_intersect_context_nodes</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">mask_map</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;H&#39;</span><span class="p">],</span> <span class="n">mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">bool</span><span class="p">)</span>
                <span class="n">context_depth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;H&#39;</span><span class="p">],</span> <span class="n">mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]))</span>
                <span class="n">comp_cnt_depth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;H&#39;</span><span class="p">],</span> <span class="n">mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]))</span>
                <span class="n">connect_map</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;H&#39;</span><span class="p">],</span> <span class="n">mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]))</span>
                <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">tmp_mask_nodes</span><span class="p">:</span>
                    <span class="n">mask_map</span><span class="p">[</span><span class="n">node</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">node</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">depth_count</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">if</span> <span class="n">mesh_nodes</span><span class="p">[</span><span class="n">node</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;far&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">comp_cnt_node</span> <span class="ow">in</span> <span class="n">mesh_nodes</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="s1">&#39;far&#39;</span><span class="p">]:</span>
                            <span class="n">comp_cnt_depth</span><span class="p">[</span><span class="n">node</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">node</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">+=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">comp_cnt_node</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                            <span class="n">depth_count</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">depth_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">comp_cnt_depth</span><span class="p">[</span><span class="n">node</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">node</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">comp_cnt_depth</span><span class="p">[</span><span class="n">node</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">node</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">/</span> <span class="n">depth_count</span>
                    <span class="n">connect_node</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">if</span> <span class="n">mesh_nodes</span><span class="p">[</span><span class="n">node</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;connect_point_id&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">connect_node</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mesh_nodes</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="s1">&#39;connect_point_id&#39;</span><span class="p">])</span>
                    <span class="n">connect_point_id</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">bincount</span><span class="p">(</span><span class="n">connect_node</span><span class="p">)</span><span class="o">.</span><span class="n">argmax</span><span class="p">()</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">connect_node</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span>
                    <span class="k">if</span> <span class="n">connect_point_id</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">connect_points_ccs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">xx</span> <span class="ow">in</span> <span class="n">connect_points_ccs</span><span class="p">[</span><span class="n">connect_point_id</span><span class="p">]:</span>
                            <span class="k">if</span> <span class="n">connect_map</span><span class="p">[</span><span class="n">xx</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">xx</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="n">connect_map</span><span class="p">[</span><span class="n">xx</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">xx</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">xx</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">mesh_nodes</span><span class="p">[</span><span class="n">node</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;connect_point_exception&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">xx</span> <span class="ow">in</span> <span class="n">mesh_nodes</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="s1">&#39;connect_point_exception&#39;</span><span class="p">]:</span>
                            <span class="k">if</span> <span class="n">connect_map</span><span class="p">[</span><span class="n">xx</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">xx</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="n">connect_map</span><span class="p">[</span><span class="n">xx</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">xx</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">xx</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">tmp_context_nodes</span> <span class="o">=</span> <span class="p">[</span><span class="o">*</span><span class="n">context_ccs</span><span class="p">[</span><span class="n">edge_id</span><span class="p">]]</span>
                <span class="n">tmp_erode</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="o">*</span><span class="n">context_ccs</span><span class="p">[</span><span class="n">edge_id</span><span class="p">]])</span>
                <span class="n">context_map</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;H&#39;</span><span class="p">],</span> <span class="n">mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">bool</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">context_map</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span> <span class="o">*</span> <span class="n">mask_map</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">))</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="kn">import</span> <span class="nn">pdb</span><span class="p">;</span> <span class="n">pdb</span><span class="o">.</span><span class="n">set_trace</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">tmp_context_nodes</span><span class="p">:</span>
                    <span class="n">context_map</span><span class="p">[</span><span class="n">node</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">node</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">context_depth</span><span class="p">[</span><span class="n">node</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">node</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">node</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">context_map</span><span class="p">[</span><span class="n">mask_map</span> <span class="o">==</span> <span class="kc">True</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">context_map</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span> <span class="o">*</span> <span class="n">mask_map</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">))</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="kn">import</span> <span class="nn">pdb</span><span class="p">;</span> <span class="n">pdb</span><span class="o">.</span><span class="n">set_trace</span><span class="p">()</span>
                <span class="n">tmp_intouched_nodes</span> <span class="o">=</span> <span class="p">[</span><span class="o">*</span><span class="n">intouched_ccs</span><span class="p">[</span><span class="n">edge_id</span><span class="p">]]</span>
                <span class="n">intouched_map</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;H&#39;</span><span class="p">],</span> <span class="n">mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">bool</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">tmp_intouched_nodes</span><span class="p">:</span> <span class="n">intouched_map</span><span class="p">[</span><span class="n">node</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">node</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">intouched_map</span><span class="p">[</span><span class="n">mask_map</span> <span class="o">==</span> <span class="kc">True</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">tmp_redundant_nodes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
                <span class="n">tmp_noncont_nodes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
                <span class="n">noncont_map</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;H&#39;</span><span class="p">],</span> <span class="n">mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">bool</span><span class="p">)</span>
                <span class="n">intersect_map</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;H&#39;</span><span class="p">],</span> <span class="n">mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">bool</span><span class="p">)</span>
                <span class="n">intersect_context_map</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;H&#39;</span><span class="p">],</span> <span class="n">mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">bool</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="n">passive_background</span> <span class="ow">and</span> <span class="n">inpaint_iter</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">new_tmp_intersect_nodes</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">new_tmp_intersect_nodes</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">tmp_intersect_nodes</span><span class="p">:</span>
                    <span class="n">nes</span> <span class="o">=</span> <span class="n">mesh</span><span class="o">.</span><span class="n">neighbors</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">ne</span> <span class="ow">in</span> <span class="n">nes</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">bool</span><span class="p">(</span><span class="n">context_map</span><span class="p">[</span><span class="n">ne</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ne</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span> <span class="ow">is</span> <span class="kc">False</span> <span class="ow">and</span> \
                        <span class="nb">bool</span><span class="p">(</span><span class="n">mask_map</span><span class="p">[</span><span class="n">ne</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ne</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span> <span class="ow">is</span> <span class="kc">False</span> <span class="ow">and</span> \
                        <span class="nb">bool</span><span class="p">(</span><span class="n">forbidden_map</span><span class="p">[</span><span class="n">ne</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ne</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">and</span> \
                        <span class="nb">bool</span><span class="p">(</span><span class="n">intouched_map</span><span class="p">[</span><span class="n">ne</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ne</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span> <span class="ow">is</span> <span class="kc">False</span> <span class="ow">and</span>\
                        <span class="nb">bool</span><span class="p">(</span><span class="n">intersect_map</span><span class="p">[</span><span class="n">ne</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ne</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span> <span class="ow">is</span> <span class="kc">False</span> <span class="ow">and</span>\
                        <span class="nb">bool</span><span class="p">(</span><span class="n">intersect_context_map</span><span class="p">[</span><span class="n">ne</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ne</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                            <span class="n">break_flag</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="n">passive_background</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="n">passive_background</span><span class="p">)</span> <span class="o">%</span> <span class="mi">8</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="n">four_nes</span> <span class="o">=</span> <span class="p">[</span><span class="n">xx</span> <span class="k">for</span> <span class="n">xx</span> <span class="ow">in</span><span class="p">[[</span><span class="n">ne</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ne</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="p">[</span><span class="n">ne</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ne</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="p">[</span><span class="n">ne</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ne</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="n">ne</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ne</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]]</span> \
                                                <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">xx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;H&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">xx</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]]</span>
                                <span class="k">for</span> <span class="n">fne</span> <span class="ow">in</span> <span class="n">four_nes</span><span class="p">:</span>
                                    <span class="k">if</span> <span class="nb">bool</span><span class="p">(</span><span class="n">mask_map</span><span class="p">[</span><span class="n">fne</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">fne</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                                        <span class="n">break_flag</span> <span class="o">=</span> <span class="kc">True</span>
                                        <span class="k">break</span>
                                <span class="k">if</span> <span class="n">break_flag</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                                    <span class="k">continue</span>
                            <span class="n">intersect_map</span><span class="p">[</span><span class="n">ne</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ne</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="n">new_tmp_intersect_nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ne</span><span class="p">)</span>
                <span class="n">tmp_intersect_nodes</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">tmp_intersect_nodes</span> <span class="o">=</span> <span class="n">new_tmp_intersect_nodes</span>

            <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="n">passive_context</span> <span class="ow">and</span> <span class="n">inpaint_iter</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">new_tmp_intersect_context_nodes</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">new_tmp_intersect_context_nodes</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">tmp_intersect_context_nodes</span><span class="p">:</span>
                    <span class="n">nes</span> <span class="o">=</span> <span class="n">mesh</span><span class="o">.</span><span class="n">neighbors</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">ne</span> <span class="ow">in</span> <span class="n">nes</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">bool</span><span class="p">(</span><span class="n">context_map</span><span class="p">[</span><span class="n">ne</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ne</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span> <span class="ow">is</span> <span class="kc">False</span> <span class="ow">and</span> \
                        <span class="nb">bool</span><span class="p">(</span><span class="n">mask_map</span><span class="p">[</span><span class="n">ne</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ne</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span> <span class="ow">is</span> <span class="kc">False</span> <span class="ow">and</span> \
                        <span class="nb">bool</span><span class="p">(</span><span class="n">forbidden_map</span><span class="p">[</span><span class="n">ne</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ne</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">and</span> \
                        <span class="nb">bool</span><span class="p">(</span><span class="n">intouched_map</span><span class="p">[</span><span class="n">ne</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ne</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span> <span class="ow">is</span> <span class="kc">False</span> <span class="ow">and</span>\
                        <span class="nb">bool</span><span class="p">(</span><span class="n">intersect_map</span><span class="p">[</span><span class="n">ne</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ne</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span> <span class="ow">is</span> <span class="kc">False</span> <span class="ow">and</span> \
                        <span class="nb">bool</span><span class="p">(</span><span class="n">intersect_context_map</span><span class="p">[</span><span class="n">ne</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ne</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                            <span class="n">intersect_context_map</span><span class="p">[</span><span class="n">ne</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ne</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="n">new_tmp_intersect_context_nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ne</span><span class="p">)</span>
                <span class="n">tmp_intersect_context_nodes</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">tmp_intersect_context_nodes</span> <span class="o">=</span> <span class="n">new_tmp_intersect_context_nodes</span>

            <span class="n">new_tmp_mask_nodes</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">new_tmp_mask_nodes</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">tmp_mask_nodes</span><span class="p">:</span>
                <span class="n">four_nes</span> <span class="o">=</span> <span class="p">{</span><span class="n">xx</span><span class="p">:[]</span> <span class="k">for</span> <span class="n">xx</span> <span class="ow">in</span> <span class="p">[(</span><span class="n">node</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">node</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="p">(</span><span class="n">node</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">node</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="p">(</span><span class="n">node</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">node</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="n">node</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">node</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span> <span class="k">if</span> \
                            <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">xx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">connect_map</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">xx</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">connect_map</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]}</span>
                <span class="k">if</span> <span class="n">inpaint_iter</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">ne</span> <span class="ow">in</span> <span class="n">four_nes</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="k">if</span> <span class="n">connect_map</span><span class="p">[</span><span class="n">ne</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ne</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                            <span class="n">tmp_context_nodes</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">ne</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ne</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">connect_map</span><span class="p">[</span><span class="n">ne</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ne</span><span class="p">[</span><span class="mi">1</span><span class="p">]]))</span>
                            <span class="n">context_map</span><span class="p">[</span><span class="n">ne</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ne</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">nes</span> <span class="o">=</span> <span class="n">mesh</span><span class="o">.</span><span class="n">neighbors</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">inpaint_iter</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">ne</span> <span class="ow">in</span> <span class="n">nes</span><span class="p">:</span> <span class="n">four_nes</span><span class="p">[(</span><span class="n">ne</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ne</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ne</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                    <span class="n">nes</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">kfne</span><span class="p">,</span> <span class="n">vfnes</span> <span class="ow">in</span> <span class="n">four_nes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span> <span class="n">vfnes</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">xx</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="n">xx</span><span class="p">),</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">kfne</span><span class="p">,</span> <span class="n">vfnes</span> <span class="ow">in</span> <span class="n">four_nes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="k">for</span> <span class="n">vfne</span> <span class="ow">in</span> <span class="n">vfnes</span><span class="p">:</span> <span class="n">nes</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">kfne</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">kfne</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">vfne</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">ne</span> <span class="ow">in</span> <span class="n">nes</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">bool</span><span class="p">(</span><span class="n">context_map</span><span class="p">[</span><span class="n">ne</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ne</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span> <span class="ow">is</span> <span class="kc">False</span> <span class="ow">and</span> \
                       <span class="nb">bool</span><span class="p">(</span><span class="n">mask_map</span><span class="p">[</span><span class="n">ne</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ne</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span> <span class="ow">is</span> <span class="kc">False</span> <span class="ow">and</span> \
                       <span class="nb">bool</span><span class="p">(</span><span class="n">forbidden_map</span><span class="p">[</span><span class="n">ne</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ne</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">and</span> \
                       <span class="nb">bool</span><span class="p">(</span><span class="n">intouched_map</span><span class="p">[</span><span class="n">ne</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ne</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span> <span class="ow">is</span> <span class="kc">False</span> <span class="ow">and</span> \
                       <span class="nb">bool</span><span class="p">(</span><span class="n">intersect_map</span><span class="p">[</span><span class="n">ne</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ne</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span> <span class="ow">is</span> <span class="kc">False</span> <span class="ow">and</span> \
                       <span class="nb">bool</span><span class="p">(</span><span class="n">intersect_context_map</span><span class="p">[</span><span class="n">ne</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ne</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">passive_background</span> <span class="ow">and</span> <span class="n">inpaint_iter</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">context_map</span><span class="p">[</span><span class="nb">max</span><span class="p">(</span><span class="n">ne</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span><span class="nb">min</span><span class="p">(</span><span class="n">ne</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;H&#39;</span><span class="p">]),</span> <span class="nb">max</span><span class="p">(</span><span class="n">ne</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span><span class="nb">min</span><span class="p">(</span><span class="n">ne</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">])])</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                                <span class="n">intersect_map</span><span class="p">[</span><span class="n">ne</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ne</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">True</span>
                                <span class="n">tmp_intersect_nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ne</span><span class="p">)</span>
                                <span class="k">continue</span>
                        <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">background_thickness</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">inpaint_iter</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="n">cur_mask_cc</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ne</span><span class="p">)</span>
                            <span class="k">elif</span> <span class="n">mesh_nodes</span><span class="p">[</span><span class="n">ne</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;inpaint_id&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                                <span class="n">cur_mask_cc</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ne</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="k">continue</span>
                            <span class="n">mask_ccs</span><span class="p">[</span><span class="n">edge_id</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">ne</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">inpaint_iter</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">comp_cnt_depth</span><span class="p">[</span><span class="n">node</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">node</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">comp_cnt_depth</span><span class="p">[</span><span class="n">ne</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ne</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                    <span class="n">comp_cnt_depth</span><span class="p">[</span><span class="n">ne</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ne</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">comp_cnt_depth</span><span class="p">[</span><span class="n">node</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">node</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
                                <span class="k">if</span> <span class="n">mesh_nodes</span><span class="p">[</span><span class="n">ne</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;far&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                    <span class="k">for</span> <span class="n">comp_far_node</span> <span class="ow">in</span> <span class="n">mesh_nodes</span><span class="p">[</span><span class="n">ne</span><span class="p">][</span><span class="s1">&#39;far&#39;</span><span class="p">]:</span>
                                        <span class="n">cur_comp_far_cc</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">comp_far_node</span><span class="p">)</span>
                                        <span class="n">cur_accomp_near_cc</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ne</span><span class="p">)</span>
                                        <span class="n">cur_invalid_extend_edge_cc</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">comp_far_node</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">mesh_nodes</span><span class="p">[</span><span class="n">ne</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;edge_id&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> \
                                    <span class="nb">len</span><span class="p">(</span><span class="n">context_ccs</span><span class="p">[</span><span class="n">mesh_nodes</span><span class="p">[</span><span class="n">ne</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;edge_id&#39;</span><span class="p">)])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                                    <span class="n">intouched_fars</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">mesh_nodes</span><span class="p">[</span><span class="n">ne</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;far&#39;</span><span class="p">))</span> <span class="k">if</span> <span class="n">mesh_nodes</span><span class="p">[</span><span class="n">ne</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;far&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">set</span><span class="p">()</span>
                                    <span class="n">accum_intouched_fars</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">intouched_fars</span><span class="p">)</span>
                                    <span class="k">for</span> <span class="n">intouched_far</span> <span class="ow">in</span> <span class="n">intouched_fars</span><span class="p">:</span>
                                        <span class="n">accum_intouched_fars</span> <span class="o">|=</span> <span class="nb">set</span><span class="p">([</span><span class="o">*</span><span class="n">mesh</span><span class="o">.</span><span class="n">neighbors</span><span class="p">(</span><span class="n">intouched_far</span><span class="p">)])</span>
                                    <span class="k">for</span> <span class="n">intouched_far</span> <span class="ow">in</span> <span class="n">accum_intouched_fars</span><span class="p">:</span>
                                        <span class="k">if</span> <span class="nb">bool</span><span class="p">(</span><span class="n">mask_map</span><span class="p">[</span><span class="n">intouched_far</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">intouched_far</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">or</span> \
                                        <span class="nb">bool</span><span class="p">(</span><span class="n">context_map</span><span class="p">[</span><span class="n">intouched_far</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">intouched_far</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                                            <span class="k">continue</span>
                                        <span class="n">tmp_redundant_nodes</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">intouched_far</span><span class="p">)</span>
                                        <span class="n">intouched_map</span><span class="p">[</span><span class="n">intouched_far</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">intouched_far</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">True</span>
                                <span class="k">if</span> <span class="n">mesh_nodes</span><span class="p">[</span><span class="n">ne</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;near&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                    <span class="n">intouched_nears</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">mesh_nodes</span><span class="p">[</span><span class="n">ne</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;near&#39;</span><span class="p">))</span>
                                    <span class="k">for</span> <span class="n">intouched_near</span> <span class="ow">in</span> <span class="n">intouched_nears</span><span class="p">:</span>
                                        <span class="k">if</span> <span class="nb">bool</span><span class="p">(</span><span class="n">mask_map</span><span class="p">[</span><span class="n">intouched_near</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">intouched_near</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">or</span> \
                                        <span class="nb">bool</span><span class="p">(</span><span class="n">context_map</span><span class="p">[</span><span class="n">intouched_near</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">intouched_near</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                                            <span class="k">continue</span>
                                        <span class="n">tmp_redundant_nodes</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">intouched_near</span><span class="p">)</span>
                                        <span class="n">intouched_map</span><span class="p">[</span><span class="n">intouched_near</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">intouched_near</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">mesh_nodes</span><span class="p">[</span><span class="n">ne</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;inpaint_id&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">inpaint_iter</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
                            <span class="n">new_tmp_mask_nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ne</span><span class="p">)</span>
                            <span class="n">mask_map</span><span class="p">[</span><span class="n">ne</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ne</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">tmp_mask_nodes</span> <span class="o">=</span> <span class="n">new_tmp_mask_nodes</span>

            <span class="n">new_tmp_context_nodes</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">new_tmp_context_nodes</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">tmp_context_nodes</span><span class="p">:</span>
                <span class="n">nes</span> <span class="o">=</span> <span class="n">mesh</span><span class="o">.</span><span class="n">neighbors</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">inpaint_iter</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">four_nes</span> <span class="o">=</span> <span class="p">{(</span><span class="n">node</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">node</span><span class="p">[</span><span class="mi">1</span><span class="p">]):[],</span> <span class="p">(</span><span class="n">node</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">node</span><span class="p">[</span><span class="mi">1</span><span class="p">]):[],</span> <span class="p">(</span><span class="n">node</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">node</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):[],</span> <span class="p">(</span><span class="n">node</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">node</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):[]}</span>
                    <span class="k">for</span> <span class="n">ne</span> <span class="ow">in</span> <span class="n">nes</span><span class="p">:</span> <span class="n">four_nes</span><span class="p">[(</span><span class="n">ne</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ne</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ne</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                    <span class="n">nes</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">kfne</span><span class="p">,</span> <span class="n">vfnes</span> <span class="ow">in</span> <span class="n">four_nes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span> <span class="n">vfnes</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">xx</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="n">xx</span><span class="p">),</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">kfne</span><span class="p">,</span> <span class="n">vfnes</span> <span class="ow">in</span> <span class="n">four_nes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="k">for</span> <span class="n">vfne</span> <span class="ow">in</span> <span class="n">vfnes</span><span class="p">:</span> <span class="n">nes</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">kfne</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">kfne</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">vfne</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">ne</span> <span class="ow">in</span> <span class="n">nes</span><span class="p">:</span>
                    <span class="n">mask_flag</span> <span class="o">=</span> <span class="p">(</span><span class="nb">bool</span><span class="p">(</span><span class="n">mask_map</span><span class="p">[</span><span class="n">ne</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ne</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">bool</span><span class="p">(</span><span class="n">context_map</span><span class="p">[</span><span class="n">ne</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ne</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span> <span class="ow">is</span> <span class="kc">False</span> <span class="ow">and</span> <span class="n">mask_flag</span> <span class="ow">and</span> \
                       <span class="nb">bool</span><span class="p">(</span><span class="n">forbidden_map</span><span class="p">[</span><span class="n">ne</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ne</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">and</span> <span class="nb">bool</span><span class="p">(</span><span class="n">noncont_map</span><span class="p">[</span><span class="n">ne</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ne</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span> <span class="ow">is</span> <span class="kc">False</span> <span class="ow">and</span> \
                       <span class="nb">bool</span><span class="p">(</span><span class="n">intersect_context_map</span><span class="p">[</span><span class="n">ne</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ne</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">passive_context</span> <span class="ow">and</span> <span class="n">inpaint_iter</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="n">mnes</span> <span class="o">=</span> <span class="n">mesh</span><span class="o">.</span><span class="n">neighbors</span><span class="p">(</span><span class="n">ne</span><span class="p">)</span>
                            <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="n">mask_map</span><span class="p">[</span><span class="n">mne</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">mne</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">==</span> <span class="kc">True</span> <span class="k">for</span> <span class="n">mne</span> <span class="ow">in</span> <span class="n">mnes</span><span class="p">])</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                                <span class="n">intersect_context_map</span><span class="p">[</span><span class="n">ne</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ne</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">True</span>
                                <span class="n">tmp_intersect_context_nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ne</span><span class="p">)</span>
                                <span class="k">continue</span>
                        <span class="k">if</span> <span class="kc">False</span> <span class="ow">and</span> <span class="n">mesh_nodes</span><span class="p">[</span><span class="n">ne</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;near&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">mesh_nodes</span><span class="p">[</span><span class="n">ne</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;edge_id&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="n">edge_id</span><span class="p">:</span>
                            <span class="n">noncont_nears</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">mesh_nodes</span><span class="p">[</span><span class="n">ne</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;near&#39;</span><span class="p">))</span>
                            <span class="k">for</span> <span class="n">noncont_near</span> <span class="ow">in</span> <span class="n">noncont_nears</span><span class="p">:</span>
                                <span class="k">if</span> <span class="nb">bool</span><span class="p">(</span><span class="n">context_map</span><span class="p">[</span><span class="n">noncont_near</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">noncont_near</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                                    <span class="n">tmp_noncont_nodes</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">noncont_near</span><span class="p">)</span>
                                    <span class="n">noncont_map</span><span class="p">[</span><span class="n">noncont_near</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">noncont_near</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">new_tmp_context_nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ne</span><span class="p">)</span>
                        <span class="n">context_map</span><span class="p">[</span><span class="n">ne</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ne</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">context_depth</span><span class="p">[</span><span class="n">ne</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ne</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">ne</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">cur_context_cc</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">new_tmp_context_nodes</span><span class="p">)</span>
            <span class="n">tmp_erode</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_tmp_context_nodes</span><span class="p">)</span>
            <span class="n">tmp_context_nodes</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">tmp_context_nodes</span> <span class="o">=</span> <span class="n">new_tmp_context_nodes</span>
            <span class="n">new_tmp_intouched_nodes</span> <span class="o">=</span> <span class="kc">None</span><span class="p">;</span> <span class="n">new_tmp_intouched_nodes</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">tmp_intouched_nodes</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">bool</span><span class="p">(</span><span class="n">context_map</span><span class="p">[</span><span class="n">node</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">node</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">or</span> <span class="nb">bool</span><span class="p">(</span><span class="n">mask_map</span><span class="p">[</span><span class="n">node</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">node</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">nes</span> <span class="o">=</span> <span class="n">mesh</span><span class="o">.</span><span class="n">neighbors</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">ne</span> <span class="ow">in</span> <span class="n">nes</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">bool</span><span class="p">(</span><span class="n">context_map</span><span class="p">[</span><span class="n">ne</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ne</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span> <span class="ow">is</span> <span class="kc">False</span> <span class="ow">and</span> \
                       <span class="nb">bool</span><span class="p">(</span><span class="n">mask_map</span><span class="p">[</span><span class="n">ne</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ne</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span> <span class="ow">is</span> <span class="kc">False</span> <span class="ow">and</span> \
                       <span class="nb">bool</span><span class="p">(</span><span class="n">intouched_map</span><span class="p">[</span><span class="n">ne</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ne</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span> <span class="ow">is</span> <span class="kc">False</span> <span class="ow">and</span> \
                       <span class="nb">bool</span><span class="p">(</span><span class="n">forbidden_map</span><span class="p">[</span><span class="n">ne</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ne</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                        <span class="n">new_tmp_intouched_nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ne</span><span class="p">)</span>
                        <span class="n">intouched_map</span><span class="p">[</span><span class="n">ne</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ne</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">tmp_intouched_nodes</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">tmp_intouched_nodes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">new_tmp_intouched_nodes</span><span class="p">)</span>
            <span class="n">new_tmp_redundant_nodes</span> <span class="o">=</span> <span class="kc">None</span><span class="p">;</span> <span class="n">new_tmp_redundant_nodes</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">tmp_redundant_nodes</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">bool</span><span class="p">(</span><span class="n">context_map</span><span class="p">[</span><span class="n">node</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">node</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">or</span> \
                   <span class="nb">bool</span><span class="p">(</span><span class="n">mask_map</span><span class="p">[</span><span class="n">node</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">node</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">nes</span> <span class="o">=</span> <span class="n">mesh</span><span class="o">.</span><span class="n">neighbors</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">ne</span> <span class="ow">in</span> <span class="n">nes</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">bool</span><span class="p">(</span><span class="n">context_map</span><span class="p">[</span><span class="n">ne</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ne</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span> <span class="ow">is</span> <span class="kc">False</span> <span class="ow">and</span> \
                       <span class="nb">bool</span><span class="p">(</span><span class="n">mask_map</span><span class="p">[</span><span class="n">ne</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ne</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span> <span class="ow">is</span> <span class="kc">False</span> <span class="ow">and</span> \
                       <span class="nb">bool</span><span class="p">(</span><span class="n">intouched_map</span><span class="p">[</span><span class="n">ne</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ne</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span> <span class="ow">is</span> <span class="kc">False</span> <span class="ow">and</span> \
                       <span class="nb">bool</span><span class="p">(</span><span class="n">forbidden_map</span><span class="p">[</span><span class="n">ne</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ne</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                        <span class="n">new_tmp_redundant_nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ne</span><span class="p">)</span>
                        <span class="n">intouched_map</span><span class="p">[</span><span class="n">ne</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ne</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">tmp_redundant_nodes</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">tmp_redundant_nodes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">new_tmp_redundant_nodes</span><span class="p">)</span>
            <span class="n">new_tmp_noncont_nodes</span> <span class="o">=</span> <span class="kc">None</span><span class="p">;</span> <span class="n">new_tmp_noncont_nodes</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">tmp_noncont_nodes</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">bool</span><span class="p">(</span><span class="n">context_map</span><span class="p">[</span><span class="n">node</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">node</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">or</span> \
                   <span class="nb">bool</span><span class="p">(</span><span class="n">mask_map</span><span class="p">[</span><span class="n">node</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">node</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">nes</span> <span class="o">=</span> <span class="n">mesh</span><span class="o">.</span><span class="n">neighbors</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
                <span class="n">rmv_flag</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">for</span> <span class="n">ne</span> <span class="ow">in</span> <span class="n">nes</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">bool</span><span class="p">(</span><span class="n">context_map</span><span class="p">[</span><span class="n">ne</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ne</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span> <span class="ow">is</span> <span class="kc">False</span> <span class="ow">and</span> \
                       <span class="nb">bool</span><span class="p">(</span><span class="n">mask_map</span><span class="p">[</span><span class="n">ne</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ne</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span> <span class="ow">is</span> <span class="kc">False</span> <span class="ow">and</span> \
                       <span class="nb">bool</span><span class="p">(</span><span class="n">noncont_map</span><span class="p">[</span><span class="n">ne</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ne</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span> <span class="ow">is</span> <span class="kc">False</span> <span class="ow">and</span> \
                       <span class="nb">bool</span><span class="p">(</span><span class="n">forbidden_map</span><span class="p">[</span><span class="n">ne</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ne</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                        <span class="n">patch_context_map</span> <span class="o">=</span> <span class="n">context_map</span><span class="p">[</span><span class="nb">max</span><span class="p">(</span><span class="n">ne</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span><span class="nb">min</span><span class="p">(</span><span class="n">ne</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">context_map</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                                                        <span class="nb">max</span><span class="p">(</span><span class="n">ne</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span><span class="nb">min</span><span class="p">(</span><span class="n">ne</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">context_map</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>
                        <span class="k">if</span> <span class="nb">bool</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">patch_context_map</span><span class="p">))</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                            <span class="n">new_tmp_noncont_nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ne</span><span class="p">)</span>
                            <span class="n">noncont_map</span><span class="p">[</span><span class="n">ne</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ne</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">tmp_noncont_nodes</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">tmp_noncont_nodes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">new_tmp_noncont_nodes</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">inpaint_iter</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">depth_dict</span> <span class="o">=</span> <span class="n">get_depth_from_maps</span><span class="p">(</span><span class="n">context_map</span><span class="p">,</span> <span class="n">mask_map</span><span class="p">,</span> <span class="n">context_depth</span><span class="p">,</span> <span class="n">mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;H&#39;</span><span class="p">],</span> <span class="n">mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">],</span> <span class="n">log_depth</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;log_depth&#39;</span><span class="p">])</span>
            <span class="n">mask_size</span> <span class="o">=</span> <span class="n">get_valid_size</span><span class="p">(</span><span class="n">depth_dict</span><span class="p">[</span><span class="s1">&#39;mask&#39;</span><span class="p">])</span>
            <span class="n">mask_size</span> <span class="o">=</span> <span class="n">dilate_valid_size</span><span class="p">(</span><span class="n">mask_size</span><span class="p">,</span> <span class="n">depth_dict</span><span class="p">[</span><span class="s1">&#39;mask&#39;</span><span class="p">],</span> <span class="n">dilate</span><span class="o">=</span><span class="p">[</span><span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">])</span>
            <span class="n">context_size</span> <span class="o">=</span> <span class="n">get_valid_size</span><span class="p">(</span><span class="n">depth_dict</span><span class="p">[</span><span class="s1">&#39;context&#39;</span><span class="p">])</span>
            <span class="n">context_size</span> <span class="o">=</span> <span class="n">dilate_valid_size</span><span class="p">(</span><span class="n">context_size</span><span class="p">,</span> <span class="n">depth_dict</span><span class="p">[</span><span class="s1">&#39;context&#39;</span><span class="p">],</span> <span class="n">dilate</span><span class="o">=</span><span class="p">[</span><span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">])</span>
            <span class="n">union_size</span> <span class="o">=</span> <span class="n">size_operation</span><span class="p">(</span><span class="n">mask_size</span><span class="p">,</span> <span class="n">context_size</span><span class="p">,</span> <span class="n">operation</span><span class="o">=</span><span class="s1">&#39;+&#39;</span><span class="p">)</span>
            <span class="n">depth_dict</span> <span class="o">=</span> <span class="n">depth_inpainting</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">mesh</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">union_size</span><span class="p">,</span> <span class="n">depth_feat_model</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">given_depth_dict</span><span class="o">=</span><span class="n">depth_dict</span><span class="p">,</span> <span class="n">spdb</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">near_depth_map</span><span class="p">,</span> <span class="n">raw_near_depth_map</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;H&#39;</span><span class="p">],</span> <span class="n">mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">])),</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;H&#39;</span><span class="p">],</span> <span class="n">mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]))</span>
            <span class="n">filtered_comp_far_cc</span><span class="p">,</span> <span class="n">filtered_accomp_near_cc</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(),</span> <span class="nb">set</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">cur_accomp_near_cc</span><span class="p">:</span>
                <span class="n">near_depth_map</span><span class="p">[</span><span class="n">node</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">node</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">depth_dict</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">][</span><span class="n">node</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">node</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
                <span class="n">raw_near_depth_map</span><span class="p">[</span><span class="n">node</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">node</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">node</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">cur_comp_far_cc</span><span class="p">:</span>
                <span class="n">four_nes</span> <span class="o">=</span> <span class="p">[</span><span class="n">xx</span> <span class="k">for</span> <span class="n">xx</span> <span class="ow">in</span> <span class="p">[(</span><span class="n">node</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">node</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="p">(</span><span class="n">node</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">node</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="p">(</span><span class="n">node</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">node</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="n">node</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">node</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span> \
                            <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">xx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;H&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">xx</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span> <span class="ow">and</span> \
                            <span class="n">near_depth_map</span><span class="p">[</span><span class="n">xx</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">xx</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> \
                            <span class="nb">abs</span><span class="p">(</span><span class="n">near_depth_map</span><span class="p">[</span><span class="n">xx</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">xx</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span> <span class="o">&lt;</span> <span class="nb">abs</span><span class="p">(</span><span class="n">node</span><span class="p">[</span><span class="mi">2</span><span class="p">])]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">four_nes</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">filtered_comp_far_cc</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">ne</span> <span class="ow">in</span> <span class="n">four_nes</span><span class="p">:</span>
                    <span class="n">filtered_accomp_near_cc</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">ne</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ne</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="o">-</span><span class="nb">abs</span><span class="p">(</span><span class="n">raw_near_depth_map</span><span class="p">[</span><span class="n">ne</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ne</span><span class="p">[</span><span class="mi">1</span><span class="p">]])))</span>
            <span class="n">cur_comp_far_cc</span><span class="p">,</span> <span class="n">cur_accomp_near_cc</span> <span class="o">=</span> <span class="n">filtered_comp_far_cc</span><span class="p">,</span> <span class="n">filtered_accomp_near_cc</span>
        <span class="n">mask_ccs</span><span class="p">[</span><span class="n">edge_id</span><span class="p">]</span> <span class="o">|=</span> <span class="nb">set</span><span class="p">(</span><span class="n">cur_mask_cc</span><span class="p">)</span>
        <span class="n">context_ccs</span><span class="p">[</span><span class="n">edge_id</span><span class="p">]</span> <span class="o">|=</span> <span class="nb">set</span><span class="p">(</span><span class="n">cur_context_cc</span><span class="p">)</span>
        <span class="n">accomp_extend_context_ccs</span><span class="p">[</span><span class="n">edge_id</span><span class="p">]</span> <span class="o">|=</span> <span class="nb">set</span><span class="p">(</span><span class="n">cur_accomp_near_cc</span><span class="p">)</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">cur_mask_cc</span><span class="p">)</span>
        <span class="n">extend_edge_ccs</span><span class="p">[</span><span class="n">edge_id</span><span class="p">]</span> <span class="o">|=</span> <span class="nb">set</span><span class="p">(</span><span class="n">cur_accomp_near_cc</span><span class="p">)</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">cur_mask_cc</span><span class="p">)</span>
        <span class="n">extend_context_ccs</span><span class="p">[</span><span class="n">edge_id</span><span class="p">]</span> <span class="o">|=</span> <span class="nb">set</span><span class="p">(</span><span class="n">cur_comp_far_cc</span><span class="p">)</span>
        <span class="n">invalid_extend_edge_ccs</span><span class="p">[</span><span class="n">edge_id</span><span class="p">]</span> <span class="o">|=</span> <span class="nb">set</span><span class="p">(</span><span class="n">cur_invalid_extend_edge_cc</span><span class="p">)</span>
        <span class="n">erode_size</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">tmp</span> <span class="ow">in</span> <span class="n">tmp_erode</span><span class="p">:</span>
            <span class="n">erode_size</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tmp</span><span class="p">))</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">erode_size</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">erode_size</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">erode_size</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">inpaint_iter</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">tmp_width</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;depth_edge_dilate&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tmp_width</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="nb">float</span><span class="p">(</span><span class="n">erode_size</span><span class="p">[</span><span class="n">tmp_width</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">erode_size</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mf">1e-6</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.3</span><span class="p">:</span>
            <span class="n">tmp_width</span> <span class="o">=</span> <span class="n">tmp_width</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">tmp_width</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">erode_context_ccs</span><span class="p">[</span><span class="n">edge_id</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">erode_context_ccs</span><span class="p">[</span><span class="n">edge_id</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">reduce</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="p">:</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span><span class="p">,</span> <span class="p">[]</span> <span class="o">+</span> <span class="n">tmp_erode</span><span class="p">[:</span><span class="n">tmp_width</span><span class="p">]))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">pdb</span><span class="p">;</span> <span class="n">pdb</span><span class="o">.</span><span class="n">set_trace</span><span class="p">()</span>
        <span class="n">erode_context_cc</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">erode_context_ccs</span><span class="p">[</span><span class="n">edge_id</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">erode_context_node</span> <span class="ow">in</span> <span class="n">erode_context_cc</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">inpaint_iter</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="p">(</span><span class="n">mesh_nodes</span><span class="p">[</span><span class="n">erode_context_node</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;inpaint_id&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span>
                                        <span class="n">mesh_nodes</span><span class="p">[</span><span class="n">erode_context_node</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;inpaint_id&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)):</span>
                <span class="n">erode_context_ccs</span><span class="p">[</span><span class="n">edge_id</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">erode_context_node</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">context_ccs</span><span class="p">[</span><span class="n">edge_id</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">erode_context_node</span><span class="p">)</span>
        <span class="n">context_map</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;H&#39;</span><span class="p">],</span> <span class="n">mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]))</span>
        <span class="k">for</span> <span class="n">context_node</span> <span class="ow">in</span> <span class="n">context_ccs</span><span class="p">[</span><span class="n">edge_id</span><span class="p">]:</span>
            <span class="n">context_map</span><span class="p">[</span><span class="n">context_node</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">context_node</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">extend_context_ccs</span><span class="p">[</span><span class="n">edge_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">extend_context_ccs</span><span class="p">[</span><span class="n">edge_id</span><span class="p">]</span> <span class="o">-</span> <span class="n">mask_ccs</span><span class="p">[</span><span class="n">edge_id</span><span class="p">]</span> <span class="o">-</span> <span class="n">accomp_extend_context_ccs</span><span class="p">[</span><span class="n">edge_id</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">inpaint_iter</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">all_ecnt_cc</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">ecnt_id</span><span class="p">,</span> <span class="n">ecnt_cc</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">extend_context_ccs</span><span class="p">):</span>
            <span class="n">constraint_context_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="n">constraint_context_cc</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="n">constraint_erode_context_cc</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="n">tmp_mask_cc</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="n">accum_context_cc</span> <span class="o">=</span> <span class="kc">None</span><span class="p">;</span> <span class="n">accum_context_cc</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">ecnt_node</span> <span class="ow">in</span> <span class="n">accomp_extend_context_ccs</span><span class="p">[</span><span class="n">ecnt_id</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">edge_maps</span><span class="p">[</span><span class="n">ecnt_node</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ecnt_node</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">constraint_context_ids</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">edge_maps</span><span class="p">[</span><span class="n">ecnt_node</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ecnt_node</span><span class="p">[</span><span class="mi">1</span><span class="p">]])))</span>
            <span class="n">constraint_erode_context_cc</span> <span class="o">=</span> <span class="n">erode_context_ccs</span><span class="p">[</span><span class="n">ecnt_id</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">constraint_context_id</span> <span class="ow">in</span> <span class="n">constraint_context_ids</span><span class="p">:</span>
                <span class="n">constraint_context_cc</span> <span class="o">=</span> <span class="n">constraint_context_cc</span> <span class="o">|</span> <span class="n">context_ccs</span><span class="p">[</span><span class="n">constraint_context_id</span><span class="p">]</span> <span class="o">|</span> <span class="n">erode_context_ccs</span><span class="p">[</span><span class="n">constraint_context_id</span><span class="p">]</span>
                <span class="n">constraint_erode_context_cc</span> <span class="o">=</span> <span class="n">constraint_erode_context_cc</span> <span class="o">|</span> <span class="n">erode_context_ccs</span><span class="p">[</span><span class="n">constraint_context_id</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">background_thickness</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">tmp_context_nodes</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">ecnt_cc</span><span class="p">)</span>
                    <span class="n">tmp_invalid_context_nodes</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">invalid_extend_edge_ccs</span><span class="p">[</span><span class="n">ecnt_id</span><span class="p">])</span>
                    <span class="n">tmp_mask_nodes</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">accomp_extend_context_ccs</span><span class="p">[</span><span class="n">ecnt_id</span><span class="p">])</span>
                    <span class="n">tmp_context_map</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;H&#39;</span><span class="p">],</span> <span class="n">mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">bool</span><span class="p">)</span>
                    <span class="n">tmp_mask_map</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;H&#39;</span><span class="p">],</span> <span class="n">mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">bool</span><span class="p">)</span>
                    <span class="n">tmp_invalid_context_map</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;H&#39;</span><span class="p">],</span> <span class="n">mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">bool</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">tmp_mask_nodes</span><span class="p">:</span>
                        <span class="n">tmp_mask_map</span><span class="p">[</span><span class="n">node</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">node</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">context_ccs</span><span class="p">[</span><span class="n">ecnt_id</span><span class="p">]:</span>
                        <span class="n">tmp_context_map</span><span class="p">[</span><span class="n">node</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">node</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">erode_context_ccs</span><span class="p">[</span><span class="n">ecnt_id</span><span class="p">]:</span>
                        <span class="n">tmp_context_map</span><span class="p">[</span><span class="n">node</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">node</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">extend_context_ccs</span><span class="p">[</span><span class="n">ecnt_id</span><span class="p">]:</span>
                        <span class="n">tmp_context_map</span><span class="p">[</span><span class="n">node</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">node</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">invalid_extend_edge_ccs</span><span class="p">[</span><span class="n">ecnt_id</span><span class="p">]:</span>
                        <span class="n">tmp_invalid_context_map</span><span class="p">[</span><span class="n">node</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">node</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">init_invalid_context_map</span> <span class="o">=</span> <span class="n">tmp_invalid_context_map</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                    <span class="n">init_context_map</span> <span class="o">=</span> <span class="n">tmp</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">tmp_mask_map</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span> <span class="o">*</span> <span class="n">tmp_context_map</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">))</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="kn">import</span> <span class="nn">pdb</span><span class="p">;</span> <span class="n">pdb</span><span class="o">.</span><span class="n">set_trace</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">vis_edge_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">ecnt_id</span> <span class="o">==</span> <span class="n">vis_edge_id</span><span class="p">:</span>
                        <span class="n">f</span><span class="p">,</span> <span class="p">((</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">))</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                        <span class="n">ax1</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">tmp_context_map</span> <span class="o">*</span> <span class="mi">1</span><span class="p">);</span> <span class="n">ax2</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">init_invalid_context_map</span> <span class="o">*</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">tmp_context_map</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
                        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
                        <span class="kn">import</span> <span class="nn">pdb</span><span class="p">;</span> <span class="n">pdb</span><span class="o">.</span><span class="n">set_trace</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">tmp_context_nodes</span> <span class="o">=</span> <span class="n">new_tmp_context_nodes</span>
                    <span class="n">new_tmp_context_nodes</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">tmp_mask_nodes</span> <span class="o">=</span> <span class="n">new_tmp_mask_nodes</span>
                    <span class="n">new_tmp_mask_nodes</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">tmp_invalid_context_nodes</span> <span class="o">=</span> <span class="n">new_tmp_invalid_context_nodes</span>
                    <span class="n">new_tmp_invalid_context_nodes</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">new_tmp_context_nodes</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">new_tmp_context_nodes</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">new_tmp_invalid_context_nodes</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">new_tmp_invalid_context_nodes</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">new_tmp_mask_nodes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([])</span>
                <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">tmp_context_nodes</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">ne</span> <span class="ow">in</span> <span class="n">mesh</span><span class="o">.</span><span class="n">neighbors</span><span class="p">(</span><span class="n">node</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">ne</span> <span class="ow">in</span> <span class="n">constraint_context_cc</span> <span class="ow">and</span> \
                            <span class="nb">bool</span><span class="p">(</span><span class="n">tmp_mask_map</span><span class="p">[</span><span class="n">ne</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ne</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span> <span class="ow">is</span> <span class="kc">False</span> <span class="ow">and</span> \
                            <span class="nb">bool</span><span class="p">(</span><span class="n">tmp_context_map</span><span class="p">[</span><span class="n">ne</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ne</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span> <span class="ow">is</span> <span class="kc">False</span> <span class="ow">and</span> \
                            <span class="nb">bool</span><span class="p">(</span><span class="n">forbidden_map</span><span class="p">[</span><span class="n">ne</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ne</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                            <span class="n">new_tmp_context_nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ne</span><span class="p">)</span>
                            <span class="n">tmp_context_map</span><span class="p">[</span><span class="n">ne</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ne</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">accum_context_cc</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">new_tmp_context_nodes</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">tmp_invalid_context_nodes</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">ne</span> <span class="ow">in</span> <span class="n">mesh</span><span class="o">.</span><span class="n">neighbors</span><span class="p">(</span><span class="n">node</span><span class="p">):</span>
                        <span class="k">if</span> <span class="nb">bool</span><span class="p">(</span><span class="n">tmp_mask_map</span><span class="p">[</span><span class="n">ne</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ne</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span> <span class="ow">is</span> <span class="kc">False</span> <span class="ow">and</span> \
                           <span class="nb">bool</span><span class="p">(</span><span class="n">tmp_context_map</span><span class="p">[</span><span class="n">ne</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ne</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span> <span class="ow">is</span> <span class="kc">False</span> <span class="ow">and</span> \
                           <span class="nb">bool</span><span class="p">(</span><span class="n">tmp_invalid_context_map</span><span class="p">[</span><span class="n">ne</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ne</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span> <span class="ow">is</span> <span class="kc">False</span> <span class="ow">and</span> \
                           <span class="nb">bool</span><span class="p">(</span><span class="n">forbidden_map</span><span class="p">[</span><span class="n">ne</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ne</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                            <span class="n">tmp_invalid_context_map</span><span class="p">[</span><span class="n">ne</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ne</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="n">new_tmp_invalid_context_nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ne</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">tmp_mask_nodes</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">ne</span> <span class="ow">in</span> <span class="n">mesh</span><span class="o">.</span><span class="n">neighbors</span><span class="p">(</span><span class="n">node</span><span class="p">):</span>
                        <span class="k">if</span> <span class="nb">bool</span><span class="p">(</span><span class="n">tmp_mask_map</span><span class="p">[</span><span class="n">ne</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ne</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span> <span class="ow">is</span> <span class="kc">False</span> <span class="ow">and</span> \
                           <span class="nb">bool</span><span class="p">(</span><span class="n">tmp_context_map</span><span class="p">[</span><span class="n">ne</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ne</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span> <span class="ow">is</span> <span class="kc">False</span> <span class="ow">and</span> \
                           <span class="nb">bool</span><span class="p">(</span><span class="n">tmp_invalid_context_map</span><span class="p">[</span><span class="n">ne</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ne</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span> <span class="ow">is</span> <span class="kc">False</span> <span class="ow">and</span> \
                           <span class="nb">bool</span><span class="p">(</span><span class="n">forbidden_map</span><span class="p">[</span><span class="n">ne</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ne</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                            <span class="n">new_tmp_mask_nodes</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">ne</span><span class="p">)</span>
                            <span class="n">tmp_mask_map</span><span class="p">[</span><span class="n">ne</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ne</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">init_invalid_context_map</span><span class="p">[</span><span class="n">tmp_context_map</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">tmp_label_map</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">connectedComponents</span><span class="p">((</span><span class="n">init_invalid_context_map</span> <span class="o">|</span> <span class="n">tmp_context_map</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">),</span> <span class="n">connectivity</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
            <span class="n">tmp_label_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">tmp_label_map</span><span class="p">[</span><span class="n">init_invalid_context_map</span><span class="p">]))</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">tmp_mask_map</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span> <span class="o">*</span> <span class="n">tmp_context_map</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">))</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="kn">import</span> <span class="nn">pdb</span><span class="p">;</span> <span class="n">pdb</span><span class="o">.</span><span class="n">set_trace</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">vis_edge_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">ecnt_id</span> <span class="o">==</span> <span class="n">vis_edge_id</span><span class="p">:</span>
                <span class="n">f</span><span class="p">,</span> <span class="p">((</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">))</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">ax1</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">tmp_label_map</span><span class="p">);</span> <span class="n">ax2</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">init_invalid_context_map</span> <span class="o">*</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">tmp_context_map</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
                <span class="kn">import</span> <span class="nn">pdb</span><span class="p">;</span> <span class="n">pdb</span><span class="o">.</span><span class="n">set_trace</span><span class="p">()</span>
            <span class="n">extend_context_ccs</span><span class="p">[</span><span class="n">ecnt_id</span><span class="p">]</span> <span class="o">|=</span> <span class="nb">set</span><span class="p">(</span><span class="n">accum_context_cc</span><span class="p">)</span>
            <span class="n">extend_context_ccs</span><span class="p">[</span><span class="n">ecnt_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">extend_context_ccs</span><span class="p">[</span><span class="n">ecnt_id</span><span class="p">]</span> <span class="o">-</span> <span class="n">mask_ccs</span><span class="p">[</span><span class="n">ecnt_id</span><span class="p">]</span>
            <span class="n">extend_erode_context_ccs</span><span class="p">[</span><span class="n">ecnt_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">extend_context_ccs</span><span class="p">[</span><span class="n">ecnt_id</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">constraint_erode_context_cc</span>
            <span class="n">extend_context_ccs</span><span class="p">[</span><span class="n">ecnt_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">extend_context_ccs</span><span class="p">[</span><span class="n">ecnt_id</span><span class="p">]</span> <span class="o">-</span> <span class="n">extend_erode_context_ccs</span><span class="p">[</span><span class="n">ecnt_id</span><span class="p">]</span> <span class="o">-</span> <span class="n">erode_context_ccs</span><span class="p">[</span><span class="n">ecnt_id</span><span class="p">]</span>
            <span class="n">tmp_context_cc</span> <span class="o">=</span> <span class="n">context_ccs</span><span class="p">[</span><span class="n">ecnt_id</span><span class="p">]</span> <span class="o">-</span> <span class="n">extend_erode_context_ccs</span><span class="p">[</span><span class="n">ecnt_id</span><span class="p">]</span> <span class="o">-</span> <span class="n">erode_context_ccs</span><span class="p">[</span><span class="n">ecnt_id</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tmp_context_cc</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">context_ccs</span><span class="p">[</span><span class="n">ecnt_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp_context_cc</span>
            <span class="n">tmp_mask_cc</span> <span class="o">=</span> <span class="n">tmp_mask_cc</span> <span class="o">-</span> <span class="n">context_ccs</span><span class="p">[</span><span class="n">ecnt_id</span><span class="p">]</span> <span class="o">-</span> <span class="n">erode_context_ccs</span><span class="p">[</span><span class="n">ecnt_id</span><span class="p">]</span>
            <span class="n">mask_ccs</span><span class="p">[</span><span class="n">ecnt_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">mask_ccs</span><span class="p">[</span><span class="n">ecnt_id</span><span class="p">]</span> <span class="o">|</span> <span class="n">tmp_mask_cc</span>

    <span class="k">return</span> <span class="n">context_ccs</span><span class="p">,</span> <span class="n">mask_ccs</span><span class="p">,</span> <span class="n">broken_mask_ccs</span><span class="p">,</span> <span class="n">edge_ccs</span><span class="p">,</span> <span class="n">erode_context_ccs</span><span class="p">,</span> <span class="n">invalid_extend_edge_ccs</span><span class="p">,</span> <span class="n">edge_maps</span><span class="p">,</span> <span class="n">extend_context_ccs</span><span class="p">,</span> <span class="n">extend_edge_ccs</span><span class="p">,</span> <span class="n">extend_erode_context_ccs</span>

<span class="k">def</span> <span class="nf">DL_inpaint_edge</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span>
                    <span class="n">info_on_pix</span><span class="p">,</span>
                    <span class="n">config</span><span class="p">,</span>
                    <span class="n">image</span><span class="p">,</span>
                    <span class="n">depth</span><span class="p">,</span>
                    <span class="n">context_ccs</span><span class="p">,</span>
                    <span class="n">erode_context_ccs</span><span class="p">,</span>
                    <span class="n">extend_context_ccs</span><span class="p">,</span>
                    <span class="n">extend_erode_context_ccs</span><span class="p">,</span>
                    <span class="n">mask_ccs</span><span class="p">,</span>
                    <span class="n">broken_mask_ccs</span><span class="p">,</span>
                    <span class="n">edge_ccs</span><span class="p">,</span>
                    <span class="n">extend_edge_ccs</span><span class="p">,</span>
                    <span class="n">init_mask_connect</span><span class="p">,</span>
                    <span class="n">edge_maps</span><span class="p">,</span>
                    <span class="n">rgb_model</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">depth_edge_model</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">depth_edge_model_init</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">depth_feat_model</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">specific_edge_id</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
                    <span class="n">specific_edge_loc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">inpaint_iter</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;gpu_ids&quot;</span><span class="p">],</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;gpu_ids&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">):</span>
        <span class="n">device</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;gpu_ids&quot;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">device</span> <span class="o">=</span> <span class="s2">&quot;cpu&quot;</span>

    <span class="n">edge_map</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">depth</span><span class="p">)</span>
    <span class="n">new_edge_ccs</span> <span class="o">=</span> <span class="p">[</span><span class="nb">set</span><span class="p">()</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">edge_ccs</span><span class="p">))]</span>
    <span class="n">edge_maps_with_id</span> <span class="o">=</span> <span class="n">edge_maps</span>
    <span class="n">edge_condition</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">m</span><span class="p">:</span> <span class="n">m</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">x</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;far&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">x</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;far&#39;</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span>
    <span class="n">edge_map</span> <span class="o">=</span> <span class="n">get_map_from_ccs</span><span class="p">(</span><span class="n">edge_ccs</span><span class="p">,</span> <span class="n">mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;H&#39;</span><span class="p">],</span> <span class="n">mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">],</span> <span class="n">mesh</span><span class="p">,</span> <span class="n">edge_condition</span><span class="p">)</span>
    <span class="n">np_depth</span><span class="p">,</span> <span class="n">np_image</span> <span class="o">=</span> <span class="n">depth</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">image</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">image_c</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">depth</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">depth</span> <span class="o">=</span> <span class="n">depth</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
    <span class="n">depth</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">(</span><span class="n">depth</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
    <span class="n">mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;max_edge_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">edge_ccs</span><span class="p">)</span>
    <span class="n">connnect_points_ccs</span> <span class="o">=</span> <span class="p">[</span><span class="nb">set</span><span class="p">()</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">edge_ccs</span><span class="p">))]</span>
    <span class="n">gp_time</span><span class="p">,</span> <span class="n">tmp_mesh_time</span><span class="p">,</span> <span class="n">bilateral_time</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
    <span class="n">edges_infos</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">edges_in_mask</span> <span class="o">=</span> <span class="p">[</span><span class="nb">set</span><span class="p">()</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">edge_ccs</span><span class="p">))]</span>
    <span class="n">tmp_specific_edge_id</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">edge_id</span><span class="p">,</span> <span class="p">(</span><span class="n">context_cc</span><span class="p">,</span> <span class="n">mask_cc</span><span class="p">,</span> <span class="n">erode_context_cc</span><span class="p">,</span> <span class="n">extend_context_cc</span><span class="p">,</span> <span class="n">edge_cc</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">context_ccs</span><span class="p">,</span> <span class="n">mask_ccs</span><span class="p">,</span> <span class="n">erode_context_ccs</span><span class="p">,</span> <span class="n">extend_context_ccs</span><span class="p">,</span> <span class="n">edge_ccs</span><span class="p">)):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">specific_edge_id</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">edge_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">specific_edge_id</span><span class="p">:</span>
                <span class="k">continue</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">context_cc</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">mask_cc</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">edge_dict</span> <span class="o">=</span> <span class="n">get_edge_from_nodes</span><span class="p">(</span><span class="n">context_cc</span> <span class="o">|</span> <span class="n">extend_context_cc</span><span class="p">,</span> <span class="n">erode_context_cc</span> <span class="o">|</span> <span class="n">extend_erode_context_ccs</span><span class="p">[</span><span class="n">edge_id</span><span class="p">],</span> <span class="n">mask_cc</span><span class="p">,</span> <span class="n">edge_cc</span><span class="p">,</span> <span class="n">extend_edge_ccs</span><span class="p">[</span><span class="n">edge_id</span><span class="p">],</span>
                                        <span class="n">mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;H&#39;</span><span class="p">],</span> <span class="n">mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">],</span> <span class="n">mesh</span><span class="p">)</span>
        <span class="n">edge_dict</span><span class="p">[</span><span class="s1">&#39;edge&#39;</span><span class="p">],</span> <span class="n">end_depth_maps</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> \
            <span class="n">filter_irrelevant_edge_new</span><span class="p">(</span><span class="n">edge_dict</span><span class="p">[</span><span class="s1">&#39;self_edge&#39;</span><span class="p">],</span> <span class="n">edge_dict</span><span class="p">[</span><span class="s1">&#39;comp_edge&#39;</span><span class="p">],</span>
                                    <span class="n">edge_map</span><span class="p">,</span>
                                    <span class="n">edge_maps_with_id</span><span class="p">,</span>
                                    <span class="n">edge_id</span><span class="p">,</span>
                                    <span class="n">edge_dict</span><span class="p">[</span><span class="s1">&#39;context&#39;</span><span class="p">],</span>
                                    <span class="n">edge_dict</span><span class="p">[</span><span class="s1">&#39;depth&#39;</span><span class="p">],</span> <span class="n">mesh</span><span class="p">,</span> <span class="n">context_cc</span> <span class="o">|</span> <span class="n">erode_context_cc</span> <span class="o">|</span> <span class="n">extend_context_cc</span> <span class="o">|</span> <span class="n">extend_erode_context_ccs</span><span class="p">[</span><span class="n">edge_id</span><span class="p">],</span> <span class="n">spdb</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">specific_edge_loc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> \
            <span class="p">(</span><span class="n">specific_edge_loc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">edge_dict</span><span class="p">[</span><span class="s1">&#39;mask&#39;</span><span class="p">][</span><span class="n">specific_edge_loc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">specific_edge_loc</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="n">mask_size</span> <span class="o">=</span> <span class="n">get_valid_size</span><span class="p">(</span><span class="n">edge_dict</span><span class="p">[</span><span class="s1">&#39;mask&#39;</span><span class="p">])</span>
        <span class="n">mask_size</span> <span class="o">=</span> <span class="n">dilate_valid_size</span><span class="p">(</span><span class="n">mask_size</span><span class="p">,</span> <span class="n">edge_dict</span><span class="p">[</span><span class="s1">&#39;mask&#39;</span><span class="p">],</span> <span class="n">dilate</span><span class="o">=</span><span class="p">[</span><span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">])</span>
        <span class="n">context_size</span> <span class="o">=</span> <span class="n">get_valid_size</span><span class="p">(</span><span class="n">edge_dict</span><span class="p">[</span><span class="s1">&#39;context&#39;</span><span class="p">])</span>
        <span class="n">context_size</span> <span class="o">=</span> <span class="n">dilate_valid_size</span><span class="p">(</span><span class="n">context_size</span><span class="p">,</span> <span class="n">edge_dict</span><span class="p">[</span><span class="s1">&#39;context&#39;</span><span class="p">],</span> <span class="n">dilate</span><span class="o">=</span><span class="p">[</span><span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">])</span>
        <span class="n">union_size</span> <span class="o">=</span> <span class="n">size_operation</span><span class="p">(</span><span class="n">mask_size</span><span class="p">,</span> <span class="n">context_size</span><span class="p">,</span> <span class="n">operation</span><span class="o">=</span><span class="s1">&#39;+&#39;</span><span class="p">)</span>
        <span class="n">patch_edge_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">patch_edge_dict</span><span class="p">[</span><span class="s1">&#39;mask&#39;</span><span class="p">],</span> <span class="n">patch_edge_dict</span><span class="p">[</span><span class="s1">&#39;context&#39;</span><span class="p">],</span> <span class="n">patch_edge_dict</span><span class="p">[</span><span class="s1">&#39;rgb&#39;</span><span class="p">],</span> \
            <span class="n">patch_edge_dict</span><span class="p">[</span><span class="s1">&#39;disp&#39;</span><span class="p">],</span> <span class="n">patch_edge_dict</span><span class="p">[</span><span class="s1">&#39;edge&#39;</span><span class="p">]</span> <span class="o">=</span> \
            <span class="n">crop_maps_by_size</span><span class="p">(</span><span class="n">union_size</span><span class="p">,</span> <span class="n">edge_dict</span><span class="p">[</span><span class="s1">&#39;mask&#39;</span><span class="p">],</span> <span class="n">edge_dict</span><span class="p">[</span><span class="s1">&#39;context&#39;</span><span class="p">],</span>
                                <span class="n">edge_dict</span><span class="p">[</span><span class="s1">&#39;rgb&#39;</span><span class="p">],</span> <span class="n">edge_dict</span><span class="p">[</span><span class="s1">&#39;disp&#39;</span><span class="p">],</span> <span class="n">edge_dict</span><span class="p">[</span><span class="s1">&#39;edge&#39;</span><span class="p">])</span>
        <span class="n">x_anchor</span><span class="p">,</span> <span class="n">y_anchor</span> <span class="o">=</span> <span class="p">[</span><span class="n">union_size</span><span class="p">[</span><span class="s1">&#39;x_min&#39;</span><span class="p">],</span> <span class="n">union_size</span><span class="p">[</span><span class="s1">&#39;x_max&#39;</span><span class="p">]],</span> <span class="p">[</span><span class="n">union_size</span><span class="p">[</span><span class="s1">&#39;y_min&#39;</span><span class="p">],</span> <span class="n">union_size</span><span class="p">[</span><span class="s1">&#39;y_max&#39;</span><span class="p">]]</span>
        <span class="n">tensor_edge_dict</span> <span class="o">=</span> <span class="n">convert2tensor</span><span class="p">(</span><span class="n">patch_edge_dict</span><span class="p">)</span>
        <span class="n">input_edge_feat</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">tensor_edge_dict</span><span class="p">[</span><span class="s1">&#39;rgb&#39;</span><span class="p">],</span>
                                        <span class="n">tensor_edge_dict</span><span class="p">[</span><span class="s1">&#39;disp&#39;</span><span class="p">],</span>
                                        <span class="n">tensor_edge_dict</span><span class="p">[</span><span class="s1">&#39;edge&#39;</span><span class="p">],</span>
                                        <span class="mi">1</span> <span class="o">-</span> <span class="n">tensor_edge_dict</span><span class="p">[</span><span class="s1">&#39;context&#39;</span><span class="p">],</span>
                                        <span class="n">tensor_edge_dict</span><span class="p">[</span><span class="s1">&#39;mask&#39;</span><span class="p">]),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">require_depth_edge</span><span class="p">(</span><span class="n">patch_edge_dict</span><span class="p">[</span><span class="s1">&#39;edge&#39;</span><span class="p">],</span> <span class="n">patch_edge_dict</span><span class="p">[</span><span class="s1">&#39;mask&#39;</span><span class="p">])</span> <span class="ow">and</span> <span class="n">inpaint_iter</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
                <span class="n">depth_edge_output</span> <span class="o">=</span> <span class="n">depth_edge_model</span><span class="o">.</span><span class="n">forward_3P</span><span class="p">(</span><span class="n">tensor_edge_dict</span><span class="p">[</span><span class="s1">&#39;mask&#39;</span><span class="p">],</span>
                                                                <span class="n">tensor_edge_dict</span><span class="p">[</span><span class="s1">&#39;context&#39;</span><span class="p">],</span>
                                                                <span class="n">tensor_edge_dict</span><span class="p">[</span><span class="s1">&#39;rgb&#39;</span><span class="p">],</span>
                                                                <span class="n">tensor_edge_dict</span><span class="p">[</span><span class="s1">&#39;disp&#39;</span><span class="p">],</span>
                                                                <span class="n">tensor_edge_dict</span><span class="p">[</span><span class="s1">&#39;edge&#39;</span><span class="p">],</span>
                                                                <span class="n">unit_length</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span>
                                                                <span class="n">cuda</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
                <span class="n">depth_edge_output</span> <span class="o">=</span> <span class="n">depth_edge_output</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
            <span class="n">tensor_edge_dict</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">depth_edge_output</span><span class="o">&gt;</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;ext_edge_threshold&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">float</span><span class="p">()</span> <span class="o">*</span> <span class="n">tensor_edge_dict</span><span class="p">[</span><span class="s1">&#39;mask&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">tensor_edge_dict</span><span class="p">[</span><span class="s1">&#39;edge&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tensor_edge_dict</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tensor_edge_dict</span><span class="p">[</span><span class="s1">&#39;edge&#39;</span><span class="p">]</span>
            <span class="n">depth_edge_output</span> <span class="o">=</span> <span class="n">tensor_edge_dict</span><span class="p">[</span><span class="s1">&#39;edge&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">0</span>
        <span class="n">patch_edge_dict</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tensor_edge_dict</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
        <span class="n">edge_dict</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;H&#39;</span><span class="p">],</span> <span class="n">mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]))</span>
        <span class="n">edge_dict</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">][</span><span class="n">union_size</span><span class="p">[</span><span class="s1">&#39;x_min&#39;</span><span class="p">]:</span><span class="n">union_size</span><span class="p">[</span><span class="s1">&#39;x_max&#39;</span><span class="p">],</span> <span class="n">union_size</span><span class="p">[</span><span class="s1">&#39;y_min&#39;</span><span class="p">]:</span><span class="n">union_size</span><span class="p">[</span><span class="s1">&#39;y_max&#39;</span><span class="p">]]</span> <span class="o">=</span> \
            <span class="n">patch_edge_dict</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">require_depth_edge</span><span class="p">(</span><span class="n">patch_edge_dict</span><span class="p">[</span><span class="s1">&#39;edge&#39;</span><span class="p">],</span> <span class="n">patch_edge_dict</span><span class="p">[</span><span class="s1">&#39;mask&#39;</span><span class="p">])</span> <span class="ow">and</span> <span class="n">inpaint_iter</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">((</span><span class="n">depth_edge_output</span><span class="o">&gt;</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;ext_edge_threshold&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">float</span><span class="p">()</span> <span class="o">*</span> <span class="n">tensor_edge_dict</span><span class="p">[</span><span class="s1">&#39;mask&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">edge_dict</span><span class="p">[</span><span class="s1">&#39;fpath_map&#39;</span><span class="p">],</span> <span class="n">edge_dict</span><span class="p">[</span><span class="s1">&#39;npath_map&#39;</span><span class="p">],</span> <span class="n">break_flag</span><span class="p">,</span> <span class="n">npaths</span><span class="p">,</span> <span class="n">fpaths</span><span class="p">,</span> <span class="n">invalid_edge_id</span> <span class="o">=</span> \
                        <span class="n">clean_far_edge_new</span><span class="p">(</span><span class="n">edge_dict</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">],</span> <span class="n">end_depth_maps</span><span class="p">,</span> <span class="n">edge_dict</span><span class="p">[</span><span class="s1">&#39;mask&#39;</span><span class="p">],</span> <span class="n">edge_dict</span><span class="p">[</span><span class="s1">&#39;context&#39;</span><span class="p">],</span> <span class="n">mesh</span><span class="p">,</span> <span class="n">info_on_pix</span><span class="p">,</span> <span class="n">edge_dict</span><span class="p">[</span><span class="s1">&#39;self_edge&#39;</span><span class="p">],</span> <span class="n">inpaint_iter</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="kn">import</span> <span class="nn">pdb</span><span class="p">;</span> <span class="n">pdb</span><span class="o">.</span><span class="n">set_trace</span><span class="p">()</span>
                <span class="n">pre_npath_map</span> <span class="o">=</span> <span class="n">edge_dict</span><span class="p">[</span><span class="s1">&#39;npath_map&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;repeat_inpaint_edge&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
                        <span class="n">tmp_input_edge</span> <span class="o">=</span> <span class="p">((</span><span class="n">edge_dict</span><span class="p">[</span><span class="s1">&#39;npath_map&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">edge_dict</span><span class="p">[</span><span class="s1">&#39;edge&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                        <span class="n">patch_tmp_input_edge</span> <span class="o">=</span> <span class="n">crop_maps_by_size</span><span class="p">(</span><span class="n">union_size</span><span class="p">,</span> <span class="n">tmp_input_edge</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">tensor_input_edge</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">(</span><span class="n">patch_tmp_input_edge</span><span class="p">)[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
                        <span class="n">depth_edge_output</span> <span class="o">=</span> <span class="n">depth_edge_model</span><span class="o">.</span><span class="n">forward_3P</span><span class="p">(</span><span class="n">tensor_edge_dict</span><span class="p">[</span><span class="s1">&#39;mask&#39;</span><span class="p">],</span>
                                                    <span class="n">tensor_edge_dict</span><span class="p">[</span><span class="s1">&#39;context&#39;</span><span class="p">],</span>
                                                    <span class="n">tensor_edge_dict</span><span class="p">[</span><span class="s1">&#39;rgb&#39;</span><span class="p">],</span>
                                                    <span class="n">tensor_edge_dict</span><span class="p">[</span><span class="s1">&#39;disp&#39;</span><span class="p">],</span>
                                                    <span class="n">tensor_input_edge</span><span class="p">,</span>
                                                    <span class="n">unit_length</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span>
                                                    <span class="n">cuda</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
                        <span class="n">depth_edge_output</span> <span class="o">=</span> <span class="n">depth_edge_output</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
                        <span class="n">depth_edge_output</span> <span class="o">=</span> <span class="p">(</span><span class="n">depth_edge_output</span><span class="o">&gt;</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;ext_edge_threshold&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">float</span><span class="p">()</span> <span class="o">*</span> <span class="n">tensor_edge_dict</span><span class="p">[</span><span class="s1">&#39;mask&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">tensor_edge_dict</span><span class="p">[</span><span class="s1">&#39;edge&#39;</span><span class="p">]</span>
                        <span class="n">depth_edge_output</span> <span class="o">=</span> <span class="n">depth_edge_output</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
                        <span class="n">full_depth_edge_output</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;H&#39;</span><span class="p">],</span> <span class="n">mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]))</span>
                        <span class="n">full_depth_edge_output</span><span class="p">[</span><span class="n">union_size</span><span class="p">[</span><span class="s1">&#39;x_min&#39;</span><span class="p">]:</span><span class="n">union_size</span><span class="p">[</span><span class="s1">&#39;x_max&#39;</span><span class="p">],</span> <span class="n">union_size</span><span class="p">[</span><span class="s1">&#39;y_min&#39;</span><span class="p">]:</span><span class="n">union_size</span><span class="p">[</span><span class="s1">&#39;y_max&#39;</span><span class="p">]]</span> <span class="o">=</span> \
                            <span class="n">depth_edge_output</span>
                        <span class="n">edge_dict</span><span class="p">[</span><span class="s1">&#39;fpath_map&#39;</span><span class="p">],</span> <span class="n">edge_dict</span><span class="p">[</span><span class="s1">&#39;npath_map&#39;</span><span class="p">],</span> <span class="n">break_flag</span><span class="p">,</span> <span class="n">npaths</span><span class="p">,</span> <span class="n">fpaths</span><span class="p">,</span> <span class="n">invalid_edge_id</span> <span class="o">=</span> \
                            <span class="n">clean_far_edge_new</span><span class="p">(</span><span class="n">full_depth_edge_output</span><span class="p">,</span> <span class="n">end_depth_maps</span><span class="p">,</span> <span class="n">edge_dict</span><span class="p">[</span><span class="s1">&#39;mask&#39;</span><span class="p">],</span> <span class="n">edge_dict</span><span class="p">[</span><span class="s1">&#39;context&#39;</span><span class="p">],</span> <span class="n">mesh</span><span class="p">,</span> <span class="n">info_on_pix</span><span class="p">,</span> <span class="n">edge_dict</span><span class="p">[</span><span class="s1">&#39;self_edge&#39;</span><span class="p">],</span> <span class="n">inpaint_iter</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">nid</span> <span class="ow">in</span> <span class="n">npaths</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">npath</span><span class="p">,</span> <span class="n">fpath</span> <span class="o">=</span> <span class="n">npaths</span><span class="p">[</span><span class="n">nid</span><span class="p">],</span> <span class="n">fpaths</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span>
                    <span class="n">start_mx</span><span class="p">,</span> <span class="n">start_my</span><span class="p">,</span> <span class="n">end_mx</span><span class="p">,</span> <span class="n">end_my</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span>
                    <span class="k">if</span> <span class="n">end_depth_maps</span><span class="p">[</span><span class="n">npath</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">npath</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">start_mx</span><span class="p">,</span> <span class="n">start_my</span> <span class="o">=</span> <span class="n">npath</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">npath</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">end_depth_maps</span><span class="p">[</span><span class="n">npath</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">npath</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">end_mx</span><span class="p">,</span> <span class="n">end_my</span> <span class="o">=</span> <span class="n">npath</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">npath</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">start_mx</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                        <span class="kn">import</span> <span class="nn">pdb</span><span class="p">;</span> <span class="n">pdb</span><span class="o">.</span><span class="n">set_trace</span><span class="p">()</span>
                    <span class="n">valid_end_pt</span> <span class="o">=</span> <span class="p">()</span> <span class="k">if</span> <span class="n">end_mx</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="k">else</span> <span class="p">(</span><span class="n">end_mx</span><span class="p">,</span> <span class="n">end_my</span><span class="p">,</span> <span class="n">info_on_pix</span><span class="p">[(</span><span class="n">end_mx</span><span class="p">,</span> <span class="n">end_my</span><span class="p">)][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;depth&#39;</span><span class="p">])</span>
                    <span class="n">new_edge_info</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">fpath</span><span class="o">=</span><span class="n">fpath</span><span class="p">,</span>
                                         <span class="n">npath</span><span class="o">=</span><span class="n">npath</span><span class="p">,</span>
                                         <span class="n">cont_end_pts</span><span class="o">=</span><span class="n">valid_end_pt</span><span class="p">,</span>
                                         <span class="n">mask_id</span><span class="o">=</span><span class="n">edge_id</span><span class="p">,</span>
                                         <span class="n">comp_edge_id</span><span class="o">=</span><span class="n">nid</span><span class="p">,</span>
                                         <span class="n">depth</span><span class="o">=</span><span class="n">end_depth_maps</span><span class="p">[</span><span class="n">start_mx</span><span class="p">,</span> <span class="n">start_my</span><span class="p">])</span>
                    <span class="k">if</span> <span class="n">edges_infos</span><span class="o">.</span><span class="n">get</span><span class="p">((</span><span class="n">start_mx</span><span class="p">,</span> <span class="n">start_my</span><span class="p">))</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">edges_infos</span><span class="p">[(</span><span class="n">start_mx</span><span class="p">,</span> <span class="n">start_my</span><span class="p">)]</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">edges_infos</span><span class="p">[(</span><span class="n">start_mx</span><span class="p">,</span> <span class="n">start_my</span><span class="p">)]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_edge_info</span><span class="p">)</span>
                    <span class="n">edges_in_mask</span><span class="p">[</span><span class="n">edge_id</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">start_mx</span><span class="p">,</span> <span class="n">start_my</span><span class="p">))</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">valid_end_pt</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">new_edge_info</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">fpath</span><span class="o">=</span><span class="n">fpath</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                                             <span class="n">npath</span><span class="o">=</span><span class="n">npath</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                                             <span class="n">cont_end_pts</span><span class="o">=</span><span class="p">(</span><span class="n">start_mx</span><span class="p">,</span> <span class="n">start_my</span><span class="p">,</span> <span class="n">info_on_pix</span><span class="p">[(</span><span class="n">start_mx</span><span class="p">,</span> <span class="n">start_my</span><span class="p">)][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;depth&#39;</span><span class="p">]),</span>
                                             <span class="n">mask_id</span><span class="o">=</span><span class="n">edge_id</span><span class="p">,</span>
                                             <span class="n">comp_edge_id</span><span class="o">=</span><span class="n">nid</span><span class="p">,</span>
                                             <span class="n">depth</span><span class="o">=</span><span class="n">end_depth_maps</span><span class="p">[</span><span class="n">end_mx</span><span class="p">,</span> <span class="n">end_my</span><span class="p">])</span>
                        <span class="k">if</span> <span class="n">edges_infos</span><span class="o">.</span><span class="n">get</span><span class="p">((</span><span class="n">end_mx</span><span class="p">,</span> <span class="n">end_my</span><span class="p">))</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">edges_infos</span><span class="p">[(</span><span class="n">end_mx</span><span class="p">,</span> <span class="n">end_my</span><span class="p">)]</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="n">edges_infos</span><span class="p">[(</span><span class="n">end_mx</span><span class="p">,</span> <span class="n">end_my</span><span class="p">)]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_edge_info</span><span class="p">)</span>
                        <span class="n">edges_in_mask</span><span class="p">[</span><span class="n">edge_id</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">end_mx</span><span class="p">,</span> <span class="n">end_my</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">edge_id</span><span class="p">,</span> <span class="p">(</span><span class="n">context_cc</span><span class="p">,</span> <span class="n">mask_cc</span><span class="p">,</span> <span class="n">erode_context_cc</span><span class="p">,</span> <span class="n">extend_context_cc</span><span class="p">,</span> <span class="n">edge_cc</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">context_ccs</span><span class="p">,</span> <span class="n">mask_ccs</span><span class="p">,</span> <span class="n">erode_context_ccs</span><span class="p">,</span> <span class="n">extend_context_ccs</span><span class="p">,</span> <span class="n">edge_ccs</span><span class="p">)):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">specific_edge_id</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">edge_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">specific_edge_id</span><span class="p">:</span>
                <span class="k">continue</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">context_cc</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">mask_cc</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">edge_dict</span> <span class="o">=</span> <span class="n">get_edge_from_nodes</span><span class="p">(</span><span class="n">context_cc</span> <span class="o">|</span> <span class="n">extend_context_cc</span><span class="p">,</span> <span class="n">erode_context_cc</span> <span class="o">|</span> <span class="n">extend_erode_context_ccs</span><span class="p">[</span><span class="n">edge_id</span><span class="p">],</span> <span class="n">mask_cc</span><span class="p">,</span> <span class="n">edge_cc</span><span class="p">,</span> <span class="n">extend_edge_ccs</span><span class="p">[</span><span class="n">edge_id</span><span class="p">],</span>
                                        <span class="n">mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;H&#39;</span><span class="p">],</span> <span class="n">mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">],</span> <span class="n">mesh</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">specific_edge_loc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> \
            <span class="p">(</span><span class="n">specific_edge_loc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">edge_dict</span><span class="p">[</span><span class="s1">&#39;mask&#39;</span><span class="p">][</span><span class="n">specific_edge_loc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">specific_edge_loc</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tmp_specific_edge_id</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">edge_id</span><span class="p">)</span>
        <span class="n">edge_dict</span><span class="p">[</span><span class="s1">&#39;edge&#39;</span><span class="p">],</span> <span class="n">end_depth_maps</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> \
            <span class="n">filter_irrelevant_edge_new</span><span class="p">(</span><span class="n">edge_dict</span><span class="p">[</span><span class="s1">&#39;self_edge&#39;</span><span class="p">],</span> <span class="n">edge_dict</span><span class="p">[</span><span class="s1">&#39;comp_edge&#39;</span><span class="p">],</span>
                                    <span class="n">edge_map</span><span class="p">,</span>
                                    <span class="n">edge_maps_with_id</span><span class="p">,</span>
                                    <span class="n">edge_id</span><span class="p">,</span>
                                    <span class="n">edge_dict</span><span class="p">[</span><span class="s1">&#39;context&#39;</span><span class="p">],</span>
                                    <span class="n">edge_dict</span><span class="p">[</span><span class="s1">&#39;depth&#39;</span><span class="p">],</span> <span class="n">mesh</span><span class="p">,</span> <span class="n">context_cc</span> <span class="o">|</span> <span class="n">erode_context_cc</span> <span class="o">|</span> <span class="n">extend_context_cc</span> <span class="o">|</span> <span class="n">extend_erode_context_ccs</span><span class="p">[</span><span class="n">edge_id</span><span class="p">],</span> <span class="n">spdb</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">discard_map</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">edge_dict</span><span class="p">[</span><span class="s1">&#39;edge&#39;</span><span class="p">])</span>
        <span class="n">mask_size</span> <span class="o">=</span> <span class="n">get_valid_size</span><span class="p">(</span><span class="n">edge_dict</span><span class="p">[</span><span class="s1">&#39;mask&#39;</span><span class="p">])</span>
        <span class="n">mask_size</span> <span class="o">=</span> <span class="n">dilate_valid_size</span><span class="p">(</span><span class="n">mask_size</span><span class="p">,</span> <span class="n">edge_dict</span><span class="p">[</span><span class="s1">&#39;mask&#39;</span><span class="p">],</span> <span class="n">dilate</span><span class="o">=</span><span class="p">[</span><span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">])</span>
        <span class="n">context_size</span> <span class="o">=</span> <span class="n">get_valid_size</span><span class="p">(</span><span class="n">edge_dict</span><span class="p">[</span><span class="s1">&#39;context&#39;</span><span class="p">])</span>
        <span class="n">context_size</span> <span class="o">=</span> <span class="n">dilate_valid_size</span><span class="p">(</span><span class="n">context_size</span><span class="p">,</span> <span class="n">edge_dict</span><span class="p">[</span><span class="s1">&#39;context&#39;</span><span class="p">],</span> <span class="n">dilate</span><span class="o">=</span><span class="p">[</span><span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">])</span>
        <span class="n">union_size</span> <span class="o">=</span> <span class="n">size_operation</span><span class="p">(</span><span class="n">mask_size</span><span class="p">,</span> <span class="n">context_size</span><span class="p">,</span> <span class="n">operation</span><span class="o">=</span><span class="s1">&#39;+&#39;</span><span class="p">)</span>
        <span class="n">patch_edge_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">patch_edge_dict</span><span class="p">[</span><span class="s1">&#39;mask&#39;</span><span class="p">],</span> <span class="n">patch_edge_dict</span><span class="p">[</span><span class="s1">&#39;context&#39;</span><span class="p">],</span> <span class="n">patch_edge_dict</span><span class="p">[</span><span class="s1">&#39;rgb&#39;</span><span class="p">],</span> \
            <span class="n">patch_edge_dict</span><span class="p">[</span><span class="s1">&#39;disp&#39;</span><span class="p">],</span> <span class="n">patch_edge_dict</span><span class="p">[</span><span class="s1">&#39;edge&#39;</span><span class="p">]</span> <span class="o">=</span> \
            <span class="n">crop_maps_by_size</span><span class="p">(</span><span class="n">union_size</span><span class="p">,</span> <span class="n">edge_dict</span><span class="p">[</span><span class="s1">&#39;mask&#39;</span><span class="p">],</span> <span class="n">edge_dict</span><span class="p">[</span><span class="s1">&#39;context&#39;</span><span class="p">],</span>
                                <span class="n">edge_dict</span><span class="p">[</span><span class="s1">&#39;rgb&#39;</span><span class="p">],</span> <span class="n">edge_dict</span><span class="p">[</span><span class="s1">&#39;disp&#39;</span><span class="p">],</span> <span class="n">edge_dict</span><span class="p">[</span><span class="s1">&#39;edge&#39;</span><span class="p">])</span>
        <span class="n">x_anchor</span><span class="p">,</span> <span class="n">y_anchor</span> <span class="o">=</span> <span class="p">[</span><span class="n">union_size</span><span class="p">[</span><span class="s1">&#39;x_min&#39;</span><span class="p">],</span> <span class="n">union_size</span><span class="p">[</span><span class="s1">&#39;x_max&#39;</span><span class="p">]],</span> <span class="p">[</span><span class="n">union_size</span><span class="p">[</span><span class="s1">&#39;y_min&#39;</span><span class="p">],</span> <span class="n">union_size</span><span class="p">[</span><span class="s1">&#39;y_max&#39;</span><span class="p">]]</span>
        <span class="n">tensor_edge_dict</span> <span class="o">=</span> <span class="n">convert2tensor</span><span class="p">(</span><span class="n">patch_edge_dict</span><span class="p">)</span>
        <span class="n">input_edge_feat</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">tensor_edge_dict</span><span class="p">[</span><span class="s1">&#39;rgb&#39;</span><span class="p">],</span>
                                        <span class="n">tensor_edge_dict</span><span class="p">[</span><span class="s1">&#39;disp&#39;</span><span class="p">],</span>
                                        <span class="n">tensor_edge_dict</span><span class="p">[</span><span class="s1">&#39;edge&#39;</span><span class="p">],</span>
                                        <span class="mi">1</span> <span class="o">-</span> <span class="n">tensor_edge_dict</span><span class="p">[</span><span class="s1">&#39;context&#39;</span><span class="p">],</span>
                                        <span class="n">tensor_edge_dict</span><span class="p">[</span><span class="s1">&#39;mask&#39;</span><span class="p">]),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">edge_dict</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">edge_dict</span><span class="p">[</span><span class="s1">&#39;edge&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">require_depth_edge</span><span class="p">(</span><span class="n">patch_edge_dict</span><span class="p">[</span><span class="s1">&#39;edge&#39;</span><span class="p">],</span> <span class="n">patch_edge_dict</span><span class="p">[</span><span class="s1">&#39;mask&#39;</span><span class="p">])</span> <span class="ow">and</span> <span class="n">inpaint_iter</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">edge_dict</span><span class="p">[</span><span class="s1">&#39;fpath_map&#39;</span><span class="p">],</span> <span class="n">edge_dict</span><span class="p">[</span><span class="s1">&#39;npath_map&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">edge_dict</span><span class="p">[</span><span class="s1">&#39;fpath_map&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">0</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">edge_dict</span><span class="p">[</span><span class="s1">&#39;npath_map&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">0</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="n">end_pts</span> <span class="o">=</span> <span class="n">edges_in_mask</span><span class="p">[</span><span class="n">edge_id</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">end_pt</span> <span class="ow">in</span> <span class="n">end_pts</span><span class="p">:</span>
                <span class="n">cur_edge_infos</span> <span class="o">=</span> <span class="n">edges_infos</span><span class="p">[(</span><span class="n">end_pt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">end_pt</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>
                <span class="n">cur_info</span> <span class="o">=</span> <span class="p">[</span><span class="n">xx</span> <span class="k">for</span> <span class="n">xx</span> <span class="ow">in</span> <span class="n">cur_edge_infos</span> <span class="k">if</span> <span class="n">xx</span><span class="p">[</span><span class="s1">&#39;mask_id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">edge_id</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">other_infos</span> <span class="o">=</span> <span class="p">[</span><span class="n">xx</span> <span class="k">for</span> <span class="n">xx</span> <span class="ow">in</span> <span class="n">cur_edge_infos</span> <span class="k">if</span> <span class="n">xx</span><span class="p">[</span><span class="s1">&#39;mask_id&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">edge_id</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">xx</span><span class="p">[</span><span class="s1">&#39;cont_end_pts&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cur_info</span><span class="p">[</span><span class="s1">&#39;cont_end_pts&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cur_info</span><span class="p">[</span><span class="s1">&#39;cont_end_pts&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">other_infos</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">fnode</span> <span class="ow">in</span> <span class="n">cur_info</span><span class="p">[</span><span class="s1">&#39;fpath&#39;</span><span class="p">]:</span>
                        <span class="n">edge_dict</span><span class="p">[</span><span class="s1">&#39;fpath_map&#39;</span><span class="p">][</span><span class="n">fnode</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">fnode</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">cur_info</span><span class="p">[</span><span class="s1">&#39;comp_edge_id&#39;</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">fnode</span> <span class="ow">in</span> <span class="n">cur_info</span><span class="p">[</span><span class="s1">&#39;npath&#39;</span><span class="p">]:</span>
                        <span class="n">edge_dict</span><span class="p">[</span><span class="s1">&#39;npath_map&#39;</span><span class="p">][</span><span class="n">fnode</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">fnode</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">cur_info</span><span class="p">[</span><span class="s1">&#39;comp_edge_id&#39;</span><span class="p">]</span>
            <span class="n">fnmap</span> <span class="o">=</span> <span class="n">edge_dict</span><span class="p">[</span><span class="s1">&#39;fpath_map&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">1</span>
            <span class="n">fnmap</span><span class="p">[</span><span class="n">edge_dict</span><span class="p">[</span><span class="s1">&#39;npath_map&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">edge_dict</span><span class="p">[</span><span class="s1">&#39;npath_map&#39;</span><span class="p">][</span><span class="n">edge_dict</span><span class="p">[</span><span class="s1">&#39;npath_map&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">end_pt</span> <span class="ow">in</span> <span class="n">end_pts</span><span class="p">:</span>
                <span class="n">cur_edge_infos</span> <span class="o">=</span> <span class="n">edges_infos</span><span class="p">[(</span><span class="n">end_pt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">end_pt</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>
                <span class="n">cur_info</span> <span class="o">=</span> <span class="p">[</span><span class="n">xx</span> <span class="k">for</span> <span class="n">xx</span> <span class="ow">in</span> <span class="n">cur_edge_infos</span> <span class="k">if</span> <span class="n">xx</span><span class="p">[</span><span class="s1">&#39;mask_id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">edge_id</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">cur_depth</span> <span class="o">=</span> <span class="n">cur_info</span><span class="p">[</span><span class="s1">&#39;depth&#39;</span><span class="p">]</span>
                <span class="n">other_infos</span> <span class="o">=</span> <span class="p">[</span><span class="n">xx</span> <span class="k">for</span> <span class="n">xx</span> <span class="ow">in</span> <span class="n">cur_edge_infos</span> <span class="k">if</span> <span class="n">xx</span><span class="p">[</span><span class="s1">&#39;mask_id&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">edge_id</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">xx</span><span class="p">[</span><span class="s1">&#39;cont_end_pts&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
                <span class="n">comp_edge_id</span> <span class="o">=</span> <span class="n">cur_info</span><span class="p">[</span><span class="s1">&#39;comp_edge_id&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cur_info</span><span class="p">[</span><span class="s1">&#39;cont_end_pts&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">other_infos</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">other_infos</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">other_infos</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">aa</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">aa</span><span class="p">[</span><span class="s1">&#39;cont_end_pts&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">])</span> <span class="o">-</span> <span class="nb">abs</span><span class="p">(</span><span class="n">cur_depth</span><span class="p">)))</span>
                    <span class="k">for</span> <span class="n">other_info</span> <span class="ow">in</span> <span class="n">other_infos</span><span class="p">:</span>
                        <span class="n">tmp_fmap</span><span class="p">,</span> <span class="n">tmp_nmap</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;H&#39;</span><span class="p">],</span> <span class="n">mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]))</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;H&#39;</span><span class="p">],</span> <span class="n">mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]))</span> <span class="o">-</span> <span class="mi">1</span>
                        <span class="k">for</span> <span class="n">fnode</span> <span class="ow">in</span> <span class="n">other_info</span><span class="p">[</span><span class="s1">&#39;fpath&#39;</span><span class="p">]:</span>
                            <span class="k">if</span> <span class="n">fnmap</span><span class="p">[</span><span class="n">fnode</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">fnode</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                                <span class="n">tmp_fmap</span> <span class="o">=</span> <span class="n">tmp_fmap</span> <span class="o">*</span> <span class="mi">0</span> <span class="o">-</span> <span class="mi">1</span>
                                <span class="k">break</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">tmp_fmap</span><span class="p">[</span><span class="n">fnode</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">fnode</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">comp_edge_id</span>
                        <span class="k">if</span> <span class="n">fnmap</span><span class="p">[</span><span class="n">fnode</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">fnode</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                            <span class="k">continue</span>
                        <span class="k">for</span> <span class="n">fnode</span> <span class="ow">in</span> <span class="n">other_info</span><span class="p">[</span><span class="s1">&#39;npath&#39;</span><span class="p">]:</span>
                            <span class="k">if</span> <span class="n">fnmap</span><span class="p">[</span><span class="n">fnode</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">fnode</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                                <span class="n">tmp_nmap</span> <span class="o">=</span> <span class="n">tmp_nmap</span> <span class="o">*</span> <span class="mi">0</span> <span class="o">-</span> <span class="mi">1</span>
                                <span class="k">break</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">tmp_nmap</span><span class="p">[</span><span class="n">fnode</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">fnode</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">comp_edge_id</span>
                        <span class="k">if</span> <span class="n">fnmap</span><span class="p">[</span><span class="n">fnode</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">fnode</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                            <span class="k">continue</span>
                        <span class="k">break</span>
                    <span class="k">if</span> <span class="nb">min</span><span class="p">(</span><span class="n">tmp_fmap</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">tmp_nmap</span><span class="o">.</span><span class="n">max</span><span class="p">())</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                        <span class="n">edge_dict</span><span class="p">[</span><span class="s1">&#39;fpath_map&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp_fmap</span>
                        <span class="n">edge_dict</span><span class="p">[</span><span class="s1">&#39;fpath_map&#39;</span><span class="p">][</span><span class="n">edge_dict</span><span class="p">[</span><span class="s1">&#39;valid_area&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                        <span class="n">edge_dict</span><span class="p">[</span><span class="s1">&#39;npath_map&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp_nmap</span>
                        <span class="n">edge_dict</span><span class="p">[</span><span class="s1">&#39;npath_map&#39;</span><span class="p">][</span><span class="n">edge_dict</span><span class="p">[</span><span class="s1">&#39;valid_area&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                        <span class="n">discard_map</span> <span class="o">=</span> <span class="p">((</span><span class="n">tmp_nmap</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">tmp_fmap</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">))</span> <span class="o">*</span> <span class="n">edge_dict</span><span class="p">[</span><span class="s1">&#39;mask&#39;</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">fnode</span> <span class="ow">in</span> <span class="n">cur_info</span><span class="p">[</span><span class="s1">&#39;fpath&#39;</span><span class="p">]:</span>
                            <span class="n">edge_dict</span><span class="p">[</span><span class="s1">&#39;fpath_map&#39;</span><span class="p">][</span><span class="n">fnode</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">fnode</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">cur_info</span><span class="p">[</span><span class="s1">&#39;comp_edge_id&#39;</span><span class="p">]</span>
                        <span class="k">for</span> <span class="n">fnode</span> <span class="ow">in</span> <span class="n">cur_info</span><span class="p">[</span><span class="s1">&#39;npath&#39;</span><span class="p">]:</span>
                            <span class="n">edge_dict</span><span class="p">[</span><span class="s1">&#39;npath_map&#39;</span><span class="p">][</span><span class="n">fnode</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">fnode</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">cur_info</span><span class="p">[</span><span class="s1">&#39;comp_edge_id&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">edge_dict</span><span class="p">[</span><span class="s1">&#39;npath_map&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">edge_dict</span><span class="p">[</span><span class="s1">&#39;fpath_map&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="kn">import</span> <span class="nn">pdb</span><span class="p">;</span> <span class="n">pdb</span><span class="o">.</span><span class="n">set_trace</span><span class="p">()</span>
            <span class="n">edge_dict</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">edge_dict</span><span class="p">[</span><span class="s1">&#39;npath_map&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">edge_dict</span><span class="p">[</span><span class="s1">&#39;mask&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">edge_dict</span><span class="p">[</span><span class="s1">&#39;context&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">edge_dict</span><span class="p">[</span><span class="s1">&#39;edge&#39;</span><span class="p">]</span>
        <span class="n">mesh</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">create_placeholder</span><span class="p">(</span><span class="n">edge_dict</span><span class="p">[</span><span class="s1">&#39;context&#39;</span><span class="p">],</span> <span class="n">edge_dict</span><span class="p">[</span><span class="s1">&#39;mask&#39;</span><span class="p">],</span>
                                  <span class="n">edge_dict</span><span class="p">[</span><span class="s1">&#39;depth&#39;</span><span class="p">],</span> <span class="n">edge_dict</span><span class="p">[</span><span class="s1">&#39;fpath_map&#39;</span><span class="p">],</span>
                                  <span class="n">edge_dict</span><span class="p">[</span><span class="s1">&#39;npath_map&#39;</span><span class="p">],</span> <span class="n">mesh</span><span class="p">,</span> <span class="n">inpaint_iter</span><span class="p">,</span>
                                  <span class="n">edge_ccs</span><span class="p">,</span>
                                  <span class="n">extend_edge_ccs</span><span class="p">[</span><span class="n">edge_id</span><span class="p">],</span>
                                  <span class="n">edge_maps_with_id</span><span class="p">,</span>
                                  <span class="n">edge_id</span><span class="p">)</span>

        <span class="n">dxs</span><span class="p">,</span> <span class="n">dys</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">discard_map</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">dxs</span><span class="p">,</span> <span class="n">dys</span><span class="p">):</span>
            <span class="n">mesh</span><span class="o">.</span><span class="n">nodes</span><span class="p">[(</span><span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">)][</span><span class="s1">&#39;inpaint_twice&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">depth_dict</span> <span class="o">=</span> <span class="n">depth_inpainting</span><span class="p">(</span><span class="n">context_cc</span><span class="p">,</span> <span class="n">extend_context_cc</span><span class="p">,</span> <span class="n">erode_context_cc</span> <span class="o">|</span> <span class="n">extend_erode_context_ccs</span><span class="p">[</span><span class="n">edge_id</span><span class="p">],</span> <span class="n">mask_cc</span><span class="p">,</span> <span class="n">mesh</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">union_size</span><span class="p">,</span> <span class="n">depth_feat_model</span><span class="p">,</span> <span class="n">edge_dict</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">])</span>
        <span class="n">refine_depth_output</span> <span class="o">=</span> <span class="n">depth_dict</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">depth_dict</span><span class="p">[</span><span class="s1">&#39;mask&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">near_id</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">edge_dict</span><span class="p">[</span><span class="s1">&#39;npath_map&#39;</span><span class="p">])[</span><span class="mi">1</span><span class="p">:]:</span>
            <span class="n">refine_depth_output</span> <span class="o">=</span> <span class="n">refine_depth_around_edge</span><span class="p">(</span><span class="n">refine_depth_output</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
                                                            <span class="p">(</span><span class="n">edge_dict</span><span class="p">[</span><span class="s1">&#39;fpath_map&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">near_id</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span> <span class="o">*</span> <span class="n">edge_dict</span><span class="p">[</span><span class="s1">&#39;mask&#39;</span><span class="p">],</span>
                                                            <span class="p">(</span><span class="n">edge_dict</span><span class="p">[</span><span class="s1">&#39;fpath_map&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">near_id</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">),</span>
                                                            <span class="p">(</span><span class="n">edge_dict</span><span class="p">[</span><span class="s1">&#39;npath_map&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">near_id</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span> <span class="o">*</span> <span class="n">edge_dict</span><span class="p">[</span><span class="s1">&#39;mask&#39;</span><span class="p">],</span>
                                                            <span class="n">depth_dict</span><span class="p">[</span><span class="s1">&#39;mask&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
                                                            <span class="n">depth_dict</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">depth_dict</span><span class="p">[</span><span class="s1">&#39;context&#39;</span><span class="p">],</span>
                                                            <span class="n">config</span><span class="p">)</span>
        <span class="n">depth_dict</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">][</span><span class="n">depth_dict</span><span class="p">[</span><span class="s1">&#39;mask&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">refine_depth_output</span><span class="p">[</span><span class="n">depth_dict</span><span class="p">[</span><span class="s1">&#39;mask&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">rgb_dict</span> <span class="o">=</span> <span class="n">get_rgb_from_nodes</span><span class="p">(</span><span class="n">context_cc</span> <span class="o">|</span> <span class="n">extend_context_cc</span><span class="p">,</span>
                                      <span class="n">erode_context_cc</span> <span class="o">|</span> <span class="n">extend_erode_context_ccs</span><span class="p">[</span><span class="n">edge_id</span><span class="p">],</span> <span class="n">mask_cc</span><span class="p">,</span> <span class="n">mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;H&#39;</span><span class="p">],</span> <span class="n">mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">],</span> <span class="n">mesh</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">rgb_dict</span><span class="p">[</span><span class="s1">&#39;mask&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">edge_dict</span><span class="p">[</span><span class="s1">&#39;mask&#39;</span><span class="p">])</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">pdb</span><span class="p">;</span> <span class="n">pdb</span><span class="o">.</span><span class="n">set_trace</span><span class="p">()</span>
        <span class="n">rgb_dict</span><span class="p">[</span><span class="s1">&#39;edge&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">edge_dict</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">]</span>
        <span class="n">patch_rgb_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">patch_rgb_dict</span><span class="p">[</span><span class="s1">&#39;mask&#39;</span><span class="p">],</span> <span class="n">patch_rgb_dict</span><span class="p">[</span><span class="s1">&#39;context&#39;</span><span class="p">],</span> <span class="n">patch_rgb_dict</span><span class="p">[</span><span class="s1">&#39;rgb&#39;</span><span class="p">],</span> \
            <span class="n">patch_rgb_dict</span><span class="p">[</span><span class="s1">&#39;edge&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">crop_maps_by_size</span><span class="p">(</span><span class="n">union_size</span><span class="p">,</span> <span class="n">rgb_dict</span><span class="p">[</span><span class="s1">&#39;mask&#39;</span><span class="p">],</span>
                                                        <span class="n">rgb_dict</span><span class="p">[</span><span class="s1">&#39;context&#39;</span><span class="p">],</span> <span class="n">rgb_dict</span><span class="p">[</span><span class="s1">&#39;rgb&#39;</span><span class="p">],</span>
                                                        <span class="n">rgb_dict</span><span class="p">[</span><span class="s1">&#39;edge&#39;</span><span class="p">])</span>
        <span class="n">tensor_rgb_dict</span> <span class="o">=</span> <span class="n">convert2tensor</span><span class="p">(</span><span class="n">patch_rgb_dict</span><span class="p">)</span>
        <span class="n">resize_rgb_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">tensor_rgb_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="n">max_hw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">*</span><span class="n">patch_rgb_dict</span><span class="p">[</span><span class="s1">&#39;mask&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]])</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="n">init_frac</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;largest_size&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">*</span><span class="n">patch_rgb_dict</span><span class="p">[</span><span class="s1">&#39;mask&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]])</span><span class="o">.</span><span class="n">prod</span><span class="p">()</span> <span class="o">**</span> <span class="mf">0.5</span><span class="p">)</span>
        <span class="n">resize_hw</span> <span class="o">=</span> <span class="p">[</span><span class="n">patch_rgb_dict</span><span class="p">[</span><span class="s1">&#39;mask&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">init_frac</span><span class="p">,</span> <span class="n">patch_rgb_dict</span><span class="p">[</span><span class="s1">&#39;mask&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">init_frac</span><span class="p">]</span>
        <span class="n">resize_max_hw</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">resize_hw</span><span class="p">)</span>
        <span class="n">frac</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">resize_max_hw</span> <span class="o">/</span> <span class="mf">128.</span><span class="p">)</span> <span class="o">*</span> <span class="mf">128.</span><span class="p">)</span> <span class="o">/</span> <span class="n">max_hw</span>
        <span class="k">if</span> <span class="n">frac</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">resize_mark</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">functional</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">resize_rgb_dict</span><span class="p">[</span><span class="s1">&#39;mask&#39;</span><span class="p">],</span>
                                                            <span class="n">resize_rgb_dict</span><span class="p">[</span><span class="s1">&#39;context&#39;</span><span class="p">]),</span>
                                                            <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
                                                            <span class="n">scale_factor</span><span class="o">=</span><span class="n">frac</span><span class="p">,</span>
                                                            <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;area&#39;</span><span class="p">)</span>
            <span class="n">resize_rgb_dict</span><span class="p">[</span><span class="s1">&#39;mask&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">resize_mark</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>
            <span class="n">resize_rgb_dict</span><span class="p">[</span><span class="s1">&#39;context&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">resize_mark</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>
            <span class="n">resize_rgb_dict</span><span class="p">[</span><span class="s1">&#39;context&#39;</span><span class="p">][</span><span class="n">resize_rgb_dict</span><span class="p">[</span><span class="s1">&#39;mask&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">resize_rgb_dict</span><span class="p">[</span><span class="s1">&#39;rgb&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">functional</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="n">resize_rgb_dict</span><span class="p">[</span><span class="s1">&#39;rgb&#39;</span><span class="p">],</span>
                                                                        <span class="n">scale_factor</span><span class="o">=</span><span class="n">frac</span><span class="p">,</span>
                                                                        <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;area&#39;</span><span class="p">)</span>
            <span class="n">resize_rgb_dict</span><span class="p">[</span><span class="s1">&#39;rgb&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">resize_rgb_dict</span><span class="p">[</span><span class="s1">&#39;rgb&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">resize_rgb_dict</span><span class="p">[</span><span class="s1">&#39;context&#39;</span><span class="p">]</span>
            <span class="n">resize_rgb_dict</span><span class="p">[</span><span class="s1">&#39;edge&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">functional</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="n">resize_rgb_dict</span><span class="p">[</span><span class="s1">&#39;edge&#39;</span><span class="p">],</span>
                                                                        <span class="n">scale_factor</span><span class="o">=</span><span class="n">frac</span><span class="p">,</span>
                                                                        <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;area&#39;</span><span class="p">)</span>
            <span class="n">resize_rgb_dict</span><span class="p">[</span><span class="s1">&#39;edge&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">resize_rgb_dict</span><span class="p">[</span><span class="s1">&#39;edge&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span> <span class="o">*</span> <span class="mi">0</span>
            <span class="n">resize_rgb_dict</span><span class="p">[</span><span class="s1">&#39;edge&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">resize_rgb_dict</span><span class="p">[</span><span class="s1">&#39;edge&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">resize_rgb_dict</span><span class="p">[</span><span class="s1">&#39;context&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">resize_rgb_dict</span><span class="p">[</span><span class="s1">&#39;mask&#39;</span><span class="p">])</span>
        <span class="n">rgb_input_feat</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">resize_rgb_dict</span><span class="p">[</span><span class="s1">&#39;rgb&#39;</span><span class="p">],</span> <span class="n">resize_rgb_dict</span><span class="p">[</span><span class="s1">&#39;edge&#39;</span><span class="p">]),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">rgb_input_feat</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">rgb_input_feat</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span>
        <span class="n">resize_mask</span> <span class="o">=</span> <span class="n">open_small_mask</span><span class="p">(</span><span class="n">resize_rgb_dict</span><span class="p">[</span><span class="s1">&#39;mask&#39;</span><span class="p">],</span> <span class="n">resize_rgb_dict</span><span class="p">[</span><span class="s1">&#39;context&#39;</span><span class="p">],</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">41</span><span class="p">)</span>
        <span class="n">specified_hole</span> <span class="o">=</span> <span class="n">resize_mask</span>
        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
            <span class="n">rgb_output</span> <span class="o">=</span> <span class="n">rgb_model</span><span class="o">.</span><span class="n">forward_3P</span><span class="p">(</span><span class="n">specified_hole</span><span class="p">,</span>
                                            <span class="n">resize_rgb_dict</span><span class="p">[</span><span class="s1">&#39;context&#39;</span><span class="p">],</span>
                                            <span class="n">resize_rgb_dict</span><span class="p">[</span><span class="s1">&#39;rgb&#39;</span><span class="p">],</span>
                                            <span class="n">resize_rgb_dict</span><span class="p">[</span><span class="s1">&#39;edge&#39;</span><span class="p">],</span>
                                            <span class="n">unit_length</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span>
                                            <span class="n">cuda</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
            <span class="n">rgb_output</span> <span class="o">=</span> <span class="n">rgb_output</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;gray_image&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">rgb_output</span> <span class="o">=</span> <span class="n">rgb_output</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">repeat</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
            <span class="n">rgb_output</span> <span class="o">=</span> <span class="n">rgb_output</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
        <span class="n">resize_rgb_dict</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rgb_output</span> <span class="o">*</span> <span class="n">resize_rgb_dict</span><span class="p">[</span><span class="s1">&#39;mask&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">resize_rgb_dict</span><span class="p">[</span><span class="s1">&#39;rgb&#39;</span><span class="p">]</span>
        <span class="n">tensor_rgb_dict</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">resize_rgb_dict</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">frac</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">tensor_rgb_dict</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">functional</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="n">tensor_rgb_dict</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">],</span>
                                                                        <span class="n">size</span><span class="o">=</span><span class="n">tensor_rgb_dict</span><span class="p">[</span><span class="s1">&#39;mask&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:],</span>
                                                                        <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;bicubic&#39;</span><span class="p">)</span>
            <span class="n">tensor_rgb_dict</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tensor_rgb_dict</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">]</span> <span class="o">*</span> \
                                         <span class="n">tensor_rgb_dict</span><span class="p">[</span><span class="s1">&#39;mask&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">tensor_rgb_dict</span><span class="p">[</span><span class="s1">&#39;rgb&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">tensor_rgb_dict</span><span class="p">[</span><span class="s1">&#39;context&#39;</span><span class="p">])</span>
        <span class="n">patch_rgb_dict</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tensor_rgb_dict</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">rgb_dict</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;H&#39;</span><span class="p">],</span> <span class="n">mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">],</span> <span class="mi">3</span><span class="p">))</span>
        <span class="n">rgb_dict</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">][</span><span class="n">union_size</span><span class="p">[</span><span class="s1">&#39;x_min&#39;</span><span class="p">]:</span><span class="n">union_size</span><span class="p">[</span><span class="s1">&#39;x_max&#39;</span><span class="p">],</span> <span class="n">union_size</span><span class="p">[</span><span class="s1">&#39;y_min&#39;</span><span class="p">]:</span><span class="n">union_size</span><span class="p">[</span><span class="s1">&#39;y_max&#39;</span><span class="p">]]</span> <span class="o">=</span> \
            <span class="n">patch_rgb_dict</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">require_depth_edge</span><span class="p">(</span><span class="n">patch_edge_dict</span><span class="p">[</span><span class="s1">&#39;edge&#39;</span><span class="p">],</span> <span class="n">patch_edge_dict</span><span class="p">[</span><span class="s1">&#39;mask&#39;</span><span class="p">])</span> <span class="ow">or</span> <span class="n">inpaint_iter</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">edge_occlusion</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">edge_occlusion</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">erode_context_cc</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">rgb_dict</span><span class="p">[</span><span class="s1">&#39;mask&#39;</span><span class="p">][</span><span class="n">node</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">node</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">info</span> <span class="ow">in</span> <span class="n">info_on_pix</span><span class="p">[(</span><span class="n">node</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">node</span><span class="p">[</span><span class="mi">1</span><span class="p">])]:</span>
                    <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;depth&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="nb">abs</span><span class="p">(</span><span class="n">node</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                        <span class="n">info</span><span class="p">[</span><span class="s1">&#39;update_color&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">rgb_dict</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">][</span><span class="n">node</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">node</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">*</span> <span class="mi">255</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">frac</span> <span class="o">&lt;</span> <span class="mf">1.</span><span class="p">:</span>
            <span class="n">depth_edge_dilate_2_color_flag</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">depth_edge_dilate_2_color_flag</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">hxs</span><span class="p">,</span> <span class="n">hys</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">rgb_dict</span><span class="p">[</span><span class="s1">&#39;mask&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">rgb_dict</span><span class="p">[</span><span class="s1">&#39;erode&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">hx</span><span class="p">,</span> <span class="n">hy</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">hxs</span><span class="p">,</span> <span class="n">hys</span><span class="p">):</span>
            <span class="n">real_depth</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">depth_dict</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">][</span><span class="n">hx</span><span class="p">,</span> <span class="n">hy</span><span class="p">])</span> <span class="o">&lt;=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">np_depth</span><span class="p">[</span><span class="n">hx</span><span class="p">,</span> <span class="n">hy</span><span class="p">]):</span>
                <span class="n">depth_dict</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">][</span><span class="n">hx</span><span class="p">,</span> <span class="n">hy</span><span class="p">]</span> <span class="o">=</span> <span class="n">np_depth</span><span class="p">[</span><span class="n">hx</span><span class="p">,</span> <span class="n">hy</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.01</span>
            <span class="n">node</span> <span class="o">=</span> <span class="p">(</span><span class="n">hx</span><span class="p">,</span> <span class="n">hy</span><span class="p">,</span> <span class="o">-</span><span class="n">depth_dict</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">][</span><span class="n">hx</span><span class="p">,</span> <span class="n">hy</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">info_on_pix</span><span class="o">.</span><span class="n">get</span><span class="p">((</span><span class="n">node</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">node</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">info</span> <span class="ow">in</span> <span class="n">info_on_pix</span><span class="o">.</span><span class="n">get</span><span class="p">((</span><span class="n">node</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">node</span><span class="p">[</span><span class="mi">1</span><span class="p">])):</span>
                    <span class="k">if</span> <span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;inpaint_id&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">abs</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;inpaint_id&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">mesh</span><span class="o">.</span><span class="n">nodes</span><span class="p">[(</span><span class="n">hx</span><span class="p">,</span> <span class="n">hy</span><span class="p">)][</span><span class="s1">&#39;inpaint_id&#39;</span><span class="p">]):</span>
                        <span class="n">pre_depth</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;depth&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;real_depth&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;real_depth&#39;</span><span class="p">]</span>
                        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">node</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">&lt;</span> <span class="nb">abs</span><span class="p">(</span><span class="n">pre_depth</span><span class="p">):</span>
                            <span class="n">node</span> <span class="o">=</span> <span class="p">(</span><span class="n">node</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">node</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="o">-</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">pre_depth</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.001</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">mesh</span><span class="o">.</span><span class="n">has_node</span><span class="p">(</span><span class="n">node</span><span class="p">):</span>
                <span class="n">real_depth</span> <span class="o">=</span> <span class="n">node</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">mesh</span><span class="o">.</span><span class="n">has_node</span><span class="p">(</span><span class="n">node</span><span class="p">):</span>
                    <span class="n">node</span> <span class="o">=</span> <span class="p">(</span><span class="n">node</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">node</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="o">-</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">node</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">+</span> <span class="mf">0.001</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">break</span>
            <span class="k">if</span> <span class="n">real_depth</span> <span class="o">==</span> <span class="n">node</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
                <span class="n">real_depth</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">cur_disp</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="n">node</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">mesh</span><span class="o">.</span><span class="n">has_node</span><span class="p">(</span><span class="n">node</span><span class="p">)):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">mesh</span><span class="o">.</span><span class="n">has_node</span><span class="p">((</span><span class="n">node</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">node</span><span class="p">[</span><span class="mi">1</span><span class="p">])):</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;2D node not found.&quot;</span><span class="p">)</span>
                    <span class="kn">import</span> <span class="nn">pdb</span><span class="p">;</span> <span class="n">pdb</span><span class="o">.</span><span class="n">set_trace</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">inpaint_iter</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">paint</span> <span class="o">=</span> <span class="p">(</span><span class="n">rgb_dict</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">][</span><span class="n">hx</span><span class="p">,</span> <span class="n">hy</span><span class="p">]</span> <span class="o">*</span> <span class="mi">255</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">paint</span> <span class="o">=</span> <span class="p">(</span><span class="n">rgb_dict</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">][</span><span class="n">hx</span><span class="p">,</span> <span class="n">hy</span><span class="p">]</span> <span class="o">*</span> <span class="mi">255</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
                <span class="n">ndict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">paint</span><span class="p">,</span>
                                <span class="n">synthesis</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                <span class="n">disp</span><span class="o">=</span><span class="n">cur_disp</span><span class="p">,</span>
                                <span class="n">cc_id</span><span class="o">=</span><span class="nb">set</span><span class="p">([</span><span class="n">edge_id</span><span class="p">]),</span>
                                <span class="n">overlap_number</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
                                <span class="n">refine_depth</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                <span class="n">edge_occlusion</span><span class="o">=</span><span class="n">edge_occlusion</span><span class="p">,</span>
                                <span class="n">depth_edge_dilate_2_color_flag</span><span class="o">=</span><span class="n">depth_edge_dilate_2_color_flag</span><span class="p">,</span>
                                <span class="n">real_depth</span><span class="o">=</span><span class="n">real_depth</span><span class="p">)</span>
                <span class="n">mesh</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">refresh_node</span><span class="p">((</span><span class="n">node</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">node</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">mesh</span><span class="o">.</span><span class="n">nodes</span><span class="p">[(</span><span class="n">node</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">node</span><span class="p">[</span><span class="mi">1</span><span class="p">])],</span> <span class="n">node</span><span class="p">,</span> <span class="n">ndict</span><span class="p">,</span> <span class="n">mesh</span><span class="p">,</span> <span class="n">stime</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">inpaint_iter</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">mesh</span><span class="o">.</span><span class="n">degree</span><span class="p">(</span><span class="n">node</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">:</span>
                    <span class="n">connnect_points_ccs</span><span class="p">[</span><span class="n">edge_id</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">info_on_pix</span><span class="o">.</span><span class="n">get</span><span class="p">((</span><span class="n">hx</span><span class="p">,</span> <span class="n">hy</span><span class="p">))</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">info_on_pix</span><span class="p">[(</span><span class="n">hx</span><span class="p">,</span> <span class="n">hy</span><span class="p">)]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">new_info</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;depth&#39;</span><span class="p">:</span><span class="n">node</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                        <span class="s1">&#39;color&#39;</span><span class="p">:</span> <span class="n">paint</span><span class="p">,</span>
                        <span class="s1">&#39;synthesis&#39;</span><span class="p">:</span><span class="kc">True</span><span class="p">,</span>
                        <span class="s1">&#39;disp&#39;</span><span class="p">:</span><span class="n">cur_disp</span><span class="p">,</span>
                        <span class="s1">&#39;cc_id&#39;</span><span class="p">:</span><span class="nb">set</span><span class="p">([</span><span class="n">edge_id</span><span class="p">]),</span>
                        <span class="s1">&#39;inpaint_id&#39;</span><span class="p">:</span><span class="n">inpaint_iter</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                        <span class="s1">&#39;edge_occlusion&#39;</span><span class="p">:</span><span class="n">edge_occlusion</span><span class="p">,</span>
                        <span class="s1">&#39;overlap_number&#39;</span><span class="p">:</span><span class="mf">1.0</span><span class="p">,</span>
                        <span class="s1">&#39;real_depth&#39;</span><span class="p">:</span> <span class="n">real_depth</span><span class="p">}</span>
            <span class="n">info_on_pix</span><span class="p">[(</span><span class="n">hx</span><span class="p">,</span> <span class="n">hy</span><span class="p">)]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_info</span><span class="p">)</span>
    <span class="n">specific_edge_id</span> <span class="o">=</span> <span class="n">tmp_specific_edge_id</span>
    <span class="k">for</span> <span class="n">erode_id</span><span class="p">,</span> <span class="n">erode_context_cc</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">erode_context_ccs</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">specific_edge_id</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">erode_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">specific_edge_id</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">for</span> <span class="n">erode_node</span> <span class="ow">in</span> <span class="n">erode_context_cc</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">info</span> <span class="ow">in</span> <span class="n">info_on_pix</span><span class="p">[(</span><span class="n">erode_node</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">erode_node</span><span class="p">[</span><span class="mi">1</span><span class="p">])]:</span>
                <span class="k">if</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;depth&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">erode_node</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
                    <span class="n">info</span><span class="p">[</span><span class="s1">&#39;color&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;update_color&#39;</span><span class="p">]</span>
                    <span class="n">mesh</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">erode_node</span><span class="p">][</span><span class="s1">&#39;color&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;update_color&#39;</span><span class="p">]</span>
                    <span class="n">np_image</span><span class="p">[(</span><span class="n">erode_node</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">erode_node</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;update_color&#39;</span><span class="p">]</span>
    <span class="n">new_edge_ccs</span> <span class="o">=</span> <span class="p">[</span><span class="nb">set</span><span class="p">()</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;max_edge_id&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span>
    <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">mesh</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">node</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">mesh</span><span class="o">.</span><span class="n">remove_node</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">mesh</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;edge_id&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">mesh</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;inpaint_id&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="n">inpaint_iter</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">mesh</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;inpaint_twice&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">new_edge_ccs</span><span class="p">[</span><span class="n">mesh</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;edge_id&#39;</span><span class="p">)]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="kn">import</span> <span class="nn">pdb</span><span class="p">;</span> <span class="n">pdb</span><span class="o">.</span><span class="n">set_trace</span><span class="p">()</span>
    <span class="n">specific_mask_nodes</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">inpaint_iter</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">mesh</span><span class="p">,</span> <span class="n">info_on_pix</span> <span class="o">=</span> <span class="n">refine_color_around_edge</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">info_on_pix</span><span class="p">,</span> <span class="n">new_edge_ccs</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">mesh</span><span class="p">,</span> <span class="n">info_on_pix</span><span class="p">,</span> <span class="n">specific_mask_nodes</span><span class="p">,</span> <span class="n">new_edge_ccs</span><span class="p">,</span> <span class="n">connnect_points_ccs</span><span class="p">,</span> <span class="n">np_image</span>


<span class="k">def</span> <span class="nf">write_ply</span><span class="p">(</span><span class="n">image</span><span class="p">,</span>
              <span class="n">depth</span><span class="p">,</span>
              <span class="n">int_mtx</span><span class="p">,</span>
              <span class="n">ply_name</span><span class="p">,</span>
              <span class="n">config</span><span class="p">,</span>
              <span class="n">rgb_model</span><span class="p">,</span>
              <span class="n">depth_edge_model</span><span class="p">,</span>
              <span class="n">depth_edge_model_init</span><span class="p">,</span>
              <span class="n">depth_feat_model</span><span class="p">):</span>
    <span class="n">depth</span> <span class="o">=</span> <span class="n">depth</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">input_mesh</span><span class="p">,</span> <span class="n">xy2depth</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">depth</span> <span class="o">=</span> <span class="n">create_mesh</span><span class="p">(</span><span class="n">depth</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">int_mtx</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>

    <span class="n">H</span><span class="p">,</span> <span class="n">W</span> <span class="o">=</span> <span class="n">input_mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;H&#39;</span><span class="p">],</span> <span class="n">input_mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span>
    <span class="n">input_mesh</span> <span class="o">=</span> <span class="n">tear_edges</span><span class="p">(</span><span class="n">input_mesh</span><span class="p">,</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;depth_threshold&#39;</span><span class="p">],</span> <span class="n">xy2depth</span><span class="p">)</span>
    <span class="n">input_mesh</span><span class="p">,</span> <span class="n">info_on_pix</span> <span class="o">=</span> <span class="n">generate_init_node</span><span class="p">(</span><span class="n">input_mesh</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">min_node_in_cc</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
    <span class="n">edge_ccs</span><span class="p">,</span> <span class="n">input_mesh</span><span class="p">,</span> <span class="n">edge_mesh</span> <span class="o">=</span> <span class="n">group_edges</span><span class="p">(</span><span class="n">input_mesh</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">remove_conflict_ordinal</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">edge_canvas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">H</span><span class="p">,</span> <span class="n">W</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span>

    <span class="n">input_mesh</span><span class="p">,</span> <span class="n">info_on_pix</span><span class="p">,</span> <span class="n">depth</span> <span class="o">=</span> <span class="n">reassign_floating_island</span><span class="p">(</span><span class="n">input_mesh</span><span class="p">,</span> <span class="n">info_on_pix</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">depth</span><span class="p">)</span>
    <span class="n">input_mesh</span> <span class="o">=</span> <span class="n">update_status</span><span class="p">(</span><span class="n">input_mesh</span><span class="p">,</span> <span class="n">info_on_pix</span><span class="p">)</span>
    <span class="n">specific_edge_id</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">edge_ccs</span><span class="p">,</span> <span class="n">input_mesh</span><span class="p">,</span> <span class="n">edge_mesh</span> <span class="o">=</span> <span class="n">group_edges</span><span class="p">(</span><span class="n">input_mesh</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">remove_conflict_ordinal</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">pre_depth</span> <span class="o">=</span> <span class="n">depth</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">input_mesh</span><span class="p">,</span> <span class="n">info_on_pix</span><span class="p">,</span> <span class="n">edge_mesh</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">aft_mark</span> <span class="o">=</span> <span class="n">remove_dangling</span><span class="p">(</span><span class="n">input_mesh</span><span class="p">,</span> <span class="n">edge_ccs</span><span class="p">,</span> <span class="n">edge_mesh</span><span class="p">,</span> <span class="n">info_on_pix</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>

    <span class="n">input_mesh</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">info_on_pix</span> <span class="o">=</span> <span class="n">update_status</span><span class="p">(</span><span class="n">input_mesh</span><span class="p">,</span> <span class="n">info_on_pix</span><span class="p">,</span> <span class="n">depth</span><span class="p">)</span>
    <span class="n">edge_ccs</span><span class="p">,</span> <span class="n">input_mesh</span><span class="p">,</span> <span class="n">edge_mesh</span> <span class="o">=</span> <span class="n">group_edges</span><span class="p">(</span><span class="n">input_mesh</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">remove_conflict_ordinal</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">edge_canvas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">H</span><span class="p">,</span> <span class="n">W</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span>

    <span class="n">mesh</span><span class="p">,</span> <span class="n">info_on_pix</span><span class="p">,</span> <span class="n">depth</span> <span class="o">=</span> <span class="n">fill_missing_node</span><span class="p">(</span><span class="n">input_mesh</span><span class="p">,</span> <span class="n">info_on_pix</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">depth</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;extrapolate_border&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">pre_depth</span> <span class="o">=</span> <span class="n">depth</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">input_mesh</span><span class="p">,</span> <span class="n">info_on_pix</span><span class="p">,</span> <span class="n">depth</span> <span class="o">=</span> <span class="n">refresh_bord_depth</span><span class="p">(</span><span class="n">input_mesh</span><span class="p">,</span> <span class="n">info_on_pix</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">depth</span><span class="p">)</span>
        <span class="n">input_mesh</span> <span class="o">=</span> <span class="n">remove_node_feat</span><span class="p">(</span><span class="n">input_mesh</span><span class="p">,</span> <span class="s1">&#39;edge_id&#39;</span><span class="p">)</span>
        <span class="n">aft_depth</span> <span class="o">=</span> <span class="n">depth</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">input_mesh</span><span class="p">,</span> <span class="n">info_on_pix</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">image</span> <span class="o">=</span> <span class="n">enlarge_border</span><span class="p">(</span><span class="n">input_mesh</span><span class="p">,</span> <span class="n">info_on_pix</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
        <span class="n">noext_H</span><span class="p">,</span> <span class="n">noext_W</span> <span class="o">=</span> <span class="n">H</span><span class="p">,</span> <span class="n">W</span>
        <span class="n">H</span><span class="p">,</span> <span class="n">W</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">input_mesh</span><span class="p">,</span> <span class="n">info_on_pix</span> <span class="o">=</span> <span class="n">fill_dummy_bord</span><span class="p">(</span><span class="n">input_mesh</span><span class="p">,</span> <span class="n">info_on_pix</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
        <span class="n">edge_ccs</span><span class="p">,</span> <span class="n">input_mesh</span><span class="p">,</span> <span class="n">edge_mesh</span> <span class="o">=</span> \
            <span class="n">group_edges</span><span class="p">(</span><span class="n">input_mesh</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">remove_conflict_ordinal</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">input_mesh</span> <span class="o">=</span> <span class="n">combine_end_node</span><span class="p">(</span><span class="n">input_mesh</span><span class="p">,</span> <span class="n">edge_mesh</span><span class="p">,</span> <span class="n">edge_ccs</span><span class="p">,</span> <span class="n">depth</span><span class="p">)</span>
        <span class="n">input_mesh</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">info_on_pix</span> <span class="o">=</span> <span class="n">update_status</span><span class="p">(</span><span class="n">input_mesh</span><span class="p">,</span> <span class="n">info_on_pix</span><span class="p">,</span> <span class="n">depth</span><span class="p">)</span>
        <span class="n">edge_ccs</span><span class="p">,</span> <span class="n">input_mesh</span><span class="p">,</span> <span class="n">edge_mesh</span> <span class="o">=</span> \
            <span class="n">group_edges</span><span class="p">(</span><span class="n">input_mesh</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">remove_conflict_ordinal</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">spdb</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">input_mesh</span> <span class="o">=</span> <span class="n">remove_redundant_edge</span><span class="p">(</span><span class="n">input_mesh</span><span class="p">,</span> <span class="n">edge_mesh</span><span class="p">,</span> <span class="n">edge_ccs</span><span class="p">,</span> <span class="n">info_on_pix</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">redundant_number</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;redundant_number&#39;</span><span class="p">],</span> <span class="n">spdb</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">input_mesh</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">info_on_pix</span> <span class="o">=</span> <span class="n">update_status</span><span class="p">(</span><span class="n">input_mesh</span><span class="p">,</span> <span class="n">info_on_pix</span><span class="p">,</span> <span class="n">depth</span><span class="p">)</span>
        <span class="n">edge_ccs</span><span class="p">,</span> <span class="n">input_mesh</span><span class="p">,</span> <span class="n">edge_mesh</span> <span class="o">=</span> <span class="n">group_edges</span><span class="p">(</span><span class="n">input_mesh</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">remove_conflict_ordinal</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">input_mesh</span> <span class="o">=</span> <span class="n">combine_end_node</span><span class="p">(</span><span class="n">input_mesh</span><span class="p">,</span> <span class="n">edge_mesh</span><span class="p">,</span> <span class="n">edge_ccs</span><span class="p">,</span> <span class="n">depth</span><span class="p">)</span>
        <span class="n">input_mesh</span> <span class="o">=</span> <span class="n">remove_redundant_edge</span><span class="p">(</span><span class="n">input_mesh</span><span class="p">,</span> <span class="n">edge_mesh</span><span class="p">,</span> <span class="n">edge_ccs</span><span class="p">,</span> <span class="n">info_on_pix</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">redundant_number</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;redundant_number&#39;</span><span class="p">],</span> <span class="n">invalid</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">spdb</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">input_mesh</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">info_on_pix</span> <span class="o">=</span> <span class="n">update_status</span><span class="p">(</span><span class="n">input_mesh</span><span class="p">,</span> <span class="n">info_on_pix</span><span class="p">,</span> <span class="n">depth</span><span class="p">)</span>
        <span class="n">edge_ccs</span><span class="p">,</span> <span class="n">input_mesh</span><span class="p">,</span> <span class="n">edge_mesh</span> <span class="o">=</span> <span class="n">group_edges</span><span class="p">(</span><span class="n">input_mesh</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">remove_conflict_ordinal</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">input_mesh</span> <span class="o">=</span> <span class="n">combine_end_node</span><span class="p">(</span><span class="n">input_mesh</span><span class="p">,</span> <span class="n">edge_mesh</span><span class="p">,</span> <span class="n">edge_ccs</span><span class="p">,</span> <span class="n">depth</span><span class="p">)</span>
        <span class="n">input_mesh</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">info_on_pix</span> <span class="o">=</span> <span class="n">update_status</span><span class="p">(</span><span class="n">input_mesh</span><span class="p">,</span> <span class="n">info_on_pix</span><span class="p">,</span> <span class="n">depth</span><span class="p">)</span>
        <span class="n">edge_ccs</span><span class="p">,</span> <span class="n">input_mesh</span><span class="p">,</span> <span class="n">edge_mesh</span> <span class="o">=</span> <span class="n">group_edges</span><span class="p">(</span><span class="n">input_mesh</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">remove_conflict_ordinal</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">edge_condition</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">m</span><span class="p">:</span> <span class="n">m</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">x</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;far&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">x</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;far&#39;</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="n">edge_map</span> <span class="o">=</span> <span class="n">get_map_from_ccs</span><span class="p">(</span><span class="n">edge_ccs</span><span class="p">,</span> <span class="n">input_mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;H&#39;</span><span class="p">],</span> <span class="n">input_mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">],</span> <span class="n">input_mesh</span><span class="p">,</span> <span class="n">edge_condition</span><span class="p">)</span>
        <span class="n">other_edge_with_id</span> <span class="o">=</span> <span class="n">get_map_from_ccs</span><span class="p">(</span><span class="n">edge_ccs</span><span class="p">,</span> <span class="n">input_mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;H&#39;</span><span class="p">],</span> <span class="n">input_mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">],</span> <span class="n">real_id</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">info_on_pix</span><span class="p">,</span> <span class="n">input_mesh</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">edge_ccs</span> <span class="o">=</span> <span class="n">extrapolate</span><span class="p">(</span><span class="n">input_mesh</span><span class="p">,</span> <span class="n">info_on_pix</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">other_edge_with_id</span><span class="p">,</span> <span class="n">edge_map</span><span class="p">,</span> <span class="n">edge_ccs</span><span class="p">,</span>
                                                <span class="n">depth_edge_model</span><span class="p">,</span> <span class="n">depth_feat_model</span><span class="p">,</span> <span class="n">rgb_model</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">direc</span><span class="o">=</span><span class="s2">&quot;up&quot;</span><span class="p">)</span>
        <span class="n">info_on_pix</span><span class="p">,</span> <span class="n">input_mesh</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">edge_ccs</span> <span class="o">=</span> <span class="n">extrapolate</span><span class="p">(</span><span class="n">input_mesh</span><span class="p">,</span> <span class="n">info_on_pix</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">other_edge_with_id</span><span class="p">,</span> <span class="n">edge_map</span><span class="p">,</span> <span class="n">edge_ccs</span><span class="p">,</span>
                                                <span class="n">depth_edge_model</span><span class="p">,</span> <span class="n">depth_feat_model</span><span class="p">,</span> <span class="n">rgb_model</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">direc</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>
        <span class="n">info_on_pix</span><span class="p">,</span> <span class="n">input_mesh</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">edge_ccs</span> <span class="o">=</span> <span class="n">extrapolate</span><span class="p">(</span><span class="n">input_mesh</span><span class="p">,</span> <span class="n">info_on_pix</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">other_edge_with_id</span><span class="p">,</span> <span class="n">edge_map</span><span class="p">,</span> <span class="n">edge_ccs</span><span class="p">,</span>
                                                <span class="n">depth_edge_model</span><span class="p">,</span> <span class="n">depth_feat_model</span><span class="p">,</span> <span class="n">rgb_model</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">direc</span><span class="o">=</span><span class="s2">&quot;down&quot;</span><span class="p">)</span>
        <span class="n">info_on_pix</span><span class="p">,</span> <span class="n">input_mesh</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">edge_ccs</span> <span class="o">=</span> <span class="n">extrapolate</span><span class="p">(</span><span class="n">input_mesh</span><span class="p">,</span> <span class="n">info_on_pix</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">other_edge_with_id</span><span class="p">,</span> <span class="n">edge_map</span><span class="p">,</span> <span class="n">edge_ccs</span><span class="p">,</span>
                                                <span class="n">depth_edge_model</span><span class="p">,</span> <span class="n">depth_feat_model</span><span class="p">,</span> <span class="n">rgb_model</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">direc</span><span class="o">=</span><span class="s2">&quot;right&quot;</span><span class="p">)</span>
        <span class="n">info_on_pix</span><span class="p">,</span> <span class="n">input_mesh</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">edge_ccs</span> <span class="o">=</span> <span class="n">extrapolate</span><span class="p">(</span><span class="n">input_mesh</span><span class="p">,</span> <span class="n">info_on_pix</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">other_edge_with_id</span><span class="p">,</span> <span class="n">edge_map</span><span class="p">,</span> <span class="n">edge_ccs</span><span class="p">,</span>
                                                <span class="n">depth_edge_model</span><span class="p">,</span> <span class="n">depth_feat_model</span><span class="p">,</span> <span class="n">rgb_model</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">direc</span><span class="o">=</span><span class="s2">&quot;right-up&quot;</span><span class="p">)</span>
        <span class="n">info_on_pix</span><span class="p">,</span> <span class="n">input_mesh</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">edge_ccs</span> <span class="o">=</span> <span class="n">extrapolate</span><span class="p">(</span><span class="n">input_mesh</span><span class="p">,</span> <span class="n">info_on_pix</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">other_edge_with_id</span><span class="p">,</span> <span class="n">edge_map</span><span class="p">,</span> <span class="n">edge_ccs</span><span class="p">,</span>
                                                <span class="n">depth_edge_model</span><span class="p">,</span> <span class="n">depth_feat_model</span><span class="p">,</span> <span class="n">rgb_model</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">direc</span><span class="o">=</span><span class="s2">&quot;right-down&quot;</span><span class="p">)</span>
        <span class="n">info_on_pix</span><span class="p">,</span> <span class="n">input_mesh</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">edge_ccs</span> <span class="o">=</span> <span class="n">extrapolate</span><span class="p">(</span><span class="n">input_mesh</span><span class="p">,</span> <span class="n">info_on_pix</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">other_edge_with_id</span><span class="p">,</span> <span class="n">edge_map</span><span class="p">,</span> <span class="n">edge_ccs</span><span class="p">,</span>
                                                <span class="n">depth_edge_model</span><span class="p">,</span> <span class="n">depth_feat_model</span><span class="p">,</span> <span class="n">rgb_model</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">direc</span><span class="o">=</span><span class="s2">&quot;left-up&quot;</span><span class="p">)</span>
        <span class="n">info_on_pix</span><span class="p">,</span> <span class="n">input_mesh</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">edge_ccs</span> <span class="o">=</span> <span class="n">extrapolate</span><span class="p">(</span><span class="n">input_mesh</span><span class="p">,</span> <span class="n">info_on_pix</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">other_edge_with_id</span><span class="p">,</span> <span class="n">edge_map</span><span class="p">,</span> <span class="n">edge_ccs</span><span class="p">,</span>
                                                <span class="n">depth_edge_model</span><span class="p">,</span> <span class="n">depth_feat_model</span><span class="p">,</span> <span class="n">rgb_model</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">direc</span><span class="o">=</span><span class="s2">&quot;left-down&quot;</span><span class="p">)</span>
    <span class="n">specific_edge_loc</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">specific_edge_id</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">vis_edge_id</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">context_ccs</span><span class="p">,</span> <span class="n">mask_ccs</span><span class="p">,</span> <span class="n">broken_mask_ccs</span><span class="p">,</span> <span class="n">edge_ccs</span><span class="p">,</span> <span class="n">erode_context_ccs</span><span class="p">,</span> \
        <span class="n">init_mask_connect</span><span class="p">,</span> <span class="n">edge_maps</span><span class="p">,</span> <span class="n">extend_context_ccs</span><span class="p">,</span> <span class="n">extend_edge_ccs</span><span class="p">,</span> <span class="n">extend_erode_context_ccs</span> <span class="o">=</span> \
                                                                                <span class="n">context_and_holes</span><span class="p">(</span><span class="n">input_mesh</span><span class="p">,</span>
                                                                                            <span class="n">edge_ccs</span><span class="p">,</span>
                                                                                            <span class="n">config</span><span class="p">,</span>
                                                                                            <span class="n">specific_edge_id</span><span class="p">,</span>
                                                                                            <span class="n">specific_edge_loc</span><span class="p">,</span>
                                                                                            <span class="n">depth_feat_model</span><span class="p">,</span>
                                                                                            <span class="n">inpaint_iter</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                                                                            <span class="n">vis_edge_id</span><span class="o">=</span><span class="n">vis_edge_id</span><span class="p">)</span>
    <span class="n">edge_canvas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">H</span><span class="p">,</span> <span class="n">W</span><span class="p">))</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">H</span><span class="p">,</span> <span class="n">W</span><span class="p">))</span>
    <span class="n">context</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">H</span><span class="p">,</span> <span class="n">W</span><span class="p">))</span>
    <span class="n">vis_edge_ccs</span> <span class="o">=</span> <span class="n">filter_edge</span><span class="p">(</span><span class="n">input_mesh</span><span class="p">,</span> <span class="n">edge_ccs</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
    <span class="n">edge_canvas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">input_mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;H&#39;</span><span class="p">],</span> <span class="n">input_mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]))</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">specific_edge_loc</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">FG_edge_maps</span> <span class="o">=</span> <span class="n">edge_maps</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">edge_canvas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">input_mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;H&#39;</span><span class="p">],</span> <span class="n">input_mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]))</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="c1"># for cc_id, cc in enumerate(edge_ccs):</span>
    <span class="c1">#     for node in cc:</span>
    <span class="c1">#         edge_canvas[node[0], node[1]] = cc_id</span>
    <span class="c1"># f, ((ax0, ax1, ax2)) = plt.subplots(1, 3, sharex=True, sharey=True); ax0.imshow(1./depth); ax1.imshow(image); ax2.imshow(edge_canvas); plt.show()</span>
    <span class="n">input_mesh</span><span class="p">,</span> <span class="n">info_on_pix</span><span class="p">,</span> <span class="n">specific_edge_nodes</span><span class="p">,</span> <span class="n">new_edge_ccs</span><span class="p">,</span> <span class="n">connect_points_ccs</span><span class="p">,</span> <span class="n">image</span> <span class="o">=</span> <span class="n">DL_inpaint_edge</span><span class="p">(</span><span class="n">input_mesh</span><span class="p">,</span>
                                                                                                            <span class="n">info_on_pix</span><span class="p">,</span>
                                                                                                            <span class="n">config</span><span class="p">,</span>
                                                                                                            <span class="n">image</span><span class="p">,</span>
                                                                                                            <span class="n">depth</span><span class="p">,</span>
                                                                                                            <span class="n">context_ccs</span><span class="p">,</span>
                                                                                                            <span class="n">erode_context_ccs</span><span class="p">,</span>
                                                                                                            <span class="n">extend_context_ccs</span><span class="p">,</span>
                                                                                                            <span class="n">extend_erode_context_ccs</span><span class="p">,</span>
                                                                                                            <span class="n">mask_ccs</span><span class="p">,</span>
                                                                                                            <span class="n">broken_mask_ccs</span><span class="p">,</span>
                                                                                                            <span class="n">edge_ccs</span><span class="p">,</span>
                                                                                                            <span class="n">extend_edge_ccs</span><span class="p">,</span>
                                                                                                            <span class="n">init_mask_connect</span><span class="p">,</span>
                                                                                                            <span class="n">edge_maps</span><span class="p">,</span>
                                                                                                            <span class="n">rgb_model</span><span class="p">,</span>
                                                                                                            <span class="n">depth_edge_model</span><span class="p">,</span>
                                                                                                            <span class="n">depth_edge_model_init</span><span class="p">,</span>
                                                                                                            <span class="n">depth_feat_model</span><span class="p">,</span>
                                                                                                            <span class="n">specific_edge_id</span><span class="p">,</span>
                                                                                                            <span class="n">specific_edge_loc</span><span class="p">,</span>
                                                                                                            <span class="n">inpaint_iter</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">specific_edge_id</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">edge_canvas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">input_mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;H&#39;</span><span class="p">],</span> <span class="n">input_mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]))</span>
    <span class="n">connect_points_ccs</span> <span class="o">=</span> <span class="p">[</span><span class="nb">set</span><span class="p">()</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">connect_points_ccs</span><span class="p">]</span>
    <span class="n">context_ccs</span><span class="p">,</span> <span class="n">mask_ccs</span><span class="p">,</span> <span class="n">broken_mask_ccs</span><span class="p">,</span> <span class="n">edge_ccs</span><span class="p">,</span> <span class="n">erode_context_ccs</span><span class="p">,</span> <span class="n">init_mask_connect</span><span class="p">,</span> \
        <span class="n">edge_maps</span><span class="p">,</span> <span class="n">extend_context_ccs</span><span class="p">,</span> <span class="n">extend_edge_ccs</span><span class="p">,</span> <span class="n">extend_erode_context_ccs</span> <span class="o">=</span> \
            <span class="n">context_and_holes</span><span class="p">(</span><span class="n">input_mesh</span><span class="p">,</span> <span class="n">new_edge_ccs</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">specific_edge_id</span><span class="p">,</span> <span class="n">specific_edge_loc</span><span class="p">,</span> <span class="n">depth_feat_model</span><span class="p">,</span> <span class="n">connect_points_ccs</span><span class="p">,</span> <span class="n">inpaint_iter</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">mask_canvas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">input_mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;H&#39;</span><span class="p">],</span> <span class="n">input_mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]))</span>
    <span class="n">context_canvas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">input_mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;H&#39;</span><span class="p">],</span> <span class="n">input_mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]))</span>
    <span class="n">erode_context_ccs_canvas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">input_mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;H&#39;</span><span class="p">],</span> <span class="n">input_mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]))</span>
    <span class="n">edge_canvas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">input_mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;H&#39;</span><span class="p">],</span> <span class="n">input_mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]))</span>
    <span class="c1"># edge_canvas = np.zeros((input_mesh.graph[&#39;H&#39;], input_mesh.graph[&#39;W&#39;])) - 1</span>
    <span class="c1"># for cc_id, cc in enumerate(edge_ccs):</span>
    <span class="c1">#     for node in cc:</span>
    <span class="c1">#         edge_canvas[node[0], node[1]] = cc_id</span>
    <span class="n">specific_edge_id</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">input_mesh</span><span class="p">,</span> <span class="n">info_on_pix</span><span class="p">,</span> <span class="n">specific_edge_nodes</span><span class="p">,</span> <span class="n">new_edge_ccs</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">image</span> <span class="o">=</span> <span class="n">DL_inpaint_edge</span><span class="p">(</span><span class="n">input_mesh</span><span class="p">,</span>
                                                                                    <span class="n">info_on_pix</span><span class="p">,</span>
                                                                                    <span class="n">config</span><span class="p">,</span>
                                                                                    <span class="n">image</span><span class="p">,</span>
                                                                                    <span class="n">depth</span><span class="p">,</span>
                                                                                    <span class="n">context_ccs</span><span class="p">,</span>
                                                                                    <span class="n">erode_context_ccs</span><span class="p">,</span>
                                                                                    <span class="n">extend_context_ccs</span><span class="p">,</span>
                                                                                    <span class="n">extend_erode_context_ccs</span><span class="p">,</span>
                                                                                    <span class="n">mask_ccs</span><span class="p">,</span>
                                                                                    <span class="n">broken_mask_ccs</span><span class="p">,</span>
                                                                                    <span class="n">edge_ccs</span><span class="p">,</span>
                                                                                    <span class="n">extend_edge_ccs</span><span class="p">,</span>
                                                                                    <span class="n">init_mask_connect</span><span class="p">,</span>
                                                                                    <span class="n">edge_maps</span><span class="p">,</span>
                                                                                    <span class="n">rgb_model</span><span class="p">,</span>
                                                                                    <span class="n">depth_edge_model</span><span class="p">,</span>
                                                                                    <span class="n">depth_edge_model_init</span><span class="p">,</span>
                                                                                    <span class="n">depth_feat_model</span><span class="p">,</span>
                                                                                    <span class="n">specific_edge_id</span><span class="p">,</span>
                                                                                    <span class="n">specific_edge_loc</span><span class="p">,</span>
                                                                                    <span class="n">inpaint_iter</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">vertex_id</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">input_mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;H&#39;</span><span class="p">],</span> <span class="n">input_mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">input_mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;noext_H&#39;</span><span class="p">],</span> <span class="n">input_mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;noext_W&#39;</span><span class="p">]</span>
    <span class="n">background_canvas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">input_mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;H&#39;</span><span class="p">],</span>
                                  <span class="n">input_mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">],</span>
                                  <span class="mi">3</span><span class="p">))</span>
    <span class="n">ply_flag</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;save_ply&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ply_flag</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">node_str_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">node_str_color</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">node_str_point</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">out_fmt</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">x_flag</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">if</span> <span class="n">x_flag</span> <span class="ow">is</span> <span class="kc">True</span> <span class="k">else</span> <span class="n">x</span>
    <span class="n">point_time</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">hlight_time</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">cur_id_time</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">node_str_time</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">generate_face_time</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">point_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">k_00</span><span class="p">,</span> <span class="n">k_02</span><span class="p">,</span> <span class="n">k_11</span><span class="p">,</span> <span class="n">k_12</span> <span class="o">=</span> \
        <span class="n">input_mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;cam_param_pix_inv&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">input_mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;cam_param_pix_inv&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> \
        <span class="n">input_mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;cam_param_pix_inv&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">input_mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;cam_param_pix_inv&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
    <span class="n">w_offset</span> <span class="o">=</span> <span class="n">input_mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;woffset&#39;</span><span class="p">]</span>
    <span class="n">h_offset</span> <span class="o">=</span> <span class="n">input_mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;hoffset&#39;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">pix_xy</span><span class="p">,</span> <span class="n">pix_list</span> <span class="ow">in</span> <span class="n">info_on_pix</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">pix_idx</span><span class="p">,</span> <span class="n">pix_info</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pix_list</span><span class="p">):</span>
            <span class="n">pix_depth</span> <span class="o">=</span> <span class="n">pix_info</span><span class="p">[</span><span class="s1">&#39;depth&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">pix_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;real_depth&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">pix_info</span><span class="p">[</span><span class="s1">&#39;real_depth&#39;</span><span class="p">]</span>
            <span class="n">str_pt</span> <span class="o">=</span> <span class="p">[</span><span class="n">out_fmt</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">ply_flag</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">reproject_3d_int_detail</span><span class="p">(</span><span class="n">pix_xy</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pix_xy</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pix_depth</span><span class="p">,</span>
                      <span class="n">k_00</span><span class="p">,</span> <span class="n">k_02</span><span class="p">,</span> <span class="n">k_11</span><span class="p">,</span> <span class="n">k_12</span><span class="p">,</span> <span class="n">w_offset</span><span class="p">,</span> <span class="n">h_offset</span><span class="p">)]</span>
            <span class="k">if</span> <span class="n">input_mesh</span><span class="o">.</span><span class="n">has_node</span><span class="p">((</span><span class="n">pix_xy</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pix_xy</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pix_info</span><span class="p">[</span><span class="s1">&#39;depth&#39;</span><span class="p">]))</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">pix_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;overlap_number&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">str_color</span> <span class="o">=</span> <span class="p">[</span><span class="n">out_fmt</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">ply_flag</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">(</span><span class="n">pix_info</span><span class="p">[</span><span class="s1">&#39;color&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">pix_info</span><span class="p">[</span><span class="s1">&#39;overlap_number&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">str_color</span> <span class="o">=</span> <span class="p">[</span><span class="n">out_fmt</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">ply_flag</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">pix_info</span><span class="p">[</span><span class="s1">&#39;color&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()]</span>
            <span class="k">if</span> <span class="n">pix_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;edge_occlusion&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">str_color</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">out_fmt</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">ply_flag</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">pix_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;inpaint_id&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">str_color</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">out_fmt</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">ply_flag</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">str_color</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">out_fmt</span><span class="p">(</span><span class="n">pix_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;inpaint_id&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ply_flag</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">pix_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;modified_border&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">or</span> <span class="n">pix_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ext_pixel&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">str_color</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                    <span class="n">str_color</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">out_fmt</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">ply_flag</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">str_color</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">out_fmt</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">ply_flag</span><span class="p">))</span>
            <span class="n">pix_info</span><span class="p">[</span><span class="s1">&#39;cur_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">vertex_id</span>
            <span class="n">input_mesh</span><span class="o">.</span><span class="n">nodes</span><span class="p">[(</span><span class="n">pix_xy</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pix_xy</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pix_info</span><span class="p">[</span><span class="s1">&#39;depth&#39;</span><span class="p">])][</span><span class="s1">&#39;cur_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">out_fmt</span><span class="p">(</span><span class="n">vertex_id</span><span class="p">,</span> <span class="n">ply_flag</span><span class="p">)</span>
            <span class="n">vertex_id</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">ply_flag</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">node_str_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">str_pt</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">str_color</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">node_str_color</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">str_color</span><span class="p">)</span>
                <span class="n">node_str_point</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">str_pt</span><span class="p">)</span>
    <span class="n">str_faces</span> <span class="o">=</span> <span class="n">generate_face</span><span class="p">(</span><span class="n">input_mesh</span><span class="p">,</span> <span class="n">info_on_pix</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;save_ply&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Writing mesh file </span><span class="si">%s</span><span class="s2"> ...&quot;</span> <span class="o">%</span> <span class="n">ply_name</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">ply_name</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">ply_fi</span><span class="p">:</span>
            <span class="n">ply_fi</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;ply</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s1">&#39;format ascii 1.0</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">ply_fi</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;comment H &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">input_mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;H&#39;</span><span class="p">]))</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">ply_fi</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;comment W &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">input_mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]))</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">ply_fi</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;comment hFov &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">input_mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;hFov&#39;</span><span class="p">]))</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">ply_fi</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;comment vFov &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">input_mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;vFov&#39;</span><span class="p">]))</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">ply_fi</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;element vertex &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">node_str_list</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">ply_fi</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;property float x</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> \
                         <span class="s1">&#39;property float y</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> \
                         <span class="s1">&#39;property float z</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> \
                         <span class="s1">&#39;property uchar red</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> \
                         <span class="s1">&#39;property uchar green</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> \
                         <span class="s1">&#39;property uchar blue</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> \
                         <span class="s1">&#39;property uchar alpha</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">ply_fi</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;element face &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">str_faces</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">ply_fi</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;property list uchar int vertex_index</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">ply_fi</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;end_header</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">ply_fi</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span><span class="n">node_str_list</span><span class="p">)</span>
            <span class="n">ply_fi</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span><span class="n">str_faces</span><span class="p">)</span>
        <span class="n">ply_fi</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">input_mesh</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">H</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">input_mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;H&#39;</span><span class="p">])</span>
        <span class="n">W</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">input_mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">])</span>
        <span class="n">hFov</span> <span class="o">=</span> <span class="n">input_mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;hFov&#39;</span><span class="p">]</span>
        <span class="n">vFov</span> <span class="o">=</span> <span class="n">input_mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;vFov&#39;</span><span class="p">]</span>
        <span class="n">node_str_color</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">node_str_color</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">node_str_color</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">node_str_color</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">/</span> <span class="mf">255.</span>
        <span class="n">node_str_point</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">node_str_point</span><span class="p">)</span>
        <span class="n">str_faces</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">str_faces</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">node_str_point</span><span class="p">,</span> <span class="n">node_str_color</span><span class="p">,</span> <span class="n">str_faces</span><span class="p">,</span> <span class="n">H</span><span class="p">,</span> <span class="n">W</span><span class="p">,</span> <span class="n">hFov</span><span class="p">,</span> <span class="n">vFov</span>

<span class="k">def</span> <span class="nf">read_ply</span><span class="p">(</span><span class="n">mesh_fi</span><span class="p">):</span>
    <span class="n">ply_fi</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">mesh_fi</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
    <span class="n">Height</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">Width</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">hFov</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">vFov</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">ply_fi</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;element vertex&#39;</span><span class="p">):</span>
            <span class="n">num_vertex</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;element face&#39;</span><span class="p">):</span>
            <span class="n">num_face</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;comment&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;H&#39;</span><span class="p">:</span>
                <span class="n">Height</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;W&#39;</span><span class="p">:</span>
                <span class="n">Width</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;hFov&#39;</span><span class="p">:</span>
                <span class="n">hFov</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;vFov&#39;</span><span class="p">:</span>
                <span class="n">vFov</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;end_header&#39;</span><span class="p">):</span>
            <span class="k">break</span>
    <span class="n">contents</span> <span class="o">=</span> <span class="n">ply_fi</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
    <span class="n">vertex_infos</span> <span class="o">=</span> <span class="n">contents</span><span class="p">[:</span><span class="n">num_vertex</span><span class="p">]</span>
    <span class="n">face_infos</span> <span class="o">=</span> <span class="n">contents</span><span class="p">[</span><span class="n">num_vertex</span><span class="p">:]</span>
    <span class="n">verts</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">colors</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">faces</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">v_info</span> <span class="ow">in</span> <span class="n">vertex_infos</span><span class="p">:</span>
        <span class="n">str_info</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">v_info</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">str_info</span><span class="p">)</span> <span class="o">==</span> <span class="mi">6</span><span class="p">:</span>
            <span class="n">vx</span><span class="p">,</span> <span class="n">vy</span><span class="p">,</span> <span class="n">vz</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">str_info</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">vx</span><span class="p">,</span> <span class="n">vy</span><span class="p">,</span> <span class="n">vz</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">hi</span> <span class="o">=</span> <span class="n">str_info</span>
        <span class="n">verts</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">vx</span><span class="p">,</span> <span class="n">vy</span><span class="p">,</span> <span class="n">vz</span><span class="p">])</span>
        <span class="n">colors</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">r</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">hi</span><span class="p">])</span>
    <span class="n">verts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">verts</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">colors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">colors</span><span class="p">)</span>
        <span class="n">colors</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">colors</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="p">:</span><span class="mi">3</span><span class="p">]</span><span class="o">/</span><span class="mf">255.</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">pdb</span>
        <span class="n">pdb</span><span class="o">.</span><span class="n">set_trace</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">f_info</span> <span class="ow">in</span> <span class="n">face_infos</span><span class="p">:</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">,</span> <span class="n">v3</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">f_info</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)]</span>
        <span class="n">faces</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">,</span> <span class="n">v3</span><span class="p">])</span>
    <span class="n">faces</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">faces</span><span class="p">)</span>


    <span class="k">return</span> <span class="n">verts</span><span class="p">,</span> <span class="n">colors</span><span class="p">,</span> <span class="n">faces</span><span class="p">,</span> <span class="n">Height</span><span class="p">,</span> <span class="n">Width</span><span class="p">,</span> <span class="n">hFov</span><span class="p">,</span> <span class="n">vFov</span>


<span class="k">class</span> <span class="nc">Canvas_view</span><span class="p">():</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">fov</span><span class="p">,</span>
                 <span class="n">verts</span><span class="p">,</span>
                 <span class="n">faces</span><span class="p">,</span>
                 <span class="n">colors</span><span class="p">,</span>
                 <span class="n">canvas_size</span><span class="p">,</span>
                 <span class="n">factor</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                 <span class="n">bgcolor</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span>
                 <span class="n">proj</span><span class="o">=</span><span class="s1">&#39;perspective&#39;</span><span class="p">,</span>
                 <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span> <span class="o">=</span> <span class="n">scene</span><span class="o">.</span><span class="n">SceneCanvas</span><span class="p">(</span><span class="n">bgcolor</span><span class="o">=</span><span class="n">bgcolor</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">canvas_size</span><span class="o">*</span><span class="n">factor</span><span class="p">,</span> <span class="n">canvas_size</span><span class="o">*</span><span class="n">factor</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">view</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">central_widget</span><span class="o">.</span><span class="n">add_view</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">camera</span> <span class="o">=</span> <span class="s1">&#39;perspective&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">camera</span><span class="o">.</span><span class="n">fov</span> <span class="o">=</span> <span class="n">fov</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span> <span class="o">=</span> <span class="n">visuals</span><span class="o">.</span><span class="n">Mesh</span><span class="p">(</span><span class="n">shading</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">Alpha</span><span class="p">(</span><span class="mf">1.0</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">camera</span><span class="o">.</span><span class="n">transform</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="n">vertices</span><span class="o">=</span><span class="n">verts</span><span class="p">,</span> <span class="n">faces</span><span class="o">=</span><span class="n">faces</span><span class="p">,</span> <span class="n">vertex_colors</span><span class="o">=</span><span class="n">colors</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">3</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">translate</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rotate</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">angle</span><span class="o">=</span><span class="mi">180</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">view_changed</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">translate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trans</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tr</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="n">trans</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">rotate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">angle</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tr</span><span class="o">.</span><span class="n">rotate</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">,</span> <span class="n">angle</span><span class="o">=</span><span class="n">angle</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">view_changed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">camera</span><span class="o">.</span><span class="n">view_changed</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">render</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">render</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">reinit_mesh</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verts</span><span class="p">,</span> <span class="n">faces</span><span class="p">,</span> <span class="n">colors</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="n">vertices</span><span class="o">=</span><span class="n">verts</span><span class="p">,</span> <span class="n">faces</span><span class="o">=</span><span class="n">faces</span><span class="p">,</span> <span class="n">vertex_colors</span><span class="o">=</span><span class="n">colors</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">3</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">reinit_camera</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fov</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">camera</span><span class="o">.</span><span class="n">fov</span> <span class="o">=</span> <span class="n">fov</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">camera</span><span class="o">.</span><span class="n">view_changed</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">output_3d_photo</span><span class="p">(</span><span class="n">verts</span><span class="p">,</span> <span class="n">colors</span><span class="p">,</span> <span class="n">faces</span><span class="p">,</span> <span class="n">Height</span><span class="p">,</span> <span class="n">Width</span><span class="p">,</span> <span class="n">hFov</span><span class="p">,</span> <span class="n">vFov</span><span class="p">,</span> <span class="n">tgt_poses</span><span class="p">,</span> <span class="n">video_traj_types</span><span class="p">,</span> <span class="n">ref_pose</span><span class="p">,</span>
                    <span class="n">output_dir</span><span class="p">,</span> <span class="n">ref_image</span><span class="p">,</span> <span class="n">int_mtx</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">videos_poses</span><span class="p">,</span> <span class="n">video_basename</span><span class="p">,</span> <span class="n">original_H</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">original_W</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">border</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">normal_canvas</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">all_canvas</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mean_loc_depth</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

    <span class="n">cam_mesh</span> <span class="o">=</span> <span class="n">netx</span><span class="o">.</span><span class="n">Graph</span><span class="p">()</span>
    <span class="n">cam_mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;H&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Height</span>
    <span class="n">cam_mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Width</span>
    <span class="n">cam_mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;original_H&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">original_H</span>
    <span class="n">cam_mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;original_W&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">original_W</span>
    <span class="n">int_mtx_real_x</span> <span class="o">=</span> <span class="n">int_mtx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">Width</span>
    <span class="n">int_mtx_real_y</span> <span class="o">=</span> <span class="n">int_mtx</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">Height</span>
    <span class="n">cam_mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;hFov&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan</span><span class="p">((</span><span class="mf">1.</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">)</span> <span class="o">*</span> <span class="p">((</span><span class="n">cam_mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;original_W&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="n">int_mtx_real_x</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">cam_mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;vFov&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan</span><span class="p">((</span><span class="mf">1.</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">)</span> <span class="o">*</span> <span class="p">((</span><span class="n">cam_mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;original_H&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="n">int_mtx_real_y</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">colors</span> <span class="o">=</span> <span class="n">colors</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="p">:</span><span class="mi">3</span><span class="p">]</span>

    <span class="n">fov_in_rad</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">cam_mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;vFov&#39;</span><span class="p">],</span> <span class="n">cam_mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;hFov&#39;</span><span class="p">])</span>
    <span class="n">fov</span> <span class="o">=</span> <span class="p">(</span><span class="n">fov_in_rad</span> <span class="o">*</span> <span class="mi">180</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;fov: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">fov</span><span class="p">))</span>
    <span class="n">init_factor</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;anti_flickering&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">init_factor</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">cam_mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;original_H&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">cam_mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;original_W&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">canvas_w</span> <span class="o">=</span> <span class="n">cam_mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;original_W&#39;</span><span class="p">]</span>
        <span class="n">canvas_h</span> <span class="o">=</span> <span class="n">cam_mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;original_H&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">canvas_w</span> <span class="o">=</span> <span class="n">cam_mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span>
        <span class="n">canvas_h</span> <span class="o">=</span> <span class="n">cam_mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;H&#39;</span><span class="p">]</span>
    <span class="n">canvas_size</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">canvas_h</span><span class="p">,</span> <span class="n">canvas_w</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">normal_canvas</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">normal_canvas</span> <span class="o">=</span> <span class="n">Canvas_view</span><span class="p">(</span><span class="n">fov</span><span class="p">,</span>
                                    <span class="n">verts</span><span class="p">,</span>
                                    <span class="n">faces</span><span class="p">,</span>
                                    <span class="n">colors</span><span class="p">,</span>
                                    <span class="n">canvas_size</span><span class="o">=</span><span class="n">canvas_size</span><span class="p">,</span>
                                    <span class="n">factor</span><span class="o">=</span><span class="n">init_factor</span><span class="p">,</span>
                                    <span class="n">bgcolor</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span>
                                    <span class="n">proj</span><span class="o">=</span><span class="s1">&#39;perspective&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">normal_canvas</span><span class="o">.</span><span class="n">reinit_mesh</span><span class="p">(</span><span class="n">verts</span><span class="p">,</span> <span class="n">faces</span><span class="p">,</span> <span class="n">colors</span><span class="p">)</span>
        <span class="n">normal_canvas</span><span class="o">.</span><span class="n">reinit_camera</span><span class="p">(</span><span class="n">fov</span><span class="p">)</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">normal_canvas</span><span class="o">.</span><span class="n">render</span><span class="p">()</span>
    <span class="n">backup_img</span><span class="p">,</span> <span class="n">backup_all_img</span><span class="p">,</span> <span class="n">all_img_wo_bound</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">img</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="o">*</span> <span class="mi">0</span><span class="p">,</span> <span class="n">img</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="o">*</span> <span class="mi">0</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">init_factor</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">init_factor</span><span class="p">)),</span> <span class="n">interpolation</span><span class="o">=</span><span class="n">cv2</span><span class="o">.</span><span class="n">INTER_AREA</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">border</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">border</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
    <span class="n">H</span><span class="p">,</span> <span class="n">W</span> <span class="o">=</span> <span class="n">cam_mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;H&#39;</span><span class="p">],</span> <span class="n">cam_mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">cam_mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;original_H&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">cam_mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;original_W&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">aspect_ratio</span> <span class="o">=</span> <span class="n">cam_mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;original_H&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">cam_mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;original_W&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">aspect_ratio</span> <span class="o">=</span> <span class="n">cam_mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;H&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">cam_mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">aspect_ratio</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">img_h_len</span> <span class="o">=</span> <span class="n">cam_mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;H&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">cam_mesh</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;original_H&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">cam_mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;original_H&#39;</span><span class="p">]</span>
        <span class="n">img_w_len</span> <span class="o">=</span> <span class="n">img_h_len</span> <span class="o">/</span> <span class="n">aspect_ratio</span>
        <span class="n">anchor</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span>
                  <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                  <span class="nb">int</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">int</span><span class="p">((</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">//</span><span class="mi">2</span> <span class="o">-</span> <span class="n">img_w_len</span><span class="o">//</span><span class="mi">2</span><span class="p">))),</span>
                  <span class="nb">int</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="nb">int</span><span class="p">((</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">//</span><span class="mi">2</span> <span class="o">+</span> <span class="n">img_w_len</span><span class="o">//</span><span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span><span class="p">))]</span>
    <span class="k">elif</span> <span class="n">aspect_ratio</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">img_w_len</span> <span class="o">=</span> <span class="n">cam_mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">cam_mesh</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;original_W&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">cam_mesh</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;original_W&#39;</span><span class="p">]</span>
        <span class="n">img_h_len</span> <span class="o">=</span> <span class="n">img_w_len</span> <span class="o">*</span> <span class="n">aspect_ratio</span>
        <span class="n">anchor</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">int</span><span class="p">((</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">//</span><span class="mi">2</span> <span class="o">-</span> <span class="n">img_h_len</span><span class="o">//</span><span class="mi">2</span><span class="p">))),</span>
                  <span class="nb">int</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="nb">int</span><span class="p">((</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">//</span><span class="mi">2</span> <span class="o">+</span> <span class="n">img_h_len</span><span class="o">//</span><span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span><span class="p">)),</span>
                  <span class="mi">0</span><span class="p">,</span>
                  <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
    <span class="n">anchor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">anchor</span><span class="p">)</span>
    <span class="n">plane_width</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tan</span><span class="p">(</span><span class="n">fov_in_rad</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">mean_loc_depth</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">video_pose</span><span class="p">,</span> <span class="n">video_traj_type</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">videos_poses</span><span class="p">,</span> <span class="n">video_traj_types</span><span class="p">):</span>
        <span class="n">stereos</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">tops</span> <span class="o">=</span> <span class="p">[];</span> <span class="n">buttoms</span> <span class="o">=</span> <span class="p">[];</span> <span class="n">lefts</span> <span class="o">=</span> <span class="p">[];</span> <span class="n">rights</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">tp_id</span><span class="p">,</span> <span class="n">tp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">video_pose</span><span class="p">):</span>
            <span class="n">rel_pose</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">ref_pose</span><span class="p">)))</span>
            <span class="n">axis</span><span class="p">,</span> <span class="n">angle</span> <span class="o">=</span> <span class="n">transforms3d</span><span class="o">.</span><span class="n">axangles</span><span class="o">.</span><span class="n">mat2axangle</span><span class="p">(</span><span class="n">rel_pose</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">])</span>
            <span class="n">normal_canvas</span><span class="o">.</span><span class="n">rotate</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">,</span> <span class="n">angle</span><span class="o">=</span><span class="p">(</span><span class="n">angle</span><span class="o">*</span><span class="mi">180</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
            <span class="n">normal_canvas</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="n">rel_pose</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">])</span>
            <span class="n">new_mean_loc_depth</span> <span class="o">=</span> <span class="n">mean_loc_depth</span> <span class="o">-</span> <span class="nb">float</span><span class="p">(</span><span class="n">rel_pose</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
            <span class="k">if</span> <span class="s1">&#39;dolly&#39;</span> <span class="ow">in</span> <span class="n">video_traj_type</span><span class="p">:</span>
                <span class="n">new_fov</span> <span class="o">=</span> <span class="nb">float</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">plane_width</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">new_mean_loc_depth</span><span class="p">)]))</span> <span class="o">*</span> <span class="mf">180.</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
                <span class="n">normal_canvas</span><span class="o">.</span><span class="n">reinit_camera</span><span class="p">(</span><span class="n">new_fov</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">normal_canvas</span><span class="o">.</span><span class="n">reinit_camera</span><span class="p">(</span><span class="n">fov</span><span class="p">)</span>
            <span class="n">normal_canvas</span><span class="o">.</span><span class="n">view_changed</span><span class="p">()</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">normal_canvas</span><span class="o">.</span><span class="n">render</span><span class="p">()</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">GaussianBlur</span><span class="p">(</span><span class="n">img</span><span class="p">,(</span><span class="nb">int</span><span class="p">(</span><span class="n">init_factor</span><span class="o">//</span><span class="mi">2</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">init_factor</span><span class="o">//</span><span class="mi">2</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)),</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">init_factor</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">init_factor</span><span class="p">)),</span> <span class="n">interpolation</span><span class="o">=</span><span class="n">cv2</span><span class="o">.</span><span class="n">INTER_AREA</span><span class="p">)</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="p">[</span><span class="n">anchor</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">anchor</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">anchor</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span><span class="n">anchor</span><span class="p">[</span><span class="mi">3</span><span class="p">]]</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">border</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span><span class="nb">int</span><span class="p">(</span><span class="n">border</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">border</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span><span class="nb">int</span><span class="p">(</span><span class="n">border</span><span class="p">[</span><span class="mi">3</span><span class="p">])]</span>

            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;crop_border&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">):</span>
                <span class="n">H_c</span><span class="p">,</span> <span class="n">W_c</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span>
                <span class="n">o_t</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">H_c</span> <span class="o">*</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;crop_border&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">o_l</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">W_c</span> <span class="o">*</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;crop_border&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">o_b</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">H_c</span> <span class="o">*</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;crop_border&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">])</span>
                <span class="n">o_r</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">W_c</span> <span class="o">*</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;crop_border&#39;</span><span class="p">][</span><span class="mi">3</span><span class="p">])</span>
                <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="p">[</span><span class="n">o_t</span><span class="p">:</span><span class="n">H_c</span><span class="o">-</span><span class="n">o_b</span><span class="p">,</span> <span class="n">o_l</span><span class="p">:</span><span class="n">W_c</span><span class="o">-</span><span class="n">o_r</span><span class="p">]</span>
                <span class="n">img</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="p">(</span><span class="n">W_c</span><span class="p">,</span> <span class="n">H_c</span><span class="p">),</span> <span class="n">interpolation</span><span class="o">=</span><span class="n">cv2</span><span class="o">.</span><span class="n">INTER_CUBIC</span><span class="p">)</span>

            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            img = cv2.resize(img, (int(img.shape[1] / init_factor), int(img.shape[0] / init_factor)), interpolation=cv2.INTER_CUBIC)</span>
<span class="sd">            img = img[anchor[0]:anchor[1], anchor[2]:anchor[3]]</span>
<span class="sd">            img = img[int(border[0]):int(border[1]), int(border[2]):int(border[3])]</span>
<span class="sd">            if config[&#39;crop_border&#39;] is True:</span>
<span class="sd">                top, buttom, left, right = find_largest_rect(img, bg_color=(128, 128, 128))</span>
<span class="sd">                tops.append(top); buttoms.append(buttom); lefts.append(left); rights.append(right)</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">stereos</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">img</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="p">:</span><span class="mi">3</span><span class="p">])</span>
            <span class="n">normal_canvas</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="o">-</span><span class="n">rel_pose</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">])</span>
            <span class="n">normal_canvas</span><span class="o">.</span><span class="n">rotate</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">,</span> <span class="n">angle</span><span class="o">=-</span><span class="p">(</span><span class="n">angle</span><span class="o">*</span><span class="mi">180</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
            <span class="n">normal_canvas</span><span class="o">.</span><span class="n">view_changed</span><span class="p">()</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        if config[&#39;crop_border&#39;] is True:</span>
<span class="sd">            atop, abuttom = min(max(tops), img.shape[0]//2 - 10), max(min(buttoms), img.shape[0]//2 + 10)</span>
<span class="sd">            aleft, aright = min(max(lefts), img.shape[1]//2 - 10), max(min(rights), img.shape[1]//2 + 10)</span>
<span class="sd">            atop -= atop % 2; abuttom -= abuttom % 2; aleft -= aleft % 2; aright -= aright % 2</span>
<span class="sd">        else:</span>
<span class="sd">            atop = 0; abuttom = img.shape[0] - img.shape[0] % 2; aleft = 0; aright = img.shape[1] - img.shape[1] % 2</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">atop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">abuttom</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">%</span> <span class="mi">2</span><span class="p">;</span> <span class="n">aleft</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">aright</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">%</span> <span class="mi">2</span>
        <span class="n">crop_stereos</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">stereo</span> <span class="ow">in</span> <span class="n">stereos</span><span class="p">:</span>
            <span class="n">crop_stereos</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">stereo</span><span class="p">[</span><span class="n">atop</span><span class="p">:</span><span class="n">abuttom</span><span class="p">,</span> <span class="n">aleft</span><span class="p">:</span><span class="n">aright</span><span class="p">,</span> <span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">*</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">))</span>
            <span class="n">stereos</span> <span class="o">=</span> <span class="n">crop_stereos</span>
        <span class="n">clip</span> <span class="o">=</span> <span class="n">ImageSequenceClip</span><span class="p">(</span><span class="n">stereos</span><span class="p">,</span> <span class="n">fps</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;fps&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">video_basename</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">video_basename</span> <span class="o">=</span> <span class="n">video_basename</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">clip</span><span class="o">.</span><span class="n">write_videofile</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">video_basename</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">video_traj_type</span> <span class="o">+</span> <span class="s1">&#39;.mp4&#39;</span><span class="p">),</span> <span class="n">fps</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;fps&#39;</span><span class="p">])</span>



    <span class="k">return</span> <span class="n">normal_canvas</span><span class="p">,</span> <span class="n">all_canvas</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

</div>
 

